<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0 maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
    charset="utf-8">

  <title>Challenger Heater WiFi Control Interface</title>

  <style>
    /***********************************************
         Included from style.css
      ***********************************************/
    body {
      font-size: 62.5%;
      font-family: Verdana, Helvetica, Arial, sans-serif;
      background-color: rgb(255, 255, 255);
      /* overflow: hidden; */
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    select {
      width: 100%;
      /* padding: 16px 20px; */
      border: none;
      border-radius: 1em;
      background-color: #f1f1f1;
      font-size: 20px;
      height: 3em;
    }

    .wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: auto;
      grid-column-gap: 50px;
      align-items: center;
      padding: 10px;
    }

    .containerGrid {
      grid-template-columns: 0.5fr 2fr 6fr 0.5fr 2fr 6fr 0.5fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      align-items: center;
      padding-top: 1em;
    }

    .itemT {
      grid-column-start: 2;
      grid-column-end: 7;
      grid-row-start: 1;
      justify-self: center;
    }

    .itemR1L {
      /*whole left side*/
      grid-column-start: 1;
      grid-column-end: 4;
      grid-row-start: 2;
      justify-self: center;
    }

    .itemR1R {
      /*whole right side*/
      grid-column-start: 5;
      grid-column-end: 7;
      grid-row-start: 2;
      justify-self: center;
    }

    .itemR1L1 {
      grid-column-start: 2;
      grid-row-start: 2;
      justify-self: end;
    }

    .itemR1C1 {
      grid-column-start: 3;
      grid-row-start: 2;
      justify-self: end;
    }

    .itemR1L2 {
      grid-column-start: 5;
      grid-row-start: 2;
      justify-self: end;
    }

    .itemR1C2 {
      grid-column-start: 6;
      grid-row-start: 2;
      justify-self: end;
    }

    .itemR2L1 {
      grid-column-start: 2;
      grid-row-start: 3;
      justify-self: end;
    }

    .itemR2C1 {
      grid-column-start: 3;
      grid-row-start: 3;
      justify-self: end;
    }

    .itemR2L2 {
      grid-column-start: 5;
      grid-row-start: 3;
      justify-self: end;
    }

    .itemR2C2 {
      grid-column-start: 6;
      grid-row-start: 3;
      justify-self: end;
    }

    .itemR3L1 {
      grid-column-start: 2;
      grid-row-start: 4;
      justify-self: end;
    }

    .itemR3C1 {
      grid-column-start: 3;
      grid-row-start: 4;
      justify-self: end;
    }

    .itemR3L2 {
      grid-column-start: 5;
      grid-row-start: 4;
      justify-self: end;
    }

    .itemR3C2 {
      grid-column-start: 6;
      grid-row-start: 4;
      justify-self: end;
    }

    .itemR4L1 {
      grid-column-start: 2;
      grid-row-start: 5;
      justify-self: end;
    }

    .itemR4C1 {
      grid-column-start: 3;
      grid-row-start: 5;
      justify-self: end;
    }

    .itemR4C1L {
      grid-column-start: 3;
      grid-row-start: 5;
      justify-self: start;
    }


    .itemR4L2 {
      grid-column-start: 5;
      grid-row-start: 5;
      justify-self: end;
    }

    .itemR4L2L {
      grid-column-start: 5;
      grid-row-start: 5;
      justify-self: start;
    }

    .itemR4C2 {
      grid-column-start: 6;
      grid-row-start: 5;
      justify-self: end;
    }

    .itemR5L1 {
      grid-column-start: 2;
      grid-row-start: 6;
      justify-self: end;
    }

    .itemR5C1 {
      grid-column: 3;
      grid-row-start: 6;
      justify-self: stretch;
    }

    .itemR5C2 {
      grid-column: 4;
      grid-row-start: 6;
      justify-self: stretch;
    }

    .itemR5C3 {
      grid-column: 5;
      grid-row-start: 6;
      justify-self: stretch;
    }


    .itemFOOTER {
      grid-column-start: 2;
      grid-column-end: 7;
      grid-row-start: 10;
      /* at the bottom of the grid */
      justify-self: center;
    }

    div.infront {
      z-index: 10;
      display: block;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 255, 0.5);
    }

    div.solidback {
      position: absolute;
      padding: 1em;
      height: 13em;
      width: 26em;
      top: 15em;
      left: 30em;
      background-color: rgb(255, 255, 255);
      border-style: solid;
      border-width: 0.3em;
      border-color: black;
      border-radius: 1em;
    }

    div.redinfront {
      background-color: rgb(212, 77, 77);
      border-color: red;
    }

    @media screen and (orientation:portrait) {

      /**        @media screen and (max-width:600px) {**/
      /*Portrait*/
      .wrapper {
        grid-template-columns: 1fr;
        /*1 vertical column */
        grid-gap: 0px;
        /* no gap between elements */
      }

      .containerGrid {
        grid-template-columns: 1fr 5fr 10fr 1fr;
      }

      .itemT {
        grid-column-start: 2;
        grid-column-end: 5;
        grid-row-start: 1;
        justify-self: center;
      }

      .itemR1L {
        /*whole left side row 1 becomes whole of R2 when <600px */
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 2;
        justify-self: center;
      }

      .itemR1R {
        /*whole right side row 1 becomes whole of R3 when <600px */
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 3;
        justify-self: center;
      }

      .itemR1L1 {
        grid-column-start: 2;
        grid-row-start: 2;
        justify-self: end;
      }

      .itemR1C1 {
        grid-column-start: 3;
        grid-row-start: 2;
        justify-self: end;
      }

      .itemR1L2 {
        grid-column-start: 2;
        grid-row-start: 3;
        justify-self: end;
      }

      .itemR1C2 {
        grid-column-start: 3;
        grid-row-start: 3;
        justify-self: end;
      }

      .itemR2L1 {
        grid-column-start: 2;
        grid-row-start: 4;
        justify-self: end;
      }

      .itemR2C1 {
        grid-column-start: 3;
        grid-row-start: 4;
        justify-self: end;
      }

      .itemR2L2 {
        grid-column-start: 2;
        grid-row-start: 5;
        justify-self: end;
      }

      .itemR2C2 {
        grid-column-start: 3;
        grid-row-start: 5;
        justify-self: end;
      }

      .itemR3L1 {
        grid-column-start: 2;
        grid-row-start: 6;
        justify-self: end;
      }

      .itemR3C1 {
        grid-column-start: 3;
        grid-row-start: 6;
        justify-self: end;
      }

      .itemR3L2 {
        grid-column-start: 2;
        grid-row-start: 7;
        justify-self: end;
      }

      .itemR3C2 {
        grid-column-start: 3;
        grid-row-start: 7;
        justify-self: end;
      }

      .itemR4L1 {
        grid-column-start: 2;
        grid-row-start: 8;
        justify-self: end;
      }

      .itemR4C1 {
        grid-column-start: 3;
        grid-row-start: 8;
        justify-self: end;
      }

      .itemR4C1L {
        grid-column-start: 3;
        grid-row-start: 8;
        justify-self: start;
      }

      .itemR4L2 {
        grid-column-start: 2;
        grid-row-start: 9;
        justify-self: end;
      }

      .itemR4L2L {
        grid-column-start: 2;
        grid-row-start: 9;
        justify-self: start;
      }

      .itemR4C2 {
        grid-column-start: 3;
        grid-row-start: 9;
        justify-self: end;
      }

      /* group for cyclic mode */
      .CyclicGrp {
        grid-column: 2;
        grid-row: 3;
        display: grid;
        grid-template-columns: [cycliclbl] 2fr [cyclicset] 4fr;
        grid-column-gap: 1em;
        grid-row-gap: 0.5em;
        grid-auto-rows: auto;
      }

      .cyclictitle {
        padding-top: 20px;
      }

      .itemR5L1 {
        grid-column-start: 2;
        grid-row-start: 10;
        justify-self: end;
      }

      .itemR5C1 {
        grid-column-start: 3;
        grid-row-start: 10;
        justify-self: end;
      }

      .itemR5C2 {
        grid-column-start: 3;
        grid-row-start: 11;
        justify-self: end;
      }

      .itemR5C3 {
        grid-column-start: 3;
        grid-row-start: 12;
        justify-self: end;
      }

      .itemFOOTER {
        grid-column-start: 2;
        grid-column-end: 5;
        grid-row-start: 10;
        /* at the bottom of the grid */
        justify-self: center;
      }

      div.solidback {
        left: 9em;
      }
    }

    .wrapper2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: auto;
      grid-gap: 10px;
      align-items: center;
      text-align: right;
    }

    * {
      box-sizing: border-box;
    }

    /*.wrapper {
        border: 2px solid #f76707;
        border-radius: 5px;
        background-color: #fff4e6;
      }*/

    .wrapper>div {
      text-align: center;
    }
    .wrapper1>div{
      text-align: center;
    }

    div.linearbox {
      display: inline-block;
      text-align: right;
      vertical-align: middle;
    }

    div.box {
      display: inline-block;
      vertical-align: top;
    }

    div.outsidePage {
      text-align: center;
      height: 100%;
      width: 100%;
    }

    .leftcolumnbox {
      display: inline-block;
      font-size: 1em;
      text-align: left;
      vertical-align: middle;
      padding: 0;
      margin: 0;
    }

    .columngroup {
      display: inline-block;
      width: 6em;
      background-color: yellow;
      text-align: right;
      vertical-align: middle;
    }

    .headingblock {
      display: block;
      text-align: center;
    }

    .rightcolumnbox {
      display: inline-block;
      text-align: center;
      vertical-align: middle;
      padding-right: 0px;
    }

    .full-height {
      height: 100%;
      background-color: red;
    }

    .select {
      border-radius: 1em;
      /* padding: .6em .5em .5em .8em; */
      width: 100%;
      max-width: 100%;
      border: 2px solid #000;
    }

    .select.lblsmlright {
      font-size: 1em;
      text-align: center;
    }

    h2,
    h3 {
      margin: 0px;
    }

    h2 {
      padding: 0px;
    }

    h3 {
      padding: 0px 0px 10px;
      /*top 0, left & right 0, bottom 20px */
    }

    .inline {
      display: inline-block;
    }

    .divNoGaugeJS {
      display: none;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 5%;
      background-color: rgb(0, 255, 0);
      border: 10px solid red;
    }

    .btn-floatright {
      float: right;
    }

    .btn-base {
      height: 2em;
      color: black;
      background: rgb(240, 240, 240);
      border: 2px solid;
      border-radius: 1em;
      outline: none;
      text-align: center;
      padding: 0px;
      line-height: 0px;
    }

    .btn-base2 {
      height: 3em;
      font-size: 0.8em;
      background: rgb(240, 240, 240);
      border: 2px solid;
      border-radius: 1.5em;
      outline: none;
      text-align: center;
      padding: 0px;
      line-height: 0px;
    }

    .btn-base05 {
      height: 1em;
      color: black;
      background: rgb(240, 240, 240);
      border: 2px solid;
      border-radius: 0.5em;
      outline: none;
      text-align: center;
      padding: 0px;
      line-height: 0px;
    }

    .btn-1col {
      width: 7em;
      font-size: 2em;
    }

    .btn-1colC {
      width: 7em;
      font-size: 2em;
    }

    .btn-2col {
      width: 7em;
      font-size: 1.5em;
    }

    .btn-3col {
      width: 4.6em;
      font-size: 1.5em;
    }

    .btn-4col {
      width: 3em;
      font-size: 3em;
    }

    .btn-small {
      width: 15em;
      height: 1.5em;
      font-size: 0.5em;
    }

    .btn-txt {
      font-size: 2.5em;
    }

    .btn-mini {
      width: 60px;
      height: 30px;
      font-size: 12px;
      color: black;
      background: rgb(240, 240, 240);
      border: 2px solid;
      border-radius: 28px;
      outline: none;
      text-align: center;
      padding: 0px;
      line-height: 0px;
    }

    .padbottom {
      margin-bottom: 0.2em;
    }

    .throb_me {
      color: red;
      height: 3vw;
      font-size: 2vw;
      font-weight: bold;
      animation: throbber 1s infinite;
    }

    @keyframes throbber {
      50% {
        opacity: 0;
      }
    }

    .topnav {
      overflow: hidden;
      background-color: black;
      position: relative;
      width: 100%;
      text-align: center;
    }

    .topnav #myLinks {
      /*drop down list*/
      display: none;
      background-color: rgba(0, 0, 0, 0.8);
      /* black but slightly transparent*/
    }

    .topnav a {
      color: white;
      padding: 0.2em 0.4em;
      text-decoration: none;
      font-size: 2em;
      display: block;
    }

    .redtext {
      color: red;
    }

    .whitetext {
      color: white;
    }

    .topnav a.icon {
      display: block;
      position: absolute;
      left: 0;
      top: 0;
      background-color: rgba(255, 0, 0, 0);
      /*transparent - on some devices the icon background was showing bigger than the titlebar */
    }

    .topnav a:hover {
      background-color: black;
      color: yellow;
    }

    #ThermostatPage,
    #EnvironmentalPage,
    #FuelMixtureSettingsPage,
    #DateTimeSettingsPage,
    #SystemSettingsPage,
    #SystemFunctionsPage,
    #SystemDetailsPage,
    #CommsSettingsPage,
    #HelpPage {
      display: none;
    }

    /*div.box {
        background-color: rgba(255, 255, 255, 0);
        display: inline-block;
        float: left;
        width: 600px;
        text-align: center;
      }*/



    /*.leftcolumnbox {
        display: inline-block;
        width: 195px;
        text-align: right;
        vertical-align: middle;
        padding-bottom: 12px;
        padding-top: 0px;
      }
      
      .rightcolumnbox {
        display: inline-block;
        width: 375px;
        padding: 10px 0px;
        text-align: center;
        vertical-align: middle;
        padding-right: 15px;
      } */

    .smallbottompad {
      margin-bottom: -15px;
    }

    .border {
      border-style: solid;
    }

    .center {
      text-align: center;
    }

    div.lblleft {
      font-size: 2em;
      text-align: left;
    }

    input.lblleft {
      font-size: 1em;
      text-align: left;
    }

    div.lblsmlleft {
      font-size: 1.5em;
      text-align: left;
      float: left;
    }

    div.lblminileft {
      font-size: 1.25em;
      text-align: left;
      float: left;
    }

    div.lblsmlright {
      font-size: 1.5em;
      text-align: right;
    }

    div.lblminiright {
      font-size: 0.8em;
      text-align: right;
    }

    input.lblsmlright {
      font-size: 0.6em;
      text-align: right;
    }

    input.lblsmlleft {
      font-size: 0.6em;
      text-align: left;
    }

    input.lblminileft {
      font-size: 1.25em;
      text-align: left;
      float: left;
    }

    div.floatLeft {
      float: left;
    }

    div.displaynone {
      display: none;
    }

    .containerb {
      position: fixed;
      z-index: -95;
    }
  </style>

  <style>
    /***********************************************
         Included from keyboard.css
      ***********************************************/
    div.solidbackkeyboard {
      background-color: rgb(255, 255, 196);
      border-style: solid;
      border-width: 0.1em;
      border-color: black;
      border-radius: 1em;
      text-align: center;
    }

    .keyboardGrid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-auto-rows: auto;
      grid-column-gap: 0.1em;
      grid-row-gap: 0.1em;
      background-color: rgb(255, 255, 196);
      margin: 4em auto;
      /*auto centres horizontally*/

      padding: 0.5em;
      width: 10em;

      border-style: solid;
      border-width: 0.1em;
      border-color: black;
      border-radius: 1em;

      font-size: 4em;
      /* this is changed depending on screen size to fit keyboard to screen */
    }

    .keyButton1,
    .keyButton2,
    .keyButton3 {
      width: 100%;
      font-size: 1em;
      background-color: rgba(0, 255, 0, .7);
      color: black;
      border: 0.1em solid;
      border-radius: 0.5em;
    }

    .keyButton1 {
      background-color: lightgreen;
    }

    .keyButton2 {
      background-color: lightblue;
    }

    .keyButton3 {
      background-color: red;
      color: white;
    }

    .itemKeyTitle {
      grid-column-start: 1;
      grid-column-end: 4;
      grid-row-start: 1;
      font-size: 1em;
    }



    .itemKeyConstraints {
      grid-column-start: 1;
      grid-column-end: 4;
      grid-row-start: 2;
      font-size: 1em;
    }

    .itemKeyEntry {
      grid-column-start: 1;
      grid-column-end: 3;
      grid-row-start: 3;
    }

    .itemKeyClose {
      grid-column-start: 3;
      grid-row-start: 3;
    }

    .itemKey1 {
      grid-column-start: 1;
      grid-row-start: 4;
    }

    .itemKey2 {
      grid-column-start: 2;
      grid-row-start: 4;
    }

    .itemKey3 {
      grid-column-start: 3;
      grid-row-start: 4;
    }

    .itemKey4 {
      grid-column-start: 1;
      grid-row-start: 5;
    }

    .itemKey5 {
      grid-column-start: 2;
      grid-row-start: 5;
    }

    .itemKey6 {
      grid-column-start: 3;
      grid-row-start: 5;
    }

    .itemKey7 {
      grid-column-start: 1;
      grid-row-start: 6;
    }

    .itemKey8 {
      grid-column-start: 2;
      grid-row-start: 6;
    }

    .itemKey9 {
      grid-column-start: 3;
      grid-row-start: 6;
    }

    .itemKey0 {
      grid-column-start: 2;
      grid-row-start: 7;
    }

    .itemKeyDecimalButton {
      grid-column-start: 1;
      grid-row-start: 7;
    }

    .itemKeyClear {
      grid-column-start: 3;
      grid-row-start: 7;
    }

    .itemKeyApply {
      grid-column-start: 1;
      grid-column-end: 4;
      grid-row-start: 8;
    }
  </style>

  <style>
    /***********************************************
         Included from GPIO.css
      ***********************************************/
    .GPIOGrp {
      display: grid;
      grid-template-columns: [label] 2fr [state] 1fr [control] 1fr;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      grid-auto-rows: auto;
      align-items: center;
    }

    .GPIOtitle {
      grid-column: 1 / 4;
      grid-row: 1;
      justify-self: stretch;
      text-align: center;
      font-size: 1.3em;
    }

    .GPin1L {
      grid-column: label;
      grid-row: 2;
      font-size: 1.3em;
      text-align: right;
    }

    .GPin1C {
      grid-column: control;
      grid-row: 2;
      font-size: 1.3em;
      text-align: right;
    }

    .GPin1S {
      grid-column: state;
      grid-row: 2;
      font-size: 1.3em;
      text-align: right;
    }

    .GPin2L {
      grid-column: label;
      grid-row: 3;
      font-size: 1.3em;
      text-align: right;
    }

    .GPin2C {
      grid-column: control;
      grid-row: 3;
      font-size: 1.3em;
      text-align: right;
    }

    .GPin2S {
      grid-column: state;
      grid-row: 3;
      font-size: 1.3em;
      text-align: right;
    }

    .GPout1L {
      grid-column: label;
      grid-row: 4;
      font-size: 1.3em;
      text-align: right;
    }

    .GPout1C {
      grid-column: control;
      grid-row: 4;
      font-size: 1.3em;
      text-align: right;
    }

    .GPout1S {
      grid-column: state;
      grid-row: 4;
      font-size: 1.3em;
      text-align: right;
    }

    .GPout2L {
      grid-column: label;
      grid-row: 5;
      font-size: 1.3em;
      text-align: right;
    }

    .GPout2C {
      grid-column: control;
      grid-row: 5;
      font-size: 1.3em;
      text-align: right;
    }

    .GPout2S {
      grid-column: state;
      grid-row: 5;
      font-size: 1.3em;
      text-align: right;
    }

    .GPalgL {
      grid-column: label;
      grid-row: 6;
      font-size: 1.3em;
      text-align: right;
    }

    .GPalgS {
      grid-column: state;
      grid-row: 6;
      font-size: 1.3em;
      text-align: right;
    }


    #switch1,
    #switch2 {
      grid-column: 2;
      position: relative;
    }

    #switch1 {
      grid-row: 2;
    }

    #switch2 {
      grid-row: 3;
    }

    .swcanvas1 {
      height: 100%;
      width: 100%;
    }

    .swcanvas2 {
      height: 100%;
      width: 100%;
    }
  </style>

  <style>
    /***********************************************
         Included from comms.css
      ***********************************************/
    .commsGrid {
      grid-template-columns: 0.5fr 3fr 6fr 0.5fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      align-items: center;
      padding-top: 1em;
      font-size: 1em;
    }

    .commT1 {
      grid-column-start: 3;
      grid-row-start: 1;
      justify-self: stretch;
      font-weight: bold;
      text-align: left;
    }

    .commR1L {
      grid-column: 2;
      grid-row: 2;
      justify-self: end;
    }

    .commR1C {
      grid-column: 3;
      grid-row: 2;
      justify-self: start;
    }

    .commR2L {
      grid-column: 2;
      grid-row: 3;
      justify-self: end;
    }

    .commR2C {
      grid-column: 3;
      grid-row: 3;
      justify-self: start;
    }

    .commT2 {
      grid-column: 3;
      grid-row: 4;
      justify-self: stretch;
      padding-top: 0.5em;
      font-weight: bold;
      text-align: left;
    }

    .commABL1 {
      grid-column: 2;
      grid-row: 5;
      justify-self: stretch;
      text-align: right;
    }

    .commABC1 {
      grid-column: 3;
      grid-row: 5;
      justify-self: start;
      text-align: center;
    }

    .commABL2 {
      grid-column: 2;
      grid-row: 6;
      justify-self: stretch;
      text-align: right;
    }

    .commABC2 {
      grid-column: 3;
      grid-row: 6;
      justify-self: start;
    }

    .commABL3 {
      grid-column: 2;
      grid-row: 7;
      justify-self: stretch;
      text-align: right;
    }

    .commABC3 {
      grid-column: 3;
      grid-row: 7;
      justify-self: start;
    }

    .commABL4 {
      grid-column: 2;
      grid-row: 8;
      justify-self: stretch;
      text-align: right;
    }

    .commABC4 {
      grid-column: 3;
      grid-row: 8;
      justify-self: start;
    }

    .commT3 {
      grid-column: 3;
      grid-row: 9;
      justify-self: stretch;
      padding-top: 1em;
      font-weight: bold;
      text-align: left;
    }

    .commMCL1 {
      grid-column: 2;
      grid-row: 10;
      justify-self: stretch;
      text-align: right;
    }

    .commMCC1 {
      grid-column: 3;
      grid-row: 10;
      justify-self: start;
    }

    .commMCL2 {
      grid-column: 2;
      grid-row: 11;
      justify-self: stretch;
      text-align: right;
    }

    .commMCC2 {
      grid-column: 3;
      grid-row: 11;
      justify-self: start;
    }

    .commMCL3 {
      grid-column: 2;
      grid-row: 12;
      justify-self: stretch;
      text-align: right;
    }

    .commMCC3 {
      grid-column: 3;
      grid-row: 12;
      justify-self: start;
    }
  </style>

  <style>
    /***********************************************
         Included from timers.css
      ***********************************************/
    .btn-day {
      width: 3.5em;
      font-size: 1em;
      text-align: center;
      float: left;
    }

    .btn-red {
      background: red;
    }

    .btn-tmr2col {
      width: 9em;
      font-size: 1.5em;
    }


    .timerGrid {
      grid-template-columns: 0.5fr 1.5fr 1.5fr 1.5fr 1.5fr 1.5fr 1.5fr 1.5fr 1.5fr 0.5fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      /* grid-row-gap: 0.5em; */
      align-items: center;
      /* padding-top: 1em; */
      display: grid;
    }

    .timeGrp {
      grid-column: 2/ 10;
      grid-row: 1;
      grid-template-columns: 1.5fr 2.5fr 1fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      align-items: center;
      display: grid;
    }

    .tmrT {
      grid-column: 1 / 4;
      grid-row: 1;
      justify-self: stretch;
    }

    .tmrLblLocal {
      grid-column: 1;
      grid-row: 2;
      justify-self: end;
    }

    .tmrLocal {
      grid-column: 2;
      grid-row: 2;
      justify-self: center;
    }

    .tmrLblAB {
      grid-column: 1;
      grid-row: 3;
      justify-self: end;
    }

    .tmrAB {
      grid-column: 2;
      grid-row: 3;
      justify-self: center;
    }

    .tmrSetClock {
      grid-column: 3;
      grid-row: 3;
      justify-self: start;
    }

    /* #tmrCanvas {
        height: 320px;
        width: 580px;
      } */

    .tmrSettingsGrp {
      grid-row: 2;
      grid-column: 2 / 10;
      display: grid;
      grid-template-columns: 1.5fr 3.5fr 1.5fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      align-items: center;
      padding-top: 1em;
      padding-bottom: 1em;
    }

    .tmrT2 {
      grid-column: 1 / 4;
      grid-row: 1;
      justify-self: stretch;
      padding-bottom: 1em;
    }

    .tmrDaysGrp {
      grid-row: 2;
      grid-column: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      align-items: center;
    }

    .tmrDays {
      grid-column: 1;
      justify-self: center;
    }

    .tmrSun {
      grid-row: 1;
    }

    .tmrMon {
      grid-row: 2;
    }

    .tmrTue {
      grid-row: 3;
    }

    .tmrWed {
      grid-row: 4;
    }

    .tmrThu {
      grid-row: 5;
    }

    .tmrFri {
      grid-row: 6;
    }

    .tmrSat {
      grid-row: 7;
    }

    .tmrNext {
      grid-column: 2;
      grid-row: 1;
      justify-self: center;
    }

    .tmrNone {
      grid-column: 2;
      grid-row: 3;
      justify-self: center;
    }

    .tmrPickerGrp {
      grid-row: 2;
      grid-column: 2;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      align-items: center;
    }

    .tmrStart {
      grid-column: 1;
      grid-row: 1;
      justify-self: center;
    }

    .tmrStop {
      grid-column: 2;
      grid-row: 1;
      justify-self: center;
    }

    .tmrOptionsGrp {
      grid-row: 2;
      grid-column: 3;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      align-items: center;
    }

    .tmrSelect {
      grid-column: 1 / 3;
      grid-row: 1/3;
      grid-row-gap: 1.5em;
      justify-self: center;
      align-self: start;
      height: 4em;
      /* padding-bottom: 2em;  */
    }

    .tmrTemp {
      grid-column: 1 / 3;
      grid-row: 4;
      justify-self: center;
    }

    .tmrTempDn {
      grid-column: 1;
      grid-row: 5;
      justify-self: end;
      padding-bottom: 1em;
    }

    .tmrTempUp {
      grid-column: 2;
      grid-row: 5;
      justify-self: start;
      padding-bottom: 1em;
    }

    .tmrRepeat {
      grid-column: 1 / 3;
      grid-row: 6;
      justify-self: center;
      padding-bottom: 1em;
    }

    .tmrSet {
      grid-column: 1 / 3;
      grid-row: 7;
      justify-self: center
    }

    .tmrChart {
      grid-column: 2 / 10;
      grid-row: 6;
      justify-self: center;
    }

    .select.lblsmlleft {
      font-size: 1em;
      text-align: left;
    }



    @media screen and (orientation:portrait) {

      /**        @media screen and (max-width:600px) {**/
      /*Portrait*/
      .wrapper {
        grid-template-columns: 1fr;
        /*1 vertical column */
        grid-gap: 0px;
        /* no gap between elements */
      }

      .tmrSettingsGrp {
        grid-row: 2;
        grid-column: 2 / 10;
        display: grid;
        grid-template-columns: 1fr;
        grid-auto-rows: auto;
        grid-column-gap: 1em;
        align-items: center;
        padding-bottom: 1em;
      }

      .tmrPickerGrp {
        grid-row: 2;
        grid-column: 1;
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-auto-rows: auto;
        grid-column-gap: 1em;
        grid-row-gap: 0.5em;
        align-items: center;
      }

      .tmrDaysGrp {
        grid-row: 4;
        grid-column: 1;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
        grid-auto-rows: auto;
        grid-column-gap: 0.5em;
        grid-row-gap: 0.5em;
        align-items: center;
      }

      .tmrDays {
        grid-row: 2;
        justify-self: center;
      }

      .tmrSun {
        grid-column: 1;
      }

      .tmrMon {
        grid-column: 2;
      }

      .tmrTue {
        grid-column: 3;
      }

      .tmrWed {
        grid-column: 4;
      }

      .tmrThu {
        grid-column: 5;
      }

      .tmrFri {
        grid-column: 6;
      }

      .tmrSat {
        grid-column: 7;
      }

      .tmrNext {
        grid-column: 1;
        grid-row: 1;
        justify-self: center;
      }

      .tmrNone {
        grid-column: 2/4;
        grid-row: 1;
        justify-self: center;
      }

      .tmrRepeat {
        grid-column: 2;
        grid-row: 2;
        justify-self: center;
      }

      .tmrOptionsGrp {
        grid-row: 3;
        grid-column: 1;
        display: grid;
        grid-template-columns: 1.5fr 2fr 0.8fr 0.8fr;
        grid-auto-rows: auto;
        grid-column-gap: 1em;
        grid-row-gap: 0.5em;
        align-items: center;
      }

      .tmrSelect {
        grid-column: 1;
        grid-row: 1;
        justify-self: center;
        vertical-align: top;
        height: 3em;
      }

      .tmrSet {
        grid-column: 2;
        grid-row: 1;
        justify-self: center;
      }

      .tmrTemp {
        grid-column: 3 / 5;
        grid-row: 1;
        justify-self: center;
      }

      .tmrTempDn {
        grid-column: 3;
        grid-row: 2;
        justify-self: end;
      }

      .tmrTempUp {
        grid-column: 4;
        grid-row: 2;
        justify-self: start;
      }

      /* #tmrCanvas {
            height: 160px;
            width: 290px;
          }
           */

      .tmrChart {
        grid-column: 2/10;
        grid-row: 10;
        justify-self: center;
        padding-top: 1em;
      }

      .btn-repeat {
        width: 5em;
        align-self: center;
      }
    }
  </style>

  <style>
    /***********************************************
         Included from thermostat.css
      ***********************************************/

    .thermoGrid {
      grid-template-columns: 0.5fr 8fr 8fr 0.5fr;
      grid-auto-rows: auto;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      align-items: start;
      padding-top: 1em;
    }

    .thermoT {
      grid-column: 2/6;
      grid-row: 1;
      justify-self: stretch;
      text-align: center;
    }

    .ThermoGrp {
      grid-column: 2;
      grid-row: 2;
      display: grid;
      grid-template-columns: [thermolbl] 2fr [thermoset] 6fr;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      grid-auto-rows: auto;
      align-items: center;
    }

    .thermotitle {
      grid-column: 1/3;
      grid-row: 1;
      justify-self: stretch;
      text-align: center;
      font-size: 1.5em;
    }

    .thermoset {
      grid-column: thermoset;
      grid-row: 2;
      justify-self: start;
    }

    .thermotitle2 {
      grid-column: 2;
      grid-row: 3;
      justify-self: start;
    }

    .thermolbl2 {
      grid-column: thermolbl;
      grid-row: 4;
      font-size: 1.2em;
      text-align: right;
    }

    .thermoset2 {
      grid-column: thermoset;
      grid-row: 4;
      justify-self: start;
    }

    .thermolbl3 {
      grid-column: thermolbl;
      grid-row: 5;
      font-size: 1.2em;
      text-align: right;
    }

    .thermoset3 {
      grid-column: thermoset;
      grid-row: 5;
      justify-self: start;
    }

    .ThermoUpdateGrp {
      grid-column: 2/4;
      grid-row: 3;
      padding-top: 10px;
      justify-self: center;
    }

    .CyclicFrostGrp {
      grid-column: 3;
      grid-row: 2;
      display: grid;
      grid-template-columns: 2fr 6fr;
      grid-row-gap: 0.5em;
      grid-auto-rows: auto;
      align-items: center;
    }

    /* group for cyclic mode */
    .CyclicGrp {
      grid-column: 1/3;
      grid-row: 1;
      display: grid;
      grid-template-columns: [cycliclbl] 2fr [cyclicset] 6fr;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      grid-auto-rows: auto;
      align-items: center;
    }

    .cyclictitle {
      grid-column: 1 / 3;
      grid-row: 1;
      justify-self: stretch;
      text-align: center;
      font-size: 1.5em;
    }

    .cycliclbl1 {
      grid-column: cycliclbl;
      grid-row: 2;
      font-size: 1.2em;
      text-align: right;
    }

    .cycliclbl2 {
      grid-column: cycliclbl;
      grid-row: 3;
      font-size: 1.2em;
      text-align: right;
    }

    .cycliclbl3 {
      grid-column: cycliclbl;
      grid-row: 4;
      font-size: 1.2em;
      text-align: right;
    }

    .cyclicset1 {
      grid-column: cyclicset;
      grid-row: 2;
      justify-self: start;
    }

    .cyclicset2 {
      grid-column: cyclicset;
      grid-row: 3;
      justify-self: start;
    }

    .cyclicset3 {
      grid-column: cyclicset;
      grid-row: 4;
      justify-self: start;
    }

    .cyclicset4 {
      grid-column: cyclicset;
      grid-row: 5;
      justify-self: start;
    }

    .cyclicset5 {
      grid-column: cyclicset;
      grid-row: 6;
      justify-self: start;
      padding-top: 20px;
    }

    /* group for frost mode */
    .FrostGrp {
      grid-column: 1/3;
      grid-row: 2;
      display: grid;
      grid-template-columns: [frostlbl] 2fr [frostset] 6fr;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      grid-auto-rows: auto;
      align-items: center;
    }

    .frosttitle {
      grid-column: 1 / 3;
      grid-row: 1;
      justify-self: stretch;
      text-align: center;
      font-size: 1.5em;
    }

    .frostlbl {
      grid-column: frostlbl;
      grid-row: 2;
      font-size: 1.2em;
      text-align: right;
    }

    .frostset {
      grid-column: frostset;
      grid-row: 2;
      justify-self: start;
    }

    .frostset2 {
      grid-column: frostset;
      grid-row: 3;
      justify-self: start;
    }

    .frostUpdate {
      grid-column: frostset;
      grid-row: 4;
      justify-self: start;
    }



    @media screen and (orientation:portrait) {

      .thermoGrid {
        grid-template-columns: 1fr 12fr 1fr;
      }

      .thermoT {
        grid-column: 2;
        grid-row: 1;
        justify-self: stretch center;
        text-align: center;
      }

      .ThermoGrp {
        grid-column: 2;
        grid-row: 2;
        display: grid;
        grid-template-columns: [thermolbl] 2fr [thermoset] 4fr;
        grid-column-gap: 1em;
        grid-row-gap: 0.5em;
        grid-auto-rows: auto;
      }

      .thermotitle {
        padding-top: 20px;
      }

      .ThermoUpdateGrp {
        grid-column: 2;
        grid-row: 5;
        padding-top: 50px;
        justify-self: center;
      }

      .CyclicFrostGrp {
        grid-column: 2;
        grid-row: 3;
        display: grid;
        grid-template-columns: 2fr 6fr;
        grid-row-gap: 0.5em;
        grid-auto-rows: auto;
        align-items: center;
      }

      .CyclicGrp {
        grid-column: 1/3;
        grid-row: 1;
        display: grid;
        grid-template-columns: [cycliclbl] 2fr [cyclicset] 4fr;
        grid-column-gap: 1em;
        grid-row-gap: 0.5em;
        grid-auto-rows: auto;
      }

      .cyclictitle {
        padding-top: 20px;
      }

      /* group for frost mode */
      .FrostGrp {
        grid-column: 1/3;
        grid-row: 2;
        display: grid;
        grid-template-columns: [frostlbl] 2fr [frostset] 4fr;
        grid-column-gap: 1em;
        grid-row-gap: 0.5em;
        grid-auto-rows: auto;
      }

      .frosttitle {
        padding-top: 20px;
      }
    }
  </style>

  <style>
    /***********************************************
         Included from battery.css
      ***********************************************/
    .battery {
      font-size: 1em;
      /*margin: 10em 0em 1em 0em;*/
      display: inline-block;
      width: 4.5em;
      height: 10em;
      border: 1em solid gray;
      border-width: .5em 1em;
      position: absolute;
      background-color: red;
      z-index: 1;
      background-size: 100%;
      top: 7.5em;
      left: 37em;
      -webkit-animation: glowing 1500ms infinite;
      -moz-animation: glowing 1500ms infinite;
      -o-animation: glowing 1500ms infinite;
      animation: glowing 1500ms infinite;
    }

    .battery:before {
      position: absolute;
      top: -1.45em;
      left: 0.25em;
      display: block;
      background: orange;
      width: 2em;
      height: 1.5em;
      content: "";
      border-radius: 1em 1em 0 0;
    }

    .battery:after {
      position: absolute;
      top: 0.2em;
      left: -1.8em;
      display: block;
      width: 4.3em;
      height: 7em;
      content: "BATT LOW!";
      color: yellow;
      font-size: 3.5em;
      text-shadow: 2px 2px black;
    }

    @-moz-keyframes glowing {
      0% {
        background-color: orange;
        -moz-box-shadow: 0 0 3px red;
      }

      50% {
        background-color: red;
        -moz-box-shadow: 0 0 80px orange;
      }

      100% {
        background-color: orange;
        -moz-box-shadow: 0 0 3px red;
      }
    }

    @-o-keyframes glowing {
      0% {
        background-color: orange;
        box-shadow: 0 0 3 pxred;
      }

      50% {
        background-color: red;
        box-shadow: 0 0 80px orange;
      }

      100% {
        background-color: orange;
        box-shadow: 0 0 3px red;
      }
    }

    @keyframes glowing {
      0% {
        background-color: orange;
        box-shadow: 0 0 3px red;
      }

      50% {
        background-color: red;
        box-shadow: 0 0 80px orange;
      }

      100% {
        background-color: orange;
        box-shadow: 0 0 3px red;
      }
    }
  </style>

  <style>
    /***********************************************
         Included from bulb.css
      ***********************************************/
    /*
      <div style="height:150px">
        <div class="bulb bulbduller"></div>  
      </div>
      <div style="height:150px">
        <div class="bulb bulbbrighter"></div>
      </div>
      <div style="height:150px">
        <div class="bulb bulbon"></div>
      </div>
      <div style="height:150px">
        <div class="bulb bulbflash"></div>
      </div>
      <div style="height:150px">
        <div class="bulb "></div>
      </div>
      */

    .bulb {
      position: relative;
      left: 2.4em;
      top: 0.4em;
      width: 2em;
      height: 2em;
      border-radius: 1em;
      border: solid 1px;
      /*    animation: glowing 1500ms infinite;*/
      z-index: 1;
    }

    .bulbon {
      animation: glowing 1500ms infinite;
    }

    .bulbflash {
      animation: flashing 1500ms infinite;
    }

    .bulbbrighter {
      animation: brighter 3000ms infinite;
    }

    .bulbduller {
      animation: duller 3000ms infinite;
    }

    .bulb:after {
      /* bulb base */
      position: relative;
      width: 1em;
      height: 0.6em;
      top: 1.8em;
      left: 0.4em;
      border: solid 1px;
      display: block;
      background: grey;
      content: "";
    }

    .bulb:before {
      /* bulb tit */
      position: absolute;
      top: 2em;
      left: 0.55em;
      width: 0.6em;
      height: 0.6em;
      border-radius: 0.5em;
      border: solid 0.1em;
      content: "";
      background: black;
    }



    @keyframes glowing {
      0% {
        background-color: yellow;
        box-shadow: 0 0 0.80em orange;
      }

      50% {
        background-color: yellow;
        box-shadow: 0 0 1.6em orange;
      }

      100% {
        background-color: yellow;
        box-shadow: 0 0 0.8em orange;
      }
    }

    @keyframes flashing {
      0% {
        background-color: white;
        box-shadow: 0 0 0px orange;
      }

      84% {
        background-color: white;
        box-shadow: 0 0 0px orange;
      }

      85% {
        background-color: yellow;
        box-shadow: 0 0 1.6em orange;
      }

      100% {
        background-color: yellow;
        box-shadow: 0 0 1.6em orange;
      }
    }

    @keyframes brighter {
      0% {
        background-color: white;
        box-shadow: 0 0 0px white;
      }

      50% {
        background-color: #F2F5A9;
        box-shadow: 0 0 0.8em #F7D358;
      }

      100% {
        background-color: yellow;
        box-shadow: 0 0 1.6em orange;
      }
    }

    @keyframes duller {
      0% {
        background-color: yellow;
        box-shadow: 0 0 1.6em orange;
      }

      50% {
        background-color: #F2F5A9;
        box-shadow: 0 0 0.8em #F7D358;
      }

      100% {
        background-color: white;
        box-shadow: 0 0 0px white;
      }
    }
  </style>

  <style>
    /***********************************************
         Included from environmental.css
      ***********************************************/
    .Envwrapper {
      display: grid;
      grid-template-columns: 0.5fr 6fr 0.5fr;
      grid-auto-rows: auto;
      grid-column-gap: 50px;
      align-items: center;
      padding: 10px;
    }

    .EnvGrp {
      display: grid;
      /*  grid-template-columns: 0.5fr [label] 2fr [reading] 1fr [type] 1fr [offset] 1fr [adjust] 1fr [endmargin]0.5fr; */
      grid-template-columns: 0.5fr 6fr 0.5fr;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      grid-auto-rows: auto;
      align-items: center;
    }

    .EnvTitle {
      grid-column: 2;
      grid-row: 1;
      justify-self: stretch;
      text-align: center;
      font-size: 1.3em;
    }

    .EnvTitleTemp {
      grid-column: 2;
      grid-row: 2;
      justify-self: stretch;
      text-align: left;
      font-size: 1.3em;
    }

    .EnvTitleBME280 {
      grid-column: 2;
      grid-row: 8;
      justify-self: stretch;
      text-align: left;
      font-size: 1.3em;
    }

    .EnvHead {
      grid-row: 3;
    }

    .EnvTitle2 {
      grid-column: 1 / 6;
      grid-row: 1;
      justify-self: stretch;
      text-align: left;
      font-size: 1.3em;
    }

    .EnvTitle3 {
      grid-column: 1 / 8;
      grid-row: 8;
      justify-self: stretch;
      text-align: center;
      font-size: 1.3em;
    }

    .Envhr {
      grid-column: 2;
      justify-self: stretch;
      display: block;
    }

    .NestedEnvGrp {
      /*  grid-column: label / endmargin;
        justify-self: stretch;*/
      grid-column: 2;
      display: grid;
      grid-template-columns: [label] 2fr [reading] 1fr [type] 1fr [offset] 1fr [adjust] 1fr;
      grid-column-gap: 1em;
      grid-row-gap: 0.5em;
      grid-auto-rows: auto;
      align-items: center;
    }

    .NestedEnv {
      grid-row: 1;
      font-size: 1.3em;
      text-align: right;
    }

    .NestedEnv2 {
      grid-row: 2;
    }

    .Sensor1 {
      grid-row: 4;
    }

    .Sensor2 {
      grid-row: 5;
    }

    .Sensor3 {
      grid-row: 6;
    }

    .Sensor4 {
      grid-row: 7;
    }

    .BME280Grp {
      grid-row: 9;
    }

    .BME280Humidity {
      grid-row: 2;
      font-size: 1.3em;
      text-align: right;
    }

    .BME280Altitude {
      grid-row: 3;
      font-size: 1.3em;
      text-align: right;
    }

    .EnvLabel {
      grid-column: label;
    }

    .EnvReading {
      grid-column: reading;
    }

    .EnvType {
      grid-column: type;
    }

    .EnvOffset {
      grid-column: offset;
    }

    .EnvAdjust {
      grid-column: adjust;
    }

    .btn-env {
      height: 1.5em;
      color: black;
      background: rgb(240, 240, 240);
      border: 2px solid;
      border-radius: 0.75em;
      outline: none;
      text-align: center;
      padding: 0px;
      line-height: 0px;
      width: 5em;
      font-size: 1em;
    }

/* -------------------------------------------------------- */
      /* #pumpgauge {
        margin-left: 160px;
        margin-top: -90px;
    }
    .rightcolumnbox.smallbottompad {
        margin-top: -400px;
        margin-left: 300px;
    } */

    .btn-2col {
    width: 7em;
    font-size: 1.5em !important;
    background-color: #3b73ba;
    color: white;
    border-radius: 10px;
  }

  .down223{
transform: rotate(270deg);
  }
  .up223{
    transform: rotate(90deg);
  }

  .temper {
    padding-top: 140px;
    position: relative;
    left: 277px;
}
.wrapper1 {
    margin-top: -68px;
}
  #a, #b, #c{
    display: inline-flex;
    font-weight: bold;
    font-size: 12px;
  }

  #roundHolder {
    background-color: #555658;
    color: white;
    width: 100px;
    height: 100px;
    padding-top: 30px;
    border-radius: 50%;
    position: relative;
    left: 57%;
    text-align: center;
    z-index: -1;
    top: 22px;
  }

  #a {
    float: left;
    margin-left: 366px;
    margin-top: -68px !important;
    z-index: 5;
    position: relative;
}
#b {
    top: -50px;
    position: relative;
    z-index: 50;
    left: -324px;
}
#c {
    float: left;
    position: relative;
    margin-top: -33px!important;
    margin-left: -293px;
    margin-bottom: 62px;
}

/* ------------------------------------------ */
/* ------------------------------------------ */


@media screen and (max-width: 1280px) {
  
  #roundHolder {
    background-color: #555658;
    color: white;
    width: 110px;
    height: 110px;
    padding-top: 30px;
    border-radius: 50%;
    position: relative;
    left: 70%;
    text-align: center;
    z-index: -1;
    top: 50px;
    font-size: 12px;
}

#a {
    float: left;
    margin-top: -25px !important;
    font-size: 10px;
    margin-left: 10px;
}

#c {
    float: left;
    position: relative;
    margin-top: 15px !important;
    margin-left: -318px;
}
#b {
    float: right;
    position: relative;
    margin-top: -220px !important;
    font-size: 10px;
    font-weight: bold;
    z-index: 50;
    left: 12px;
}

}

@media screen and (max-width: 420px){

  #c {
    float: left;
    margin-top: -85px !important;
    z-index: 20;
    position: relative;
    margin-left: 21%;
    font-size: 6px;
}
#a {
    float: left;
    position: relative;
    z-index: 20;
    margin-top: -8px !important;
    margin-left: -15px;
    font-size: 6px;
}
#b {
    float: right;
    margin-top: -150px !important;
    margin-left: -6%;
    margin-right: -10px;
    position: relative;
    z-index: 50;
}
#roundHolder {
    background-color: #555658;
    color: white;
    width: 75px;
    height: 75px;
    padding-top: 22px;
    border-radius: 50%;
    position: relative;
    left: 70%;
    text-align: center;
    z-index: -1;
    top: 5px;
    font-size: 8px;
}

}

@media screen and (max-width: 360px){
  #b {
    float: right;
    margin-top: -135px !important;
    margin-left: -6%;
    margin-right: -10px;
    position: relative;
    z-index: 50;
}
}


  </style>

</head>

<body onload="init()" onresize="resizeScreen()" onfocus="WindowOnFocus()">
  <div id="text" class="displaynone"
    style="width:100px;background-color: rgba(255,255,255,0.7);position:absolute;top:90px;left:10px;font-size:1.7em;"
    align="center">text</div>
  <!-- FULL PAGE POPUPS! -->

  <!-- ON/OFF POPUP -->
  <!-- starts disply:none, is shown on gauge click -->
  <div id="divOnOff" class="infront" style="display:none">
    <div id="divOnOffscreen" class="solidback">
      <div>
        <div><button id="cancel" class="btn-base btn-3col btn-floatright" onclick="closePopupOnOff()">X</button></div>
        <br>
        <br>
        <b style="font-size: 1.4em">Heater On/Off Control</b>
        <hr>
        <br>
      </div>
      <div class="center">
        <button id="buttonHeaterOff" class="btn-base btn-3col" onclick="turnHeaterOff()">Off</button>
        <button id="buttonHeaterOn" class="btn-base btn-3col" onclick="turnHeaterOn()">On</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button id="buttonHeaterCancel" class="btn-base btn-3col" onclick="closePopupOnOff()">Cancel</button>
      </div>
    </div>
  </div>


  <!-- RESET FUEL POPUP -->
  <div id="divResetFuel" class="infront" style="display:none">
    <div id="divResetFuelPopup" class="solidback">
      <div>
        <div><button id="cancel" class="btn-base btn-3col btn-floatright" onclick="closePopupFuel()">X</button></div>
        <br>
        <br>
        <b style="font-size: 1.4em">Reset Fuel Consumption</b>
        <hr>
        <br>
      </div>
      <div class="center">
        <button id="" class="btn-base btn-2col" onclick="resetFuelConsumption()">Yes</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <button id="" class="btn-base btn-2col" onclick="closePopupFuel()">No</button>
      </div>
    </div>
  </div>

  <!-- Start warning POPUP -->
  <div id="divStartWarning" class="infront" style="display:none">
    <div id="divStartWarningPopup" class="solidback redinfront">
      <div class='center'>
        <b style="font-size: 1.4em">Start request denied</b>
        <hr>
        <br>
        <b id="StartString" style="font-size: 1.2em"></b>
        <br>
        <br>
        <br>
      </div>
      <div class="center">
        <button id="" class="btn-base btn-2col" onclick="closeStartPopup()">OK</button>
      </div>
    </div>
  </div>

  <!-- PASSWORD POPUP -->
  <div id="divPasswordPopUp" class="infront" style="display:none">
    <div id="divResetFuelPopup" class="solidback">
      <div>
        <div><button id="cancel" class="btn-base btn-3col btn-floatright" onclick="closePasswordPopUp()">X</button>
        </div>
        <b style="font-size: 1.4em">Enter Password for Protected Settings</b>
        <hr>
      </div>
      <div class="center">
        <input type="number" min="0" max="9999" id="passwordInput" class="btn-base btn-3col" onclick=""></input>
        <button id="buttonPasswordSubmit" class="btn-base btn-3col" onclick="checkPassword()">Submit</button>
      </div>
    </div>
  </div>

  <!-- LOW BATTERY POPUP -->
  <div style="width:0px;text-align:center;">
    <div id="showLowBattery" class="battery" style="display:none"></div>
  </div>


  <!-- KEYBOARD POPUP -->
  <div id="keyboard" class="infront" style="display:none">
    <div id="solidbackkeyboard" class="keyboardGrid" style="font-size: 2em;">
      <div class="itemKeyTitle"><button id="keyboardTitle" class="keyButton2"
          style="font-family: 'Arial Narrow'"></button></div>
      <div class="itemKeyConstraints"><button id="keyboardConstraints" class="keyButton2"
          style="font-family: 'Arial Narrow'"></button></div>
      <div class="itemKeyEntry"><button id="keyboardDisplay" class="keyButton2">0</button></div>
      <div class="itemKeyClose"><button class="keyButton3" onclick="closeKeyboard()">X</button></div>
      <div class="itemKey1"><button class="keyButton1" onclick="keyboardButton('1')">1</button></div>
      <div class="itemKey2"><button class="keyButton1" onclick="keyboardButton('2')">2</button></div>
      <div class="itemKey3"><button class="keyButton1" onclick="keyboardButton('3')">3</button></div>
      <div class="itemKey4"><button class="keyButton1" onclick="keyboardButton('4')">4</button></div>
      <div class="itemKey5"><button class="keyButton1" onclick="keyboardButton('5')">5</button></div>
      <div class="itemKey6"><button class="keyButton1" onclick="keyboardButton('6')">6</button></div>
      <div class="itemKey7"><button class="keyButton1" onclick="keyboardButton('7')">7</button></div>
      <div class="itemKey8"><button class="keyButton1" onclick="keyboardButton('8')">8</button></div>
      <div class="itemKey9"><button class="keyButton1" onclick="keyboardButton('9')">9</button></div>
      <div class="itemKey0"><button class="keyButton1" onclick="keyboardButton('0')">0</button></div>
      <div class="itemKeyDecimalButton"><button id="keyboardDecimalButton" class="keyButton1"
          onclick="keyboardButton('.')">.</button></div>
      <div class="itemKeyClear"><button id="keyboardClear" class="keyButton2" onclick="keyboardButton('C')">C</button>
      </div>
      <div class="itemKeyApply"><button id="keyboardApply" class="keyButton2" onclick="applyKeyboard()">APPLY</button>
      </div>
    </div>
  </div>




  <!-- NO GAUGE.JS PAGE WARNING POPUP -->
  <div id="divNoGaugeJS" class="divNoGaugeJS">
    <h1>WiFi Burner - The Web interface for Challenger Heaters</h1>
    <p>Welcome! You are seeing this message because a dependant file was not found.</p>
    <p>The missing file is </p>
    <h3>'gauge.min.js'</h3> or <h3>'gauge.min.js.gz'</h3>
    <p></p>
    <p>Place the file in the same folder as this index.html in your SPIFFS folder on your Challenger.</p>
    <p>Details can be found in the Challenger documentation.</p>
    <p>Thank you!</p>
  </div>



  <!-- PAGE TOP -->
  <div id="page" style="display:block ;overflow:hidden">
    <!-- Top Navigation Menu -->
    <div id="topnav" class="topnav">
      <div>
        <a href="javascript:void(0);" id="menu" style="display: block;" class="icon" onclick="funcNavLinks()">≡</a>a>
        <!-- <div id="menu" style="display: block;">≡</div>
          </a> -->
        <a href="javascript:void(0);" id="topBarClientText" onclick="dispMenu('CommsSettingsPage')"
          style="height:2em; text-align:center; font-size: 1em; display: inline-block;"></a>
        <a href="javascript:void(0);" id="topBarText" onclick="dispMenu('HomePage')"
          style="padding-left: 1em; font-size: 2em; display: inline-block;"></a>
        <a href="javascript:void(0);" id="topBarText2" onclick="dispMenu('SystemSettingsPage')"
          style="font-size:1.5em;display:inline-block;"></a>
      </div>
      <div id="divThermostatText" style="background-color: rgb(128, 128, 255);">
        <a href="javascript:void(0);" id="dataText" onclick="dispMenu('ThermostatPage')"
          style="padding-left:0.5em;font-size:1.3em;"></a>
      </div>
      <div id="myLinks" style="z-index:10;position:fixed;text-align: left" ;="">
        <a href="javascript:void(0);" onclick="dispMenu('HomePage')" style="font-family: 'Arial Narrow'">Main System
          Control</a>
        <a href="javascript:void(0);" onclick="dispMenu('ThermostatPage')" style="font-family: 'Arial Narrow'">Heat
          Demand Settings</a>
        <a href="javascript:void(0);" onclick="dispMenu('EnvironmentalPage')"
          style="font-family: 'Arial Narrow'">Environmental Sensors</a>
        <a href="javascript:void(0);" onclick="dispMenu('FuelMixtureSettingsPage')"
          style="font-family: 'Arial Narrow'">Fuel Mixture Settings</a>
        <a href="javascript:void(0);" onclick="dispMenu('DateTimeSettingsPage')"
          style="font-family: 'Arial Narrow'">Date/Time & Timer Settings</a>
        <a href="javascript:void(0);" onclick="dispMenu('SystemSettingsPage')"
          style="font-family: 'Arial Narrow'">System Settings</a>
        <a href="javascript:void(0);" onclick="dispMenu('SystemFunctionsPage')"
          style="font-family: 'Arial Narrow'">System Functions</a>
        <a href="javascript:void(0);" onclick="dispMenu('SystemDetailsPage')" style="font-family: 'Arial Narrow'">System
          Information</a>
        <a href="javascript:void(0);" onclick="dispMenu('CommsSettingsPage')" style="font-family: 'Arial Narrow'">MQTT /
          Server Settings</a>
        <a href="javascript:void(0);" onclick="dispMenu('HelpPage')" style="font-family: 'Arial Narrow'">Support</a>

      </div>
      <!-- <a href="javascript:void(0);" class="icon" onclick="funcNavLinks()">
        <div id="menu" style="display: block;">≡</div>
        </a> -->
    </div>


    <!-- HOME -->
    
    <div id="HomePage" style="display: grid;">
      <div id="roundHolder"> <small>Required</small><br> <h2>27°C</h2></div>
      <div class="wrapper1">
        <div id="divTemperatureGauge">
          <canvas id="temperaturegauge" onclick="clickTempGauge()"></canvas>
        </div>
        <div id="divLinearGauges">
          
          <div class="wrapper22" id="a">
            <div class="rightcolumnbox"><canvas id="rpmgauge"></canvas>
              <div id="textRpmGauge" style="font-size:12px; color: blue;">Fan 0RPM.</div>
            </div>
          </div>
          
          <div class="wrapper22" id="c">

            <div class="rightcolumnbox smallbottompad"><canvas id="bodytempgauge"></canvas>
              <div id="textTempBodyGauge" style="font-size:12px; color: blue;">Body 23°C...</div>
            </div>
          </div>
          <div class="wrapper22" id="b" onclick="clickFuelText()" >
            <div class="rightcolumnbox"><canvas id="pumpgauge"></canvas>
              <div id="textPumpGauge" style="font-size:12px; color: blue;">  Pump 0.0 Hz...</div>
              <div id="textPumpGauge2" style="font-size:8px; color: blue;">  Fuel Rate 0ml/hr...</div>
            </div>
          </div>
        
        </div>
      </div>
      <div id="divDownUp" style="position: relative; display: inline-block; width: 100%; text-align: center; margin-bottom: 40px;">
        <br><br>
        <button id="buttonDesiredDown" class="btn-base btn-2col" onclick="setTemp(-1);"
          style="z-index: 10;font-size:2em">  Down</button>
        <button id="buttonDesiredUp" class="btn-base btn-2col" onclick="setTemp(1);" style="font-size:2em">  Up </button>

      </div>
    </div>


    <!-- Thermostat & Cyclic -->
    <div id="ThermostatPage" class="thermoGrid">
      <div class="thermoT">
        <h2><b>Thermostat, Cyclic & Frost Modes</b></h2>
        <!-- <hr> -->
      </div>

      <div id="ThermoGroup" class="ThermoGrp">
        <div class="thermotitle ">
          <hr>Thermostat Mode
        </div>
        <div class="thermoset">
          <div>
            <button id="buttonThermDirectHz" class="btn-base btn-2col padbottom" onclick="buttonThermSelect(1,0)">Direct
              Hz</button>
            <button id="buttonThermoDefault" class="btn-base btn-2col"
              onclick="buttonThermSelect(2,0)">Standard</button>
          </div>
          <div>
            <button id="buttonThermoDeadband" class="btn-base btn-2col padbottom"
              onclick="buttonThermSelect(3,0)">Deadband</button>
            <button id="buttonThermoLinearHz" class="btn-base btn-2col"
              onclick="buttonThermSelect(4,0)">Comfort</button>
          </div>
          <div>
            <button id="buttonThermoStopStart" class="btn-base btn-2col" onclick="buttonThermSelect(5,0)"
              style="visibility:hidden">Stop Start</button>
            <button id="buttonThermoExternal" class="btn-base btn-2col" onclick="buttonThermSelect(6,0)"
              style="visibility:hidden">External</button>
          </div>
        </div>
        <div id="labelThermostatWindow" class="thermolbl2">Window</div>
        <div id="buttonsThermostatWindow" class="thermoset2">
          <button id="ThermostatWindow" class="btn-base btn-3col">-</button>
          <button class="btn-base btn-3col" onclick="adjustThermWindow(-0.1)">↙</button>
          <button class="btn-base btn-3col" onclick="adjustThermWindow(0.1)">↗</button>
        </div>
        <div id="divCyclicUpDownText" class="thermolbl3">Temp Ref</div>
        <div id="divCyclicUpDownValues" class="thermoset3">
          <button id="CyclicTemp" class="btn-base btn-3col" onclick="">-</button>
          <button class="btn-base btn-3col" onclick="onCyclicRefAdj(-1)">↙</button>
          <button class="btn-base btn-3col" onclick="onCyclicRefAdj(1)">↗</button>
        </div>
      </div>
      <div class="CyclicFrostGrp">
        <div id="CyclicMode" class="CyclicGrp">
          <div class="cyclictitle ">
            <hr>Cyclic Mode
          </div>
          <div id="cyclicLabel" class="cycliclbl1">State</div>
          <div id="divCyclicValues" class="cyclicset1">
            <div>
              <button id="disableCyclic" class="btn-base btn-2col" onclick="buttonCyclicEnbDis(0,0)">Off</button>
              <button id="enableCyclic" class="btn-base btn-2col" onclick="buttonCyclicEnbDis(1,0)">On</button>
            </div>
          </div>
          <div id="divCyclicWindowText" class="cycliclbl3">Start Stop</div>
          <div id="divCyclicWindowValues" class="cyclicset3">
            <div>
              <button id="CyclicOn" class="btn-base btn-2col padbottom" onblur="onCyclicBlur(1)"
                onclick="onButtonCyclicOn()">-</button>
              <button id="CyclicOff" class="btn-base btn-2col" onblur="onCyclicBlur(2)"
                onclick="onButtonCyclicOff()">-</button>
            </div>
          </div>
          <div id="divCyclicAdj" class="cyclicset4">
            <button class="btn-base btn-2col" onclick="onCyclicAdj(-1)">↙</button>
            <button class="btn-base btn-2col" onclick="onCyclicAdj(1)">↗</button>
          </div>
        </div>

        <div id="FrostMode" class="FrostGrp" style="visibility:hidden">
          <div id="divFrostText" class="frosttitle ">
            <hr>Frost Mode
          </div>
          <div class="frostlbl">Start Stop</div>
          <div id="divFrostValues" class="frostset">
            <button id="FrostOn" class="btn-base btn-2col padbottom" onblur="onBlurFrost(1)"
              onclick="onButtonFrostOn()">-</button>
            <button id="FrostRise" class="btn-base btn-2col" onblur="onBlurFrost(2)"
              onclick="onButtonFrostRise()">-</button>
          </div>
          <div id="divFrostAdj" class="frostset2">
            <button class="btn-base btn-2col" onfocus="onFocusFrostAdj()" onclick="onFrostUpDown(-1)">↙</button>
            <button class="btn-base btn-2col" onfocus="onFocusFrostAdj()" onclick="onFrostUpDown(1)">↗</button>
          </div>
        </div>
        <div id="divThermoUpdate" class="ThermoUpdateGrp" style="visibility:hidden">
          <button id="btnThermoUpdate" class="btn-base btn-1colC" onclick="onThermoUpdate();">Update</button>
        </div>
      </div>
    </div>


    <!-- ENVIRONMENTAL -->
    <div id="EnvironmentalPage" class="EnvGrp">
      <div class="EnvTitle">
        <h2><b>Environmental Sensors</b></h2>
      </div>
      <div id="EnvHeading" class="EnvTitleTemp">
        <div class="Envhr">
          <hr>
        </div>
        <h3>Temperature Sensors</h3>
      </div>
      <div id="EnvHeading" class="NestedEnvGrp EnvHead">
        <div class="NestedEnv NestedEnv2 EnvLabel">Sensor ID</div>
        <div class="NestedEnv NestedEnv2 EnvReading">Reading</div>
        <div class="NestedEnv NestedEnv2 EnvType">Sensor Type</div>
        <div class="NestedEnv NestedEnv2 EnvOffset">Offset</div>
      </div>
      <div id="TempGrp" class="NestedEnvGrp Sensor1">
        <div class="NestedEnv EnvLabel">Thermostat</div>
        <div id="Temp" class="NestedEnv EnvReading"></div>
        <div id="TempType" class="NestedEnv EnvType"></div>
        <div class="NestedEnv EnvOffset">
          <button id="TempOffset" class="btn-env" onclick="adjustOffset(1)"></button>
        </div>
      </div>

      <div id="TempGrp2" class="NestedEnvGrp Sensor2">
        <div class="NestedEnv EnvLabel">Sensor #2</div>
        <div id="Temp2" class="NestedEnv EnvReading"></div>
        <div id="Temp2Type" class="NestedEnv EnvType"></div>
        <div class="NestedEnv EnvOffset">
          <button id="Temp2Offset" class="btn-env" onclick="adjustOffset(2)"></button>
        </div>
      </div>
      <div id="TempGrp3" class="NestedEnvGrp Sensor3">
        <div class="NestedEnv EnvLabel">Sensor #3</div>
        <div id="Temp3" class="NestedEnv EnvReading"></div>
        <div id="Temp3Type" class="NestedEnv EnvType"></div>
        <div class="NestedEnv EnvOffset">
          <button id="Temp3Offset" class="btn-env" onclick="adjustOffset(3)"></button>
        </div>
      </div>

      <div id="TempGrp4" class="NestedEnvGrp Sensor4">
        <div class="NestedEnv EnvLabel">Sensor #4</div>
        <div id="Temp4" class="NestedEnv EnvReading"></div>
        <div id="Temp4Type" class="NestedEnv EnvType"></div>
        <div class="NestedEnv EnvOffset">
          <button id="Temp4Offset" class="btn-env" onclick="adjustOffset(4)"></button>
        </div>
      </div>

      <div id="BME280Heading" class="EnvTitleBME280">
        <div class="Envhr">
          <hr>
        </div>
        <h3>BME280 Sensor</h3>
      </div>

      <div id="BME280" class="NestedEnvGrp BME280Grp">
        <div class="BME280Humidity EnvLabel">Relative Humidity:</div>
        <div id="Humidity" class="BME280Humidity EnvReading">H</div>
        <div class="BME280Altitude EnvLabel">Altitude:</div>
        <div id="Altitude" class="BME280Altitude EnvReading">A</div>
      </div>
    </div>


    <!-- FUEL MIXTURE SETTINGS -->

    <div id="FuelMixtureSettingsPage" class="containerGrid">
      <div class="itemT">
        <h2><b>Challenger Default Control Settings</b></h2><br />

        <b1>2 kWh Fuel Min 1.2 Fuel Max 3.3 Fan Min 1450 Fan Max 4300</b1><br />

        <b1>4 kWh Fuel Min 1.5 Fuel Max 4.4 Fan Min 1500 Fan Max 4400</b1><br />

        <b1>6 kWh Fuel Min 1.6 Fuel Max 5.5 Fan Min 1600 Fan Max 4500</b1><br />
        <br />
        <b1>WARNING - Settings can damage heater if not set correctly</b1><br />
        <br />
        <h2><b>Current Set Fuel Mixture Settings</b></h2>
        <hr>
      </div>

      <div id="" class="itemR1L1 lblsmlright">Pump Min Hz</div>
      <div class="itemR1C1">
        <div>
          <button id="PumpMin" class="btn-base btn-3col" onclick="nudgeFuelSetting('PumpMin', 0)">-</button>
          <button id="PumpMinDown" class="btn-base btn-3col" onclick="nudgeFuelSetting('PumpMin', -0.1)">↙</button>
          <button id="PumpMinUp" class="btn-base btn-3col" onclick="nudgeFuelSetting('PumpMin', 0.1)">↗</button>
        </div>
      </div>
      <div id="" class="itemR1L2 lblsmlright">Fan Min RPM</div>
      <div class="itemR1C2">
        <div>
          <button id="FanMin" class="btn-base btn-3col" onclick="nudgeFuelSetting('FanMin', 0)">-</button>
          <button id="FanMinDown" class="btn-base btn-3col" onclick="nudgeFuelSetting('FanMin', -10)">↙</button>
          <button id="FanMinUp" class="btn-base btn-3col" onclick="nudgeFuelSetting('FanMin', 10)">↗</button>
        </div>
      </div>

      <div id="" class="itemR2L1 lblsmlright">Pump Max Hz</div>
      <div class="itemR2C1">
        <div>
          <button id="PumpMax" class="btn-base btn-3col" onclick="nudgeFuelSetting('PumpMax', 0)">-</button>
          <button id="PumpMaxDown" class="btn-base btn-3col" onclick="nudgeFuelSetting('PumpMax', -0.1)">↙</button>
          <button id="PumpMaxUp" class="btn-base btn-3col" onclick="nudgeFuelSetting('PumpMax', 0.1)">↗</button>
        </div>
      </div>
      <div id="" class="itemR2L2 lblsmlright">Fan Max RPM</div>
      <div class="itemR2C2">
        <div>
          <button id="FanMax" class="btn-base btn-3col" onclick="nudgeFuelSetting('FanMax', 0)">-</button>
          <button id="FanMaxDown" class="btn-base btn-3col" onclick="nudgeFuelSetting('FanMax', -10)">↙</button>
          <button id="FanMaxUp" class="btn-base btn-3col" onclick="nudgeFuelSetting('FanMax', 10)">↗</button>
        </div>
      </div>

      <div id="" class="itemFOOTER">
        <button id="buttonUpdateFanPump" class="btn-base btn-1col" onclick="sendFanPumpToHeater()">Update
          Heater</button>
      </div>




    </div>


    <!-- <div id="" class="box" style="display:hidden">>
            <h2><b>Fan/Pump Calculator</b></h2>
            <hr>
            <div id="" class="leftcolumnbox lblsmlleft">Fan/Pump Slope</div>
            <div class="rightcolumnbox">
                <div> <button id="" class="btn-base btn-4col btn-txt" onclick="">236</button> <button id="" class="btn-base btn-4col btn-txt" onclick="">Send</button> <button id="" class="btn-base btn-4col btn-txt" onclick="">Get</button> </div>
            </div>
            <div id="" class="leftcolumnbox lblsmlleft">Fan/Pump Slope</div>
            <div class="rightcolumnbox">
                <div> <button id="" class="btn-base btn-4col btn-txt" onclick="">Up</button> <button id="" class="btn-base btn-4col btn-txt" onclick="">Down</button> <button id="" class="btn-base btn-4col btn-txt" onclick="">Calc</button> </div>
            </div>
        </div> -->

  </div>



  <!-- DATE TIME & TIMER -->
  <div id="DateTimeSettingsPage" class="timerGrid">
    <div class="timeGrp">
      <div class="tmrT">
        <hr>
        <h2>Date, Time</h2>
      </div>
      <!-- DATE TIME -->
      <div class="tmrLblLocal lblsmlright">Local</div>
      <div id="localclock" class="tmrLocal lblsmlright"></div>
      <div class="tmrLblAB lblsmlright">Challenger</div>
      <div id="afterburnerclock" class="tmrAB lblsmlright"></div>
      <div class="tmrSetClock">
        <button id="setClock" class="btn-base btn-2col" onclick="setClock()">Update Time</button>
      </div>
    </div>

    <div class="tmrSettingsGrp">
      <div class="tmrT2">
        <hr>
        <h2>Timer Settings</h2>
      </div>
      <div class="tmrDaysGrp">
        <div class="tmrDays tmrSun lblsmlleft">
          <button id="Sun" class="btn-base btn-day" onclick="buttonDay('Sun')">Sun</button>
        </div>
        <div class="tmrDays tmrMon lblsmlleft">
          <button id="Mon" class="btn-base btn-day" onclick="buttonDay('Mon')">Mon</button>
        </div>
        <div class="tmrDays tmrTue lblsmlleft">
          <button id="Tue" class="btn-base btn-day" onclick="buttonDay('Tue')">Tue</button>
        </div>
        <div class="tmrDays tmrWed lblsmlleft">
          <button id="Wed" class="btn-base btn-day" onclick="buttonDay('Wed')">Wed</button>
        </div>
        <div class="tmrDays tmrThu lblsmlleft">
          <button id="Thu" class="btn-base btn-day" onclick="buttonDay('Thu')">Thu</button>
        </div>
        <div class="tmrDays tmrFri lblsmlleft">
          <button id="Fri" class="btn-base btn-day" onclick="buttonDay('Fri')">Fri</button>
        </div>
        <div class="tmrDays tmrSat lblsmlleft">
          <button id="Sat" class="btn-base btn-day" onclick="buttonDay('Sat')">Sat</button>
        </div>
        <div class="tmrNext lblsmlleft">
          <button id="Next" class="btn-base btn-day" onclick="buttonDay('Next')">Next</button>
        </div>
        <div class="tmrNone lblsmlleft">
          <button id="None" class="btn-base btn-day btn-red" onclick="buttonDay('None')">None</button>
        </div>
      </div>
      <div class="tmrPickerGrp">
        <div class="tmrStart">
          <div id="starttimepicker"></div>
        </div>
        <div class="tmrStop">
          <div id="stoptimepicker"></div>
        </div>
      </div>
      <div class="tmrOptionsGrp">
        <div class="tmrSelect lblsmlright">
          <select class=" lblsmlleft select" id="TimerSel" onchange="onTimerSel()" value="1">
            <option value="1">Timer 1</option>
            <option value="2">Timer 2</option>
            <option value="3">Timer 3</option>
            <option value="4">Timer 4</option>
            <option value="5">Timer 5</option>
            <option value="6">Timer 6</option>
            <option value="7">Timer 7</option>
            <option value="8">Timer 8</option>
            <option value="9">Timer 9</option>
            <option value="10">Timer 10</option>
            <option value="11">Timer 11</option>
            <option value="12">Timer 12</option>
            <option value="13">Timer 13</option>
            <option value="14">Timer 14</option>
          </select>
        </div>
        <div class="tmrTemp">
          <button id="TimerTemp" class="btn-base btn-tmr2col" onclick="buttonTmrTemp(0)">C</button>
          <button id="TimerTempDummy" style="display:none">Dummy</button>
          <!-- <button id="TimerTempDummy" class="btn-base btn-1col " style="display:none" onclick="setTimerTemp();">Dummy</button> -->
        </div>
        <div class="tmrTempDn lblsmlleft">
          <button id="tmrTempDn" class="btn-base btn-day" onclick="buttonTmrTemp(-1)">↙</button>
        </div>
        <div class="tmrTempUp lblsmlleft">
          <button id="tmrTempUp" class="btn-base btn-day" onclick="buttonTmrTemp(+1)">↗</button>
        </div>
        <div class="tmrSet">
          <button id="TimerSet" class="btn-base btn-tmr2col" onclick="onSetTimer()">Set Timer</button>
        </div>
        <div class="tmrRepeat ">
          <button id="Repeat" class="btn-base btn-tmr2col" onclick="onButtonRepeat()">---</button>
        </div>
      </div>
    </div>

    <div class="tmrChart">
      <!-- <canvas id="tmrCanvas" width="290" height="160" onclick="timerClick(event)" style="border:1px solid #000000;"> -->
      <canvas id="tmrCanvas" width="580" height="320" onclick="timerClick(event)" style="border:1px solid #000000;">
      </canvas>
    </div>

  </div>
  <!-- </div> -->


  <!-- SYSTEM SETTINGS -->
  <div id="SystemSettingsPage" class="containerGrid">
    <div class="itemT">
      <h2>System Settings</h2>
      <hr>
    </div>
    <div id="" class="itemR1L1 lblsmlright">Low Voltage Cutout</div>
    <div id="" class="itemR1C1">
      <button id="LowVoltCutout" class="btn-base btn-3col" onclick="showLVCKeyboard()">-</button>
      <button id="buttonLowVoltDown" class="btn-base btn-3col" onclick="adjustLowVolt(-0.1)">↙</button>
      <button id="buttonLowVoltUp" class="btn-base btn-3col" onclick="adjustLowVolt(0.1)">↗</button>
    </div>
    <div id="" class="itemR1L2 lblsmlright">Temperature Format</div>
    <div id="" class="itemR1C2">
      <button id="buttonC" class="btn-base btn-2col" onclick="changeDegreeSymbol(0)">℃</button>
      <button id="buttonF" class="btn-base btn-2col" onclick="changeDegreeSymbol(1)">℉</button>
    </div>
    <div id="" class="itemR2L1 lblsmlright">Protected Options</div>
    <div id="" class="itemR2C1">
      <button id="buttonProtected" class="btn-base btn-2col" onclick="enableProtected();">Enable</button>
    </div>
    <!--<div id="" class="itemR2L1 lblsmlright">System Voltage</div>
        <div id="" class="itemR2C1">
          <button id="button12" class="btn-base btn-2col" onclick="changeSystemVoltage(12,0)">12</button>
          <button id="button24" class="btn-base btn-2col" onclick="changeSystemVoltage(24,0)">24</button>
        </div> -->
  </div>

  <!-- HELP SETTINGS -->
  <div id="HelpPage" class="containerGrid">
    <div class="itemT">
      <h2>Challenger Support 01555 728515</h2> </br>

      <b1>During office hours Mon - Fri 10am - 6pm, Sat 10am - 1pm</b1> <br /> <br />
      <hr>

      <h2>Common user issues</h2> <br />

      <p>E01 - Check your battery voltage and re charge as required.<br />
        If you have a split charge system, start your vehicle to<br />
        increase supply voltage.
      <p><br />
        <hr>
      <p>E08 - Add more fuel to tank.</p><br />
      <hr>
      <p>E10 / E11 - Combustion error, attempt to restart 3 or 4 times. <br />
        This can be caused by running below 1/4 tank <br />
        of fuel even though you have now refilled.<br /> <br />
        It can also be caused by a blocked exhaust or not following<br />
        low temperature running procedure. </p>
      <hr> <br />
      <h2>Preventative maintenance</h2> <br />
      <p>Please run your heater for approx 5 minutes at full <br />
        power / temperature every week / 10 days <br />
        if not being used to keep fuel supply fresh.</p>

      <hr> <br />
      <h2>Low temperature running</h2> <br />
      <p>If running at low temperature for prolonged periods <br />
        I.E overnight, please increase to full power for 5 mins <br />
        before turning off to clear chamber.</p><br />

    </div>
  </div>




  <!-- SYSTEM FUNCTIONS -->
  <div id="SystemFunctionsPage" class="wrapper">

    <div id="GPIOGrp" class="GPIOGrp" style="display:none">
      <div class="GPIOtitle">
        <h3>General purpose input/output</h3>
      </div>

      <div id="divGPin1" class="GPin1L">Digital i/p #1:</div>
      <div id="switch1" class="switch1">
        <canvas id="GPin1" class="swcanvas1" onclick="onGPinStim(1)"></canvas>
      </div>

      <div id="divGPin2" class="GPin2L">Digital i/p #2:</div>
      <div id="switch2" class="switch2">
        <canvas id="GPin2" class="swcanvas2" onclick="onGPinStim(2)"></canvas>
      </div>

      <div id="GPoutLabel1" class="GPout1L">Digital o/p #1:</div>
      <div id="" class="GPout1C">
        <button id="GPoutMethod1" class="btn-base btn-3col" onclick="onGPoutMethod(1)">Toggle</button>
      </div>
      <div id="GPout1div" class="GPout1S" style="height:3em">
        <div id="GPout1" class="bulb" onclick="onGPout(1)"></div>
      </div>

      <div id="GPoutLabel2" class="GPout2L">Digital o/p #2:</div>
      <div id="" class="GPout2C">
        <button id="GPoutMethod2" class="btn-base btn-3col" onclick="onGPoutMethod(2)">Toggle</button>
      </div>
      <div id="GPout2div" class="GPout2S" style="height:3em">
        <div id="GPout2" class="bulb" onclick="onGPout(2)"></div>
      </div>

      <div id="GPmodeAnlg" class="GPalgL"></div>
      <div id="GPanlg" class="GPalgS"></div>
    </div>

    <div class="box">
      <hr>
      <h3>Heater Utility function</h3>
      <div class="leftcolumnbox lblsmlleft">Prime Heater Fuel Lines</div>
      <div id="" class="" style="text-align: right">
        <button id="buttonPrimeOff" class="btn-base btn-2col" onclick="primeHeater(0)">Off</button>
        <button id="buttonPrimeOn" class="btn-base btn-2col" onclick="primeHeater(1)">On</button>
      </div>
      <hr>

      <h3>Challenger WiFi Special functions</h3>
      <div id="FirmwareUpdateL" class="lblsmlleft">Firmware/Software Update</div>
      <div id="FirmwareUpdate" class="" style="text-align: right">
        <button id="" class="btn-base btn-1col padbottom" onclick="openFirmwareUpdatePage();">Update</button>
      </div>
      <div class="lblsmlleft">Reboot Challenger WiFi</div>
      <div id="" class="" style="text-align: right">
        <button id="" class="btn-base btn-1col padbottom" onclick="openRebootPage();">Reboot</button>
        <button id="rebootDummy" class="btn-base btn-1col " style="display:none"
          onclick="openRebootPage();">Dummy</button>
      </div>
      <div id="LoadWebContentL" class="lblsmlleft" style="display:none">Auto Update Web Content</div>
      <div id="" class="" style="text-align:right">
        <button id="LoadWebContent" class="btn-base btn-1col " style="display:none"
          onclick="reqWebUpdate()">Update</button>
      </div>
      <hr>
    </div>
  </div>

  <!-- SYSTEM DETAILS -->
  <div id="SystemDetailsPage" class="wrapper">
    <div id="" class="box">
      <h2><b>System Details</b></h2>
      <hr>
      <h3>Challenger Hour Meters</h3>
      <div class="lblsmlleft">Ignition Glow Plug:</div>
      <div id="SysGlowTime" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlleft">Challenger Heater:</div>
      <div id="SysRunTime" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlleft">Current System Uptime:</div>
      <div id="SysUpTime" class="lblsmlright">&nbsp;</div>
      <hr>
      <h3>Installed Software Versions</h3>
      <div class="lblsmlleft">Challenger Firmware:</div>
      <div id="SysVer" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlleft">Release Date:</div>
      <div id="SysDate" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlleft">WiFi Challenger Version:</div>
      <div id="WebVer" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlleft">Release Date:</div>
      <div id="WebDate" class="lblsmlright">&nbsp;</div>
      <hr>
      <h3>Supply System Voltage</h3>
      <div class="lblsmlleft">Voltage:</div>
      <div id="SysVoltage" class="lblsmlright">&nbsp;</div>
    </div>
    <div class="box">
      <hr>
      <h3>GPIO capability</h3>
      <div id="" class="lblsmlright floatLeft"></div>
      <div id="GPIOcapability" class="lblsmlright">Not fitted</div>
      <hr>
      <h3>Network Information</h3>
      <!-- <hr> -->
      <div class="lblsmlright floatLeft" style="font-size:0.0em">BT MAC:</div>
      <div id="BT_MAC" class="lblsmlright" style="font-size:0.0em">&nbsp;</div>
      <div class="lblsmlright floatLeft">AP IP:</div>
      <div id="IP_AP" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlright floatLeft">AP MAC:</div>
      <div id="IP_APMAC" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlright floatLeft">STA IP:</div>
      <div id="IP_STA" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlright floatLeft">STA MAC:</div>
      <div id="IP_STAMAC" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlright floatLeft">STA SSID:</div>
      <div id="IP_STASSID" class="lblsmlright">&nbsp;</div>
      <div class="lblsmlright floatLeft">OTA Mode:</div>
      <div id="IP_OTA" class="lblsmlright">&nbsp;</div>
      <hr>
    </div>

  </div>


  <!-- COMMUNICATION SETTINGS -->
  <!-- **********************************************************************************************************
              Note that the input fields have global handlers attached for onclick, onkeypress & onfocus
              A more specific handler is used for onblur 
            ********************************************************************************************************** -->
  <div id="CommsSettingsPage" class="commsGrid">

    <div class="commT1">
      Active data connection source
    </div>
    <div class="commR1C">
      <button id="btnWebClient" class="btn-base btn-2col" onclick="buttonCommMode(0)">Local Server</button>
      <button id="btnMQTTClient" class="btn-base btn-2col" onclick="buttonCommMode(1)">MQTT Server</button>
    </div>
    <div id="LWebServerIP" class="commR2L lblminiright">Web Server IP addr</div>
    <div id="" class="commR2C">
      <div class="lblminileft">
        <div class="throb_me" id="WarningNoLS" style="visibility:hidden">No local Storage - Please use another browser
        </div>
        <input size="25" id="WebServerIP" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="url">
        <input size="6" id="WebServerPort" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="numeric">
      </div>
    </div>
    <div class="commT2">
      Challenger WiFi Controller MQTT settings
      <div class="throb_me" id="WarningMQTT" style="height:6vw">For information only.<br>Changes are not allowed via
        remote MQTT</div>
    </div>
    <div class="commABL1 lblminiright">State</div>
    <div class="commABC1">
      <button id="MEn" class="btn-base2" onclick="onMQTTEnable();" style="width:15em">Disabled</button>
      <div id="MOnline">offline</div>
    </div>
    <div class="commABL2 lblminiright">Broker (MQTT)</div>
    <div id="" class="commABC2">
      <div class="lblminileft">
        <input size="25" id="MHost" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="url">
        <input size="6" id="MPort" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="numeric">
      </div>
    </div>
    <div id="" class="commABL3 lblminiright">Username / Password</div>
    <div id="" class="commABC3">
      <div class="lblminileft">
        <input size="12" id="MUser" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="text">
        <input size="12" id="MPasswd" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="text">
      </div>
    </div>
    <div id="" class="commABL4 lblminiright">MQTT Security Key</div>
    <div id="" class="commABC4">
      <div class="lblminileft">
        <input size="25" id="MTopic" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="text">
      </div>
    </div>
    <div class="commT3">
      Local Browser MQTT settings
      <div class="throb_me" id="WarningNoLS2" style="height:6vw;display:none">MQTT connection is not possible.<br>Local
        storage is required.</div>
      <div class="throb_me" id="WarningAuth" style="display:none">Error here</div>
    </div>
    <div class="commMCL1 lblminiright">Broker (must be websocket)</div>
    <div id="" class="commMCC1">
      <div class="lblminileft">
        <input size="25" id="MQTTClientHost" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="url">
        <input size="6" id="MQTTClientPort" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="numeric">
      </div>
    </div>
    <div id="" class="commMCL2 lblminiright">
      Username / Password
    </div>
    <div id="" class="commMCC2">
      <div class="lblminileft">
        <input size="12" id="MQTTClientUsername" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="text">
        <input size="12" id="MQTTClientPassword" class="lblminileft" onblur="onBlurComms(this.id);" inputmode="text">
      </div>
    </div>
    <div id="" class="commMCL3 lblminiright">Local Security Key</div>
    <div id="" class="commMCC3">
      <div class="lblminileft">
        <input size="25" id="MQTTClientTopicPrefix" class="lblminileft" onfocus="onFocus(this.id);"
          onblur="onBlurComms(this.id);" inputmode="text">
      </div>
    </div>
  </div>
  </div>


  </div>

  <!-- required javscript for the gauges-->
  <script>
    /***********************************************
       Included from gauge.min.js
    ***********************************************/
    /*!
    * The MIT License (MIT)
    * 
    * Copyright (c) 2016 Mykhailo Stadnyk <mikhus@gmail.com>
    * 
    * Permission is hereby granted, free of charge, to any person obtaining a copy
    * of this software and associated documentation files (the "Software"), to deal
    * in the Software without restriction, including without limitation the rights
    * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    * copies of the Software, and to permit persons to whom the Software is
    * furnished to do so, subject to the following conditions:
    * 
    * The above copyright notice and this permission notice shall be included in
    * all copies or substantial portions of the Software.
    * 
    * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    * SOFTWARE.
    *
    * @version 2.1.5
    */
    !function (e) {
      "use strict"; function t(e) { if (Array.isArray(e)) { for (var t = 0, i = Array(e.length); t < e.length; t++)i[t] = e[t]; return i } return Array.from(e) } function i(e, t) { if (!e) throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); return !t || "object" != typeof t && "function" != typeof t ? e : t } function r(e, t) { if ("function" != typeof t && null !== t) throw new TypeError("Super expression must either be null or a function, not " + typeof t); e.prototype = Object.create(t && t.prototype, { constructor: { value: e, enumerable: !1, writable: !0, configurable: !0 } }), t && (Object.setPrototypeOf ? Object.setPrototypeOf(e, t) : e.__proto__ = t) } function o(e, t) { if (!(e instanceof t)) throw new TypeError("Cannot call a class as a function") } function n(e, t) { if (t || (t = "undefined" == typeof window ? global : window), void 0 !== t[e]) return t[e]; for (var i = ["webkit", "moz", "ms", "o"], r = 0, o = i.length, n = e.charAt(0).toUpperCase() + e.substr(1); r < o; r++) { var a = t[i[r] + n]; if (void 0 !== a) return a } return null } function a(e, t, i, r, o, n, l) { if ("function" != typeof r) throw new TypeError("Invalid animation rule:", r); var s = e - i, d = s / o, c = 0; d > 1 && (d = 1), 1 !== d && (c = r(d), isFinite(c) && !isNaN(c) && (d = c)), t && t(d), s < o ? l.frame = ue(function (e) { return a(e, t, i, r, o, n, l) }) : (n && n(), l.inProgress = !1) } function l() { Array.prototype.constructor.apply(this, arguments) } function s(e) { if (!(e instanceof DOMException && 2152923147 === e.result)) throw e } function d(e) { return e.majorTicks instanceof Array || (e.majorTicks = e.majorTicks ? [e.majorTicks] : []), e.majorTicks.length || (e.majorTicks.push(Te.formatMajorTickNumber(e.minValue, e)), e.majorTicks.push(Te.formatMajorTickNumber(e.maxValue, e))), ["right" !== e.tickSide, "left" !== e.tickSide] } function c(e, t, i, r, o, n) { e.beginPath(), e.moveTo(t + n, i), e.lineTo(t + r - n, i), e.quadraticCurveTo(t + r, i, t + r, i + n), e.lineTo(t + r, i + o - n), e.quadraticCurveTo(t + r, i + o, t + r - n, i + o), e.lineTo(t + n, i + o), e.quadraticCurveTo(t, i + o, t, i + o - n), e.lineTo(t, i + n), e.quadraticCurveTo(t, i, t + n, i), e.closePath() } function h(e, t) { var i = t.valueDec, r = t.valueInt, o = 0, n = void 0, a = void 0, l = void 0; if (e = parseFloat(e), l = e < 0, e = Math.abs(e), i > 0) { for (a = e.toFixed(i).toString().split("."), n = r - a[0].length; o < n; ++o)a[0] = "0" + a[0]; a = (l ? "-" : "") + a[0] + "." + a[1] } else { for (a = Math.round(e).toString(), n = r - a.length; o < n; ++o)a = "0" + a; a = (l ? "-" : "") + a } return a } function u(e, t) { var i = void 0, r = !1; return i = 0 === t.majorTicksDec ? Math.round(e).toString() : e.toFixed(t.majorTicksDec), t.majorTicksInt > 1 ? (r = ~i.indexOf("."), ~i.indexOf("-") ? "-" + [t.majorTicksInt + t.majorTicksDec + 2 + (r ? 1 : 0) - i.length].join("0") + i.replace("-", "") : [t.majorTicksInt + t.majorTicksDec + 1 + (r ? 1 : 0) - i.length].join("0") + i) : i } function f(e) { return e * Math.PI / 180 } function m(e, t) { return { x: -e * Math.sin(t), y: e * Math.cos(t) } } function v(e, t, i, r) { var o = !(arguments.length > 4 && void 0 !== arguments[4]) || arguments[4], n = arguments.length > 5 && void 0 !== arguments[5] ? arguments[5] : 0, a = e.createLinearGradient(o ? 0 : n, o ? n : 0, o ? 0 : r, o ? r : 0); return a.addColorStop(0, t), a.addColorStop(1, i), a } function b(e, t) { if (arguments.length > 2 && void 0 !== arguments[2] && arguments[2]) return e.restore(), !0; e.save(); var i = t.borderShadowWidth; return i && (e.shadowBlur = i, e.shadowColor = t.colorBorderShadow), !0 } function g(e, t) { t.needleShadow && (e.shadowOffsetX = 2, e.shadowOffsetY = 2, e.shadowBlur = 10, e.shadowColor = t.colorNeedleShadowDown) } function p(e, t, i) { return e["font" + t + "Style"] + " " + e["font" + t + "Weight"] + " " + e["font" + t + "Size"] * i + "px " + e["font" + t] } function w(e) { e.shadowOffsetX = null, e.shadowOffsetY = null, e.shadowBlur = null, e.shadowColor = "", e.strokeStyle = null, e.lineWidth = 0, e.save() } function y(e, t, i, r) { t.valueTextShadow && (e.shadowOffsetX = i, e.shadowOffsetY = i, e.shadowBlur = r, e.shadowColor = t.colorValueTextShadow) } function k(e, t, i, r, o, n) { if (t.valueBox) { w(e); var a = t.valueDec ? 1 + t.valueDec : 0, l = "9".repeat(Math.max.apply(null, [String(parseInt(i)).length + a].concat(t.majorTicks.map(function (e) { return String(parseInt(e, 10)).length + a })))), s = t.valueText || h(i, t), d = n / 200, u = n / 100, f = .4 * u, m = 1.2 * u; e.font = p(t, "Value", d), y(e, t, f, m); var v = e.measureText(t.valueText ? s : "-" + h(Number(l), t)).width; w(e); var b = parseFloat(t.fontValueSize) * d + f + m, g = u * parseFloat(t.valueBoxStroke), k = 2 * n - 2 * g, x = v + 10 * u, T = 1.1 * b + f + m, S = u * t.valueBoxBorderRadius, W = (parseFloat(t.valueBoxWidth) || 0) / 100 * k; W > x && (x = W), x > k && (x = k); var O = r - x / 2, V = o - T / 2, P = o - 5.75 * u; if (e.beginPath(), S ? c(e, O, V, x, T, S) : e.rect(O, V, x, T), g) { var M = e.createRadialGradient(r, P, 10 * u, r, P, 20 * u); M.addColorStop(0, t.colorValueBoxRect), M.addColorStop(1, t.colorValueBoxRectEnd), e.strokeStyle = M, e.lineWidth = g, e.stroke() } t.colorValueBoxShadow && (e.shadowBlur = 1.2 * u, e.shadowColor = t.colorValueBoxShadow), t.colorValueBoxBackground && (e.fillStyle = t.colorValueBoxBackground, e.fill()), e.closePath(), e.restore(), y(e, t, f, m), e.fillStyle = t.colorValueText, e.textAlign = "center", e.textBaseline = "alphabetic", e.fillText(s, O + x / 2, o + T / 2 - b / 3), e.restore() } } function x(e) { var t = e.value, i = e.minValue, r = e.maxValue, o = .01 * (r - i); return { normal: t < i ? i : t > r ? r : t, indented: t < i ? i - o : t > r ? r + o : t } } function T(e, t, i, r, o) { i.beginPath(), i.arc(0, 0, ye(e), 0, 2 * Se, !0), i.lineWidth = t, i.strokeStyle = o ? Te.linearGradient(i, r, o, e) : r, i.stroke(), i.closePath() } function S(e, t) { var i = be.pixelRatio; return e.maxRadius || (e.maxRadius = e.max - t.borderShadowWidth - t.borderOuterWidth * i - t.borderMiddleWidth * i - t.borderInnerWidth * i + (t.borderOuterWidth ? .5 : 0) + (t.borderMiddleWidth ? .5 : 0) + (t.borderInnerWidth ? .5 : 0)), e.maxRadius } function W(e, t) { var i = be.pixelRatio, r = t.borderShadowWidth * i, o = e.max - r - t.borderOuterWidth * i / 2, n = o - t.borderOuterWidth * i / 2 - t.borderMiddleWidth * i / 2 + .5, a = n - t.borderMiddleWidth * i / 2 - t.borderInnerWidth * i / 2 + .5, l = S(e, t), s = void 0, d = !1; e.save(), t.borderOuterWidth && (d = Te.drawShadow(e, t, d), T(o, t.borderOuterWidth * i, e, t.colorBorderOuter, t.colorBorderOuterEnd)), t.borderMiddleWidth && (d = Te.drawShadow(e, t, d), T(n, t.borderMiddleWidth * i, e, t.colorBorderMiddle, t.colorBorderMiddleEnd)), t.borderInnerWidth && (d = Te.drawShadow(e, t, d), T(a, t.borderInnerWidth * i, e, t.colorBorderInner, t.colorBorderInnerEnd)), Te.drawShadow(e, t, d), e.beginPath(), e.arc(0, 0, ye(l), 0, 2 * Se, !0), t.colorPlateEnd ? (s = e.createRadialGradient(0, 0, l / 2, 0, 0, l), s.addColorStop(0, t.colorPlate), s.addColorStop(1, t.colorPlateEnd)) : s = t.colorPlate, e.fillStyle = s, e.fill(), e.closePath(), e.restore() } function O(e, t) { var i = e.max * (parseFloat(t.highlightsWidth) || 0) / 100; if (i) { var r = ye(P(e, t) - i / 2), o = 0, n = t.highlights.length, a = (t.maxValue - t.minValue) / t.ticksAngle; for (e.save(); o < n; o++) { var l = t.highlights[o]; e.beginPath(), e.rotate(We), e.arc(0, 0, r, Te.radians(t.startAngle + (l.from - t.minValue) / a), Te.radians(t.startAngle + (l.to - t.minValue) / a), !1), e.strokeStyle = l.color, e.lineWidth = i, e.stroke(), e.closePath(), e.restore(), e.save() } } } function V(e, t) { var i = P(e, t), r = void 0, o = void 0, n = void 0, a = 0, l = 0, s = Math.abs(t.minorTicks) || 0, d = t.ticksAngle / (t.maxValue - t.minValue); for (e.lineWidth = be.pixelRatio, e.strokeStyle = t.colorMinorTicks || t.colorStrokeTicks, e.save(), t.exactTicks ? (o = t.maxValue - t.minValue, r = s ? o / s : 0, l = (xe.mod(t.majorTicks[0], s) || 0) * d) : r = s * (t.majorTicks.length - 1); a < r; ++a)(n = t.startAngle + l + a * (t.ticksAngle / r)) <= t.ticksAngle + t.startAngle && (e.rotate(Te.radians(n)), e.beginPath(), e.moveTo(0, i), e.lineTo(0, i - .075 * e.max), B(e)) } function P(e, t) { var i = e.max / 100; return S(e, t) - 5 * i - (t.barWidth ? 2 * (parseFloat(t.barStrokeWidth) || 0) + ((parseFloat(t.barWidth) || 0) + 5) * i : 0) } function M(e, t) { Te.prepareTicks(t); var i = ye(P(e, t)), r = void 0, o = void 0, n = t.majorTicks.length, a = be.pixelRatio; for (e.lineWidth = 2 * a, e.save(), o = t.colorMajorTicks instanceof Array ? t.colorMajorTicks : new Array(n).fill(t.colorStrokeTicks || t.colorMajorTicks), r = 0; r < n; ++r)e.strokeStyle = o[r], e.rotate(Te.radians(A(t, t.exactTicks ? t.majorTicks[r] : r, n))), e.beginPath(), e.moveTo(0, i), e.lineTo(0, i - .15 * e.max), B(e); t.strokeTicks && (e.strokeStyle = t.colorStrokeTicks || o[0], e.rotate(We), e.beginPath(), e.arc(0, 0, i, Te.radians(t.startAngle), Te.radians(t.startAngle + t.ticksAngle), !1), B(e)) } function A(e, t, i) { if (e.exactTicks) { var r = e.ticksAngle / (e.maxValue - e.minValue); return e.startAngle + r * (t - e.minValue) } return e.startAngle + t * (e.ticksAngle / (i - 1)) } function B(e) { e.stroke(), e.restore(), e.closePath(), e.save() } function j(e, t) { var i = P(e, t) - .15 * e.max, r = {}, o = 0, n = t.majorTicks.length, a = "needle" !== t.animationTarget, l = t.colorNumbers instanceof Array ? t.colorNumbers : new Array(n).fill(t.colorNumbers), s = a ? -(t.value - t.minValue) / (t.maxValue - t.minValue) * t.ticksAngle : 0; for (a && (e.save(), e.rotate(-Te.radians(s))), e.font = Te.font(t, "Numbers", e.max / 200), e.lineWidth = 0, e.textAlign = "center", e.textBaseline = "middle"; o < n; ++o) { var d = s + A(t, t.exactTicks ? t.majorTicks[o] : o, n), c = e.measureText(t.majorTicks[o]).width, h = t.fontNumbersSize, u = Math.sqrt(c * c + h * h) / 2, f = Te.radialPoint(i - u - t.numbersMargin / 100 * e.max, Te.radians(d)); 360 === d && (d = 0), r[d] || (r[d] = !0, e.fillStyle = l[o], e.fillText(t.majorTicks[o], f.x, f.y)) } a && e.restore() } function C(e, t) { t.title && (e.save(), e.font = Te.font(t, "Title", e.max / 200), e.fillStyle = t.colorTitle, e.textAlign = "center", e.fillText(t.title, 0, -e.max / 4.25, .8 * e.max), e.restore()) } function N(e, t) { t.units && (e.save(), e.font = Te.font(t, "Units", e.max / 200), e.fillStyle = t.colorUnits, e.textAlign = "center", e.fillText(t.units, 0, e.max / 3.25, .8 * e.max), e.restore()) } function E(e, t) { if (t.needle) { var i = t.ticksAngle < 360 ? Te.normalizedValue(t).indented : t.value, r = S(e, t), o = ye(r / 100 * t.needleCircleSize), n = ye(r / 100 * t.needleCircleSize * .75), a = ye(r / 100 * t.needleEnd), l = ye(t.needleStart ? r / 100 * t.needleStart : 0), s = r / 100 * t.needleWidth, d = r / 100 * t.needleWidth / 2, c = be.pixelRatio, h = "needle" !== t.animationTarget; e.save(), Te.drawNeedleShadow(e, t), e.rotate(Te.radians(h ? t.startAngle : t.startAngle + (i - t.minValue) / (t.maxValue - t.minValue) * t.ticksAngle)), e.fillStyle = Te.linearGradient(e, t.colorNeedle, t.colorNeedleEnd, a - l), "arrow" === t.needleType ? (e.beginPath(), e.moveTo(-d, -l), e.lineTo(-s, 0), e.lineTo(-1 * c, a), e.lineTo(c, a), e.lineTo(s, 0), e.lineTo(d, -l), e.closePath(), e.fill(), e.beginPath(), e.lineTo(-.5 * c, a), e.lineTo(-1 * c, a), e.lineTo(-s, 0), e.lineTo(-d, -l), e.lineTo(d / 2 * c - 2 * c, -l), e.closePath(), e.fillStyle = t.colorNeedleShadowUp, e.fill()) : (e.beginPath(), e.moveTo(-d, a), e.lineTo(-d, l), e.lineTo(d, l), e.lineTo(d, a), e.closePath(), e.fill()), t.needleCircleSize && (e.restore(), Te.drawNeedleShadow(e, t), t.needleCircleOuter && (e.beginPath(), e.arc(0, 0, o, 0, 2 * Se, !0), e.fillStyle = Te.linearGradient(e, t.colorNeedleCircleOuter, t.colorNeedleCircleOuterEnd, o), e.fill(), e.closePath()), t.needleCircleInner && (e.beginPath(), e.arc(0, 0, n, 0, 2 * Se, !0), e.fillStyle = Te.linearGradient(e, t.colorNeedleCircleInner, t.colorNeedleCircleInnerEnd, n), e.fill(), e.closePath()), e.restore()) } } function _(e, t, i) { Te.drawValueBox(e, t, i, 0, e.max - .33 * e.max, e.max) } function R(e, t) { var i = e.max / 100, r = S(e, t) - 5 * i, o = parseFloat(t.barStrokeWidth) || 0, n = (parseFloat(t.barWidth) || 0) * i, a = r - 2 * o - n, l = (r - a) / 2, s = a + l, d = o / s, c = t.startAngle, h = t.startAngle + t.ticksAngle; e.save(), e.rotate(We), o && (e.beginPath(), e.arc(0, 0, s, Te.radians(c) - d, Te.radians(h) + d, !1), e.strokeStyle = t.colorBarStroke, e.lineWidth = 2 * l, e.stroke(), e.closePath()), n && (e.beginPath(), e.arc(0, 0, s, Te.radians(c), Te.radians(h), !1), e.strokeStyle = t.colorBar, e.lineWidth = n, e.stroke(), e.closePath(), t.barShadow && (e.beginPath(), e.arc(0, 0, r, Te.radians(c), Te.radians(h), !1), e.clip(), e.beginPath(), e.strokeStyle = t.colorBar, e.lineWidth = 1, e.shadowBlur = t.barShadow, e.shadowColor = t.colorBarShadow, e.shadowOffsetX = 0, e.shadowOffsetY = 0, e.arc(0, 0, r, Te.radians(t.startAngle), Te.radians(t.startAngle + t.ticksAngle), !1), e.stroke(), e.closePath(), e.restore(), e.rotate(We)), t.barProgress && (e.beginPath(), e.arc(0, 0, s, Te.radians(c), Te.radians(c + (Te.normalizedValue(t).normal - t.minValue) / (t.maxValue - t.minValue) * t.ticksAngle), !1), e.strokeStyle = t.colorBarProgress, e.lineWidth = n, e.stroke(), e.closePath())), e.restore() } function I(e) { return e.options.animatedValue ? e.options.value : e.value } function D(e, t, i, r, o, n, a, l) { e.beginPath(), e.fillStyle = l ? Te.linearGradient(e, a, l, o > n ? o : n, n > o, o > n ? i : r) : a, t > 0 ? Te.roundRect(e, i, r, o, n, t) : e.rect(i, r, o, n), e.fill(), e.closePath() } function z(e, t, i, r, o, n, a, l, s) { e.beginPath(), e.lineWidth = t, e.strokeStyle = s ? Te.linearGradient(e, l, s, a, !0, o) : l, i > 0 ? Te.roundRect(e, r, o, n, a, i) : e.rect(r, o, n, a), e.stroke(), e.closePath() } function L(e, t, i, r, o, n) { var a = be.pixelRatio; e.save(); var l = t.borderRadius * a, s = o - t.borderShadowWidth - t.borderOuterWidth * a, d = s - t.borderOuterWidth * a - t.borderMiddleWidth * a, c = d - t.borderMiddleWidth * a - t.borderInnerWidth * a, h = c - t.borderInnerWidth * a, u = n - t.borderShadowWidth - t.borderOuterWidth * a, f = u - t.borderOuterWidth * a - t.borderMiddleWidth * a, m = f - t.borderMiddleWidth * a - t.borderInnerWidth * a, v = m - t.borderInnerWidth * a, b = i - (d - s) / 2, g = b - (c - d) / 2, p = g - (h - c) / 2, w = r - (f - u) / 2, y = w - (m - f) / 2, k = y - (v - m) / 2, x = 0, T = !1; return t.borderOuterWidth && (T = Te.drawShadow(e, t, T), z(e, t.borderOuterWidth * a, l, i + t.borderOuterWidth * a / 2 - x, r + t.borderOuterWidth * a / 2 - x, s, u, t.colorBorderOuter, t.colorBorderOuterEnd), x += .5 * a), t.borderMiddleWidth && (T = Te.drawShadow(e, t, T), z(e, t.borderMiddleWidth * a, l -= 1 + 2 * x, b + t.borderMiddleWidth * a / 2 - x, w + t.borderMiddleWidth * a / 2 - x, d + 2 * x, f + 2 * x, t.colorBorderMiddle, t.colorBorderMiddleEnd), x += .5 * a), t.borderInnerWidth && (T = Te.drawShadow(e, t, T), z(e, t.borderInnerWidth * a, l -= 1 + 2 * x, g + t.borderInnerWidth * a / 2 - x, y + t.borderInnerWidth * a / 2 - x, c + 2 * x, m + 2 * x, t.colorBorderInner, t.colorBorderInnerEnd), x += .5 * a), Te.drawShadow(e, t, T), D(e, l, p, k, h + 2 * x, v + 2 * x, t.colorPlate, t.colorPlateEnd), e.restore(), [p, k, h, v] } function G(e, t, i, r, o, n) { var a = be.pixelRatio, l = n >= o, s = l ? .85 * o : n, d = l ? n : o; i = l ? we(i + (o - s) / 2) : i; var c = !!t.title, h = !!t.units, u = !!t.valueBox, f = void 0, m = void 0, v = void 0; l ? (m = we(.05 * d), f = we(.075 * d), v = we(.11 * d), c && (d -= f, r += f), h && (d -= m), u && (d -= v)) : (m = f = we(.15 * s), c && (s -= f, r += f), h && (s -= m)); var b = 2 * t.barStrokeWidth, g = t.barBeginCircle ? we(s * t.barBeginCircle / 200 - b / 2) : 0, p = we(s * t.barWidth / 100 - b), w = we(d * t.barLength / 100 - b), y = we((d - w) / 2), k = we(i + (l ? s / 2 : y + g)), x = we(r + (l ? d - y - g + b / 2 : s / 2)), T = !l || t.hasLeft && t.hasRight ? 0 : (t.hasRight ? -1 : 1) * t.ticksWidth / 100 * s, S = l || t.hasLeft && t.hasRight ? 0 : (t.hasRight ? -1 : 1) * t.ticksWidth / 100 * s; return e.barDimensions = { isVertical: l, width: s, length: d, barWidth: p, barLength: w, strokeWidth: b, barMargin: y, radius: g, pixelRatio: a, barOffset: null, titleMargin: c ? f : 0, unitsMargin: h ? m : 0, get ticksLength() { return this.barLength - this.barOffset - this.strokeWidth }, X: i + T, Y: r + S, x0: k + T, y0: x + S, baseX: i, baseY: r, ticksPadding: t.ticksPadding / 100 }, e.barDimensions } function F(e, t, i, r, o, n, a) { var l = G(e, t, r, o, n, a), s = l.isVertical, d = l.width, c = l.barWidth, h = l.barLength, u = l.strokeWidth, f = l.barMargin, m = l.radius, v = l.x0, b = l.y0, g = l.X, p = l.Y, w = h; if (e.save(), e.beginPath(), t.barBeginCircle) { var y = Te.radians(s ? 270 : 0), k = Math.asin(c / 2 / m), x = Math.cos(k), T = Math.sin(k), S = v + (s ? m * T : m * x - u / 2), W = s ? b - m * x : b + m * T, O = ye(s ? W - b : S - v); e.barDimensions.barOffset = we(O + m); var V = s ? we(v - m * T) : S, P = s ? W : we(b - m * T); "progress" === i && (h = e.barDimensions.barOffset + (h - e.barDimensions.barOffset) * (Te.normalizedValue(t).normal - t.minValue) / (t.maxValue - t.minValue)); var M = we(S + h - e.barDimensions.barOffset + u / 2), A = we(W - h + e.barDimensions.barOffset - u / 2); e.arc(v, b, m, y + k, y - k), s ? (e.moveTo(S, P), e.lineTo(S, A), e.lineTo(V, A), e.lineTo(V, P)) : (e.moveTo(S, P), e.lineTo(M, P), e.lineTo(M, W), e.lineTo(S, W)) } else { var B = we(s ? g + (d - c) / 2 : g + f), j = we(s ? p + h + f : p + (d - c) / 2); "progress" === i && (h *= (t.value - t.minValue) / (t.maxValue - t.minValue)), s ? e.rect(B, j, c, -h) : e.rect(B, j, h, c) } "progress" !== i && t.barStrokeWidth && (e.lineWidth = u, e.strokeStyle = t.colorBarStroke, e.stroke()), "progress" !== i && t.colorBar ? (e.fillStyle = t.colorBarEnd ? Te.linearGradient(e, t.colorBar, t.colorBarEnd, h, s, s ? p : g) : t.colorBar, e.fill()) : "progress" === i && t.colorBarProgress && (e.fillStyle = t.colorBarProgressEnd ? Te.linearGradient(e, t.colorBarProgress, t.colorBarProgressEnd, w, s, s ? p : g) : t.colorBarProgress, e.fill()), e.closePath(), t.barBeginCircle && (e.barDimensions.radius += u), e.barDimensions.barWidth += u, e.barDimensions.barLength += u } function X(e, t, i, r, o, n) { F(e, t, "", i, r, o, n) } function Y(e, t) { return t.needleSide !== e || t.tickSide !== e || t.numberSide !== e } function U(e, t, i, r, o, n) { t.barProgress && F(e, t, "progress", i, r, o, n) } function q(e, t) { var i = e.barDimensions, r = i.isVertical, o = i.width, n = i.length, a = i.barWidth, l = i.barOffset, s = i.barMargin, d = i.X, c = i.Y, h = i.ticksLength, u = i.ticksPadding, f = o * (parseFloat(t.highlightsWidth) || 0) / 100; if (t.highlights && f) { var m = "right" !== t.tickSide, v = "left" !== t.tickSide, b = 0, g = t.highlights.length, p = (o - a) / 2, w = t.maxValue - t.minValue, y = we(r ? d + p : d + s + l), k = f, x = r ? c + n - s - l : c + p, T = we((t.ticksWidth / 100 + u) * o) + (f - t.ticksWidth / 100 * o), S = we(a + u * o); for (e.save(); b < g; b++) { var W = t.highlights[b], O = h * ye(t.minValue - W.from) / w, V = h * ye((W.to - W.from) / w); e.beginPath(), e.fillStyle = W.color, r ? (m && e.rect(y - T, x - O, k, -V), v && e.rect(y + S, x - O, k, -V)) : (m && e.rect(y + O, x - T, V, k), v && e.rect(y + O, x + S, V, k)), e.fill(), e.closePath() } } } function H(e, t, i, r, o) { e.beginPath(), e.moveTo(t, i), e.lineTo(r, o), e.stroke(), e.closePath(), e.save() } function J(e, t, i, r, o, n, a, l, s) { var d = e.barDimensions, c = d.isVertical, h = d.length, u = d.barWidth, f = d.barOffset, m = d.barMargin, v = d.pixelRatio, b = d.width, g = d.X, p = d.Y, w = d.ticksLength, y = d.ticksPadding, k = (b - u) / 2, x = void 0, T = void 0, S = 0, W = i.length, O = void 0, V = s * b, P = k - y * b, M = k + u + V + y * b, A = t instanceof Array ? t : new Array(i.length).fill(t); e.lineWidth = l * v, e.save(); for (var B = w / (o - r); S < W; S++)O = i[S], e.strokeStyle = A[S], c ? (T = p + h - m - f + (r - O) * B, n && (x = g + P, H(e, x, T, we(x - V), T)), a && (x = g + M, H(e, x, T, we(x - V), T))) : (x = g + m + f - (r - O) * B, n && (T = p + P, H(e, x, T, x, we(T - V))), a && (T = p + M, H(e, x, we(T), x, T - V))) } function $(e, t) { var i = Te.prepareTicks(t), r = le(i, 2), o = r[0], n = r[1], a = 2, l = (t.maxValue - t.minValue) / (t.majorTicks.length - 1), s = t.colorMajorTicks instanceof Array ? t.colorMajorTicks : new Array(t.majorTicks.length).fill(t.colorStrokeTicks || t.colorMajorTicks); if (J(e, s, t.exactTicks ? t.majorTicks : t.majorTicks.map(function (e, i) { return t.minValue + l * i }), t.minValue, t.maxValue, o, n, a, t.ticksWidth / 100), t.strokeTicks) { var d = e.barDimensions, c = d.isVertical, h = d.length, u = d.width, f = d.barWidth, m = d.barMargin, v = d.barOffset, b = d.X, g = d.Y, p = d.ticksLength, w = d.pixelRatio, y = d.ticksPadding, k = (u - f) / 2 + f + y * u, x = (u - f) / 2 - y * u, T = void 0, S = void 0, W = void 0, O = void 0; e.strokeStyle = t.colorStrokeTicks || s[0], a *= w, c ? (S = g + h - m - v + a / 2, O = S - p - a, o && (W = T = we(b + x), Z(e, T, S, W, O)), n && (W = T = we(b + k), Z(e, T, S, W, O))) : (T = b + m + v - a / 2, W = T + p + a, o && (O = S = we(g + x), Z(e, T, S, W, O)), n && (O = S = we(g + k), Z(e, T, S, W, O))) } } function Z(e, t, i, r, o) { e.beginPath(), e.moveTo(t, i), e.lineTo(r, o), e.stroke(), e.closePath() } function K(e, t) { var i = Te.prepareTicks(t), r = le(i, 2), o = r[0], n = r[1], a = [], l = t.minValue, s = Math.abs(t.minorTicks) || 0, d = s ? (t.maxValue - t.minValue) / (s * (t.majorTicks.length - 1)) : 0; if (s) if (t.exactTicks) for (var c = xe.mod(t.majorTicks[0], s) || 0; l < t.maxValue; l += s)c + l < t.maxValue && a.push(c + l); else for (; l < t.maxValue; l += d)a.push(l); J(e, t.colorMinorTicks || t.colorStrokeTicks, a, t.minValue, t.maxValue, o, n, 1, t.ticksWidthMinor / 100) } function Q(e, t) { var i = e.barDimensions, r = i.isVertical, o = i.length, n = i.width, a = i.barWidth, l = i.barMargin, s = i.barOffset, d = i.X, c = i.Y, h = i.ticksLength, u = i.ticksPadding, f = t.maxValue - t.minValue, m = f / (t.majorTicks.length - 1), v = t.exactTicks ? t.majorTicks : t.majorTicks.map(function (e, i) { return t.minValue + m * i }), b = v.length, g = "right" !== t.numberSide, p = "left" !== t.numberSide, w = t.fontNumbersSize * n / 200, y = 0, k = (t.ticksWidth / 100 + 2 * u) * n, x = (n - a) / 2 - k, T = (n - a) / 2 + a + k, S = void 0, W = void 0, O = void 0, V = void 0, P = t.colorNumbers instanceof Array ? t.colorNumbers : new Array(b).fill(t.colorNumbers), M = t.numbersMargin / 100 * n; for (e.font = Te.font(t, "Numbers", n / 200), e.lineWidth = 0, e.textAlign = "center"; y < b; y++)e.fillStyle = P[y], V = t.majorTicks[y], O = t.exactTicks ? h * ((v[y] - t.minValue) / f) : y * h / (b - 1), r ? (W = c + o - l - s - O + w / 3, g && (e.textAlign = "right", e.fillText(V, d + x - M, W)), p && (e.textAlign = "left", e.fillText(V, d + T + M, W))) : (e.measureText(V).width, S = d + l + s + O, g && e.fillText(V, S, c + x - M), p && e.fillText(V, S, c + T + w + M)) } function ee(e, t) { if (t.title) { var i = e.barDimensions, r = i.isVertical, o = i.width, n = i.length, a = i.baseX, l = i.baseY, s = i.titleMargin, d = t.fontTitleSize * o / 200, c = we(a + (r ? o : n) / 2), h = we(l + s / 2 - (r ? d : d / 2) - .025 * (r ? n : o)); e.save(), e.textAlign = "center", e.fillStyle = t.colorTitle, e.font = Te.font(t, "Title", o / 200), e.lineWidth = 0, e.fillText(t.title, c, h, r ? o : n) } } function te(e, t) { if (t.units) { var i = e.barDimensions, r = i.isVertical, o = i.width, n = i.length, a = i.baseX, l = i.baseY, s = i.unitsMargin, d = t.fontUnitsSize * o / 200, c = we(a + (r ? o : n) / 2), h = we(l + (r ? n : o) + s / 2 - d / 2); e.save(), e.textAlign = "center", e.fillStyle = t.colorUnits, e.font = Te.font(t, "Units", o / 200), e.lineWidth = 0, e.fillText(t.units, c, h, r ? o : n) } } function ie(e, t) { if (t.needle) { var i = e.barDimensions, r = i.isVertical, o = i.width, n = i.length, a = i.barWidth, l = i.barOffset, s = i.barMargin, d = i.ticksLength, c = i.X, h = i.Y, u = i.ticksPadding, f = "right" !== t.needleSide, m = "left" !== t.needleSide, v = d * (Te.normalizedValue(t).indented - t.minValue) / (t.maxValue - t.minValue), b = (t.ticksWidth / 100 + u) * o, g = a / 2 + b, p = g * (t.needleEnd / 100), w = void 0, y = void 0, k = void 0, x = void 0, T = "arrow" === t.needleType.toLowerCase() ? ne : oe, S = (o - a) / 2, W = g * (t.needleStart / 100), O = S - b - W, V = S + a + b + W; e.save(), Te.drawNeedleShadow(e, t), r ? (k = we(h + n - s - l - v), f && (w = we(c + O), y = w + p, T(e, t, w, k, y, k, p)), m && (w = we(c + V), y = w - p, T(e, t, w, k, y, k, p, !0))) : (w = we(c + s + l + v), f && (k = we(h + O), x = k + p, T(e, t, w, k, w, x, p)), m && (k = we(h + V), x = k - p, T(e, t, w, k, w, x, p, !0))), e.restore() } } function re(e, t, i, r) { return t.colorNeedleEnd ? Te.linearGradient(e, r ? t.colorNeedleEnd : t.colorNeedle, r ? t.colorNeedle : t.colorNeedleEnd, i, !e.barDimensions.isVertical) : t.colorNeedle } function oe(e, t, i, r, o, n, a, l) { e.lineWidth = t.needleWidth, e.strokeStyle = re(e, t, a, l), e.beginPath(), e.moveTo(i, r), e.lineTo(o, n), e.stroke(), e.closePath() } function ne(e, t, i, r, o, n, a, l) { var s = we(.4 * a), d = a - s, c = i === o, h = t.needleWidth / 2; e.fillStyle = re(e, t, a, l), e.beginPath(), c ? (r > n && (d *= -1), e.moveTo(i - h, r), e.lineTo(i + h, r), e.lineTo(i + h, r + d), e.lineTo(i, n), e.lineTo(i - h, r + d), e.lineTo(i - h, r)) : (i > o && (d *= -1), e.moveTo(i, r - h), e.lineTo(i, r + h), e.lineTo(i + d, r + h), e.lineTo(o, r), e.lineTo(i + d, r - h), e.lineTo(i, r - h)), e.fill(), e.closePath() } function ae(e, t, i, r, o, n, a) { var l = (parseFloat(t.fontValueSize) || 0) * n / 200, s = (.11 * a - l) / 2; e.barDimensions.isVertical && Te.drawValueBox(e, t, i, r + n / 2, o + a - l - s, n) } var le = function () { function e(e, t) { var i = [], r = !0, o = !1, n = void 0; try { for (var a, l = e[Symbol.iterator](); !(r = (a = l.next()).done) && (i.push(a.value), !t || i.length !== t); r = !0); } catch (e) { o = !0, n = e } finally { try { !r && l.return && l.return() } finally { if (o) throw n } } return i } return function (t, i) { if (Array.isArray(t)) return t; if (Symbol.iterator in Object(t)) return e(t, i); throw new TypeError("Invalid attempt to destructure non-iterable instance") } }(), se = function e(t, i, r) { null === t && (t = Function.prototype); var o = Object.getOwnPropertyDescriptor(t, i); if (void 0 === o) { var n = Object.getPrototypeOf(t); return null === n ? void 0 : e(n, i, r) } if ("value" in o) return o.value; var a = o.get; if (void 0 !== a) return a.call(r) }, de = function e(t, i, r, o) { var n = Object.getOwnPropertyDescriptor(t, i); if (void 0 === n) { var a = Object.getPrototypeOf(t); null !== a && e(a, i, r, o) } else if ("value" in n && n.writable) n.value = r; else { var l = n.set; void 0 !== l && l.call(o, r) } return r }, ce = function () { function e(e, t) { for (var i = 0; i < t.length; i++) { var r = t[i]; r.enumerable = r.enumerable || !1, r.configurable = !0, "value" in r && (r.writable = !0), Object.defineProperty(e, r.key, r) } } return function (t, i, r) { return i && e(t.prototype, i), r && e(t, r), t } }(); Object.assign || Object.defineProperty(Object, "assign", { enumerable: !1, configurable: !0, writable: !0, value: function (e, t) { if (void 0 === e || null === e) throw new TypeError("Cannot convert first argument to object"); for (var i = Object(e), r = 1; r < arguments.length; r++) { var o = arguments[r]; if (void 0 !== o && null !== o) for (var n = Object.keys(Object(o)), a = 0, l = n.length; a < l; a++) { var s = n[a], d = Object.getOwnPropertyDescriptor(o, s); void 0 !== d && d.enumerable && (i[s] = o[s]) } } return i } }), Array.prototype.indexOf || Object.defineProperty(Array.prototype, "indexOf", { value: function (e, t) { var i; if (null === this) throw new TypeError('"this" is null or not defined'); var r = Object(this), o = r.length >>> 0; if (0 === o) return -1; var n = +t || 0; if (Math.abs(n) === 1 / 0 && (n = 0), n >= o) return -1; for (i = Math.max(n >= 0 ? n : o - Math.abs(n), 0); i < o;) { if (i in r && r[i] === e) return i; i++ } return -1 } }), Array.prototype.fill || Object.defineProperty(Array.prototype, "fill", { value: function (e) { if (null === this) throw new TypeError("this is null or not defined"); for (var t = Object(this), i = t.length >>> 0, r = arguments[1], o = r >> 0, n = o < 0 ? Math.max(i + o, 0) : Math.min(o, i), a = arguments[2], l = void 0 === a ? i : a >> 0, s = l < 0 ? Math.max(i + l, 0) : Math.min(l, i); n < s;)t[n] = e, n++; return t } }), "undefined" == typeof window && (window = "undefined" == typeof global ? {} : global); var he = function () { function e() { o(this, e), this._events = {}, this.addListener = this.on, this.removeListener = this.off } return ce(e, [{ key: "emit", value: function (e) { if (this._events[e]) { for (var t = 0, i = this._events[e].length, r = arguments.length, o = Array(r > 1 ? r - 1 : 0), n = 1; n < r; n++)o[n - 1] = arguments[n]; for (; t < i; t++)this._events[e][t] && this._events[e][t].apply(this, o) } } }, { key: "once", value: function (e) { for (var t = arguments.length, i = Array(t > 1 ? t - 1 : 0), r = 1; r < t; r++)i[r - 1] = arguments[r]; for (var o = 0, n = i.length, a = this; o < n; o++)!function () { var t = i[o], r = function i() { a.off(e, i), t.apply(a, arguments) }; i[o] = r }(); this.on.apply(this, [e].concat(i)) } }, { key: "on", value: function (e) { this._events[e] || (this._events[e] = []); for (var t = 0, i = arguments.length <= 1 ? 0 : arguments.length - 1; t < i; t++)this._events[e].push(arguments.length <= t + 1 ? void 0 : arguments[t + 1]) } }, { key: "off", value: function (e) { if (this._events[e]) for (var t = 0, i = arguments.length <= 1 ? 0 : arguments.length - 1; t < i; t++)for (var r = arguments.length <= t + 1 ? void 0 : arguments[t + 1], o = void 0; ~(o = this._events[e].indexOf(r));)this._events[e].splice(o, 1) } }, { key: "removeAllListeners", value: function (e) { delete this._events[e] } }, { key: "listeners", get: function () { return this._events } }]), e }(), ue = n("requestAnimationFrame") || function (e) { return setTimeout(function () { return e((new Date).getTime()) }, 1e3 / 60) }, fe = { linear: function (e) { return e }, quad: function (e) { return Math.pow(e, 2) }, dequad: function (e) { return 1 - fe.quad(1 - e) }, quint: function (e) { return Math.pow(e, 5) }, dequint: function (e) { return 1 - Math.pow(1 - e, 5) }, cycle: function (e) { return 1 - Math.sin(Math.acos(e)) }, decycle: function (e) { return Math.sin(Math.acos(1 - e)) }, bounce: function (e) { return 1 - fe.debounce(1 - e) }, debounce: function (e) { for (var t = 0, i = 1; 1; t += i, i /= 2)if (e >= (7 - 4 * t) / 11) return -Math.pow((11 - 6 * t - 11 * e) / 4, 2) + Math.pow(i, 2) }, elastic: function (e) { return 1 - fe.delastic(1 - e) }, delastic: function (e) { return Math.pow(2, 10 * (e - 1)) * Math.cos(20 * Math.PI * 1.5 / 3 * e) } }, me = function () { function e() { var t = arguments.length > 0 && void 0 !== arguments[0] ? arguments[0] : "linear", i = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : 250, r = arguments.length > 2 && void 0 !== arguments[2] ? arguments[2] : function () { }, n = arguments.length > 3 && void 0 !== arguments[3] ? arguments[3] : function () { }; if (o(this, e), this.duration = i, this.rule = t, this.draw = r, this.end = n, "function" != typeof this.draw) throw new TypeError("Invalid animation draw callback:", r); if ("function" != typeof this.end) throw new TypeError("Invalid animation end callback:", n) } return ce(e, [{ key: "animate", value: function (e, t) { var i = this; this.frame && this.cancel(); var r = window.performance && window.performance.now ? window.performance.now() : n("animationStartTime") || Date.now(); e = e || this.draw, t = t || this.end, this.draw = e, this.end = t, this.frame = ue(function (o) { return a(o, e, r, fe[i.rule] || i.rule, i.duration, t, i) }) } }, { key: "cancel", value: function () { if (this.frame) { (n("cancelAnimationFrame") || function (e) { })(this.frame), this.frame = null } } }, { key: "destroy", value: function () { this.cancel(), this.draw = null, this.end = null } }]), e }(); me.rules = fe; var ve = function () { function t(i, r, n) { o(this, t), this.options = i, this.element = r.toLowerCase(), this.type = t.toDashed(n), this.Type = e[n], this.mutationsObserved = !1, this.isObservable = !!window.MutationObserver, window.GAUGES_NO_AUTO_INIT || t.domReady(this.traverse.bind(this)) } return ce(t, [{ key: "isValidNode", value: function (e) { return !(!e.tagName || e.tagName.toLowerCase() !== this.element || e.getAttribute("data-type") !== this.type) } }, { key: "traverse", value: function () { for (var e = document.getElementsByTagName(this.element), t = 0, i = e.length; t < i; t++)this.process(e[t]); this.isObservable && !this.mutationsObserved && (new MutationObserver(this.observe.bind(this)).observe(document.body, { childList: !0, subtree: !0, attributes: !0, characterData: !0, attributeOldValue: !0, characterDataOldValue: !0 }), this.mutationsObserved = !0) } }, { key: "observe", value: function (e) { for (var t = 0, i = e.length; t < i; t++) { var r = e[t]; if ("attributes" === r.type && "data-type" === r.attributeName && this.isValidNode(r.target) && r.oldValue !== this.type) setTimeout(this.process.bind(this, r.target)); else if (r.addedNodes && r.addedNodes.length) for (var o = 0, n = r.addedNodes.length; o < n; o++)setTimeout(this.process.bind(this, r.addedNodes[o])) } } }, { key: "process", value: function (e) { var i = this; if (!this.isValidNode(e)) return null; var r = void 0, o = JSON.parse(JSON.stringify(this.options)), n = null; for (r in o) if (o.hasOwnProperty(r)) { var a = t.toAttributeName(r), l = t.parse(e.getAttribute(a)); null !== l && void 0 !== l && (o[r] = l) } return o.renderTo = e, n = new this.Type(o), n.draw && n.draw(), this.isObservable ? (n.observer = new MutationObserver(function (r) { r.forEach(function (r) { if ("attributes" === r.type) { var o = r.attributeName.toLowerCase(), a = e.getAttribute(o).toLowerCase(); if ("data-type" === o && a && a !== i.type) n.observer.disconnect(), delete n.observer, n.destroy && n.destroy(); else if ("data-" === o.substr(0, 5)) { var l = o.substr(5).split("-").map(function (e, t) { return t ? e.charAt(0).toUpperCase() + e.substr(1) : e }).join(""), s = {}; s[l] = t.parse(e.getAttribute(r.attributeName)), "value" === l ? n && (n.value = s[l]) : n.update && n.update(s) } } }) }), n.observer.observe(e, { attributes: !0 }), n) : n } }], [{ key: "parse", value: function (e) { if ("true" === e) return !0; if ("false" === e) return !1; if ("undefined" !== e) { if ("null" === e) return null; if (/^[-+#.\w\d\s]+(?:,[-+#.\w\d\s]*)+$/.test(e)) return e.split(","); try { return JSON.parse(e) } catch (e) { } return e } } }, { key: "toDashed", value: function (e) { for (var t = e.split(/(?=[A-Z])/), i = 1, r = t.length, o = t[0].toLowerCase(); i < r; i++)o += "-" + t[i].toLowerCase(); return o } }, { key: "toCamelCase", value: function (e) { for (var t = !(arguments.length > 1 && void 0 !== arguments[1]) || arguments[1], i = e.split(/-/), r = 0, o = i.length, n = ""; r < o; r++)n += r || t ? i[r][0].toUpperCase() + i[r].substr(1).toLowerCase() : i[r].toLowerCase(); return n } }, { key: "toAttributeName", value: function (e) { return "data-" + t.toDashed(e) } }, { key: "domReady", value: function (e) { if (/comp|inter|loaded/.test((window.document || {}).readyState + "")) return e(); window.addEventListener ? window.addEventListener("DOMContentLoaded", e, !1) : window.attachEvent && window.attachEvent("onload", e) } }]), t }(), be = function () { function e(t, i, r) { o(this, e), e.collection.push(this), this.width = i || 0, this.height = r || 0, this.element = t, this.init() } return ce(e, [{ key: "init", value: function () { var t = e.pixelRatio; this.element.width = this.width * t, this.element.height = this.height * t, this.element.style.width = this.width + "px", this.element.style.height = this.height + "px", this.elementClone = this.element.cloneNode(!0), this.context = this.element.getContext("2d"), this.contextClone = this.elementClone.getContext("2d"), this.drawWidth = this.element.width, this.drawHeight = this.element.height, this.drawX = this.drawWidth / 2, this.drawY = this.drawHeight / 2, this.minSide = this.drawX < this.drawY ? this.drawX : this.drawY, this.elementClone.initialized = !1, this.contextClone.translate(this.drawX, this.drawY), this.contextClone.save(), this.context.translate(this.drawX, this.drawY), this.context.save(), this.context.max = this.contextClone.max = this.minSide, this.context.maxRadius = this.contextClone.maxRadius = null } }, { key: "destroy", value: function () { var t = e.collection.indexOf(this); ~t && e.collection.splice(t, 1), this.context.clearRect(-this.drawX, -this.drawY, this.drawWidth, this.drawHeight), this.context.max = null, delete this.context.max, this.context.maxRadius = null, delete this.context.maxRadius, this.context = null, this.contextClone = null, this.elementClone = null, this.element = null, this.onRedraw = null } }, { key: "commit", value: function () { var t = e.pixelRatio; return 1 !== t && (this.contextClone.scale(t, t), this.contextClone.save()), this } }, { key: "redraw", value: function () { return this.init(), this.onRedraw && this.onRedraw(), this } }], [{ key: "redraw", value: function () { for (var t = 0, i = e.collection.length; t < i; t++)e.collection[t].redraw() } }, { key: "pixelRatio", get: function () { return window.devicePixelRatio || 1 } }]), e }(); be.collection = [], window.matchMedia && window.matchMedia("screen and (min-resolution: 2dppx)").addListener(be.redraw); var ge = {
        renderTo: null, width: 0, height: 0, minValue: 0, maxValue: 100, value: 0, units: !1, exactTicks: !1, majorTicks: [0, 20, 40, 60, 80, 100], minorTicks: 10, strokeTicks: !0, animatedValue: !1, animateOnInit: !1, title: !1, borders: !0, numbersMargin: 1, listeners: null, valueInt: 3, valueDec: 2, majorTicksInt: 1, majorTicksDec: 0, animation: !0, animationDuration: 500, animationRule: "cycle", colorPlate: "#fff", colorPlateEnd: "", colorMajorTicks: "#444",
        colorMinorTicks: "#666", colorStrokeTicks: "", colorTitle: "#888", colorUnits: "#888", colorNumbers: "#444", colorNeedle: "rgba(240,128,128,1)", colorNeedleEnd: "rgba(255,160,122,.9)", colorValueText: "#444", colorValueTextShadow: "rgba(0,0,0,0.3)", colorBorderShadow: "rgba(0,0,0,0.5)", colorBorderOuter: "#ddd", colorBorderOuterEnd: "#aaa", colorBorderMiddle: "#eee", colorBorderMiddleEnd: "#f0f0f0", colorBorderInner: "#fafafa", colorBorderInnerEnd: "#ccc", colorValueBoxRect: "#888", colorValueBoxRectEnd: "#666", colorValueBoxBackground: "#babab2", colorValueBoxShadow: "rgba(0,0,0,1)", colorNeedleShadowUp: "rgba(2,255,255,0.2)", colorNeedleShadowDown: "rgba(188,143,143,0.45)", colorBarStroke: "#222", colorBar: "#ccc", colorBarProgress: "#888", colorBarShadow: "#000", fontNumbers: "Arial", fontTitle: "Arial", fontUnits: "Arial", fontValue: "Arial", fontNumbersSize: 20, fontTitleSize: 24, fontUnitsSize: 22, fontValueSize: 26, fontNumbersStyle: "normal", fontTitleStyle: "normal", fontUnitsStyle: "normal", fontValueStyle: "normal", fontNumbersWeight: "normal", fontTitleWeight: "normal", fontUnitsWeight: "normal", fontValueWeight: "normal", needle: !0, needleShadow: !0, needleType: "arrow", needleStart: 5, needleEnd: 85, needleWidth: 4, borderOuterWidth: 3, borderMiddleWidth: 3, borderInnerWidth: 3, borderShadowWidth: 3, valueBox: !0, valueBoxStroke: 5, valueBoxWidth: 0, valueText: "", valueTextShadow: !0, valueBoxBorderRadius: 2.5, highlights: [{ from: 20, to: 60, color: "#eee" }, { from: 60, to: 80, color: "#ccc" }, { from: 80, to: 100, color: "#999" }], highlightsWidth: 15, barWidth: 20, barStrokeWidth: 0, barProgress: !0, barShadow: 0
      }; l.prototype = Object.create(Array.prototype), l.prototype.constructor = l, l.prototype.get = function (e) { if ("string" == typeof e) for (var t = 0, i = this.length; t < i; t++) { var r = this[t].options.renderTo.tagName ? this[t].options.renderTo : document.getElementById(this[t].options.renderTo || ""); if (r.getAttribute("id") === e) return this[t] } else if ("number" == typeof e) return this[e]; return null }; var pe = "2.1.5", we = Math.round, ye = Math.abs, ke = new l; ke.version = pe; var xe = function (t) { function n(t) { o(this, n); var r = i(this, (n.__proto__ || Object.getPrototypeOf(n)).call(this)), a = r.constructor.name; if ("BaseGauge" === a) throw new TypeError("Attempt to instantiate abstract class!"); if (ke.push(r), t.listeners && Object.keys(t.listeners).forEach(function (e) { (t.listeners[e] instanceof Array ? t.listeners[e] : [t.listeners[e]]).forEach(function (t) { r.on(e, t) }) }), r.version = pe, r.type = e[a] || n, r.initialized = !1, t.minValue = parseFloat(t.minValue), t.maxValue = parseFloat(t.maxValue), t.value = parseFloat(t.value) || 0, t.borders || (t.borderInnerWidth = t.borderMiddleWidth = t.borderOuterWidth = 0), !t.renderTo) throw TypeError("Canvas element was not specified when creating the Gauge object!"); var l = t.renderTo.tagName ? t.renderTo : document.getElementById(t.renderTo); if (!(l instanceof HTMLCanvasElement)) throw TypeError("Given gauge canvas element is invalid!"); return t.width = parseFloat(t.width) || 0, t.height = parseFloat(t.height) || 0, t.width && t.height || (t.width || (t.width = l.parentNode ? l.parentNode.offsetWidth : l.offsetWidth), t.height || (t.height = l.parentNode ? l.parentNode.offsetHeight : l.offsetHeight)), r.options = t || {}, r.options.animateOnInit && (r._value = r.options.value, r.options.value = r.options.minValue), r.canvas = new be(l, t.width, t.height), r.canvas.onRedraw = r.draw.bind(r), r.animation = new me(t.animationRule, t.animationDuration), r } return r(n, t), ce(n, [{ key: "update", value: function (e) { return Object.assign(this.options, this.type.configure(e || {})), this.canvas.width = this.options.width, this.canvas.height = this.options.height, this.animation.rule = this.options.animationRule, this.animation.duration = this.options.animationDuration, this.canvas.redraw(), this } }, { key: "destroy", value: function () { var e = ke.indexOf(this); ~e && ke.splice(e, 1), this.canvas.destroy(), this.canvas = null, this.animation.destroy(), this.animation = null, this.emit("destroy") } }, { key: "draw", value: function () { return this.options.animateOnInit && !this.initialized && (this.value = this._value, this.initialized = !0, this.emit("init")), this.emit("render"), this } }, { key: "value", set: function (e) { var t = this; e = n.ensureValue(e, this.options.minValue); var i = this.options.value; if (e !== i) if (this.options.animation) { if (this.animation.frame && (this.options.value = this._value, this._value === e)) return this.animation.cancel(), void delete this._value; void 0 === this._value && (this._value = e), this.emit("animationStart"), this.animation.animate(function (r) { var o = i + (e - i) * r; t.options.animatedValue && t.emit("value", o, t.value), t.options.value = o, t.draw(), t.emit("animate", r, t.options.value) }, function () { void 0 !== t._value && (t.emit("value", t._value, t.value), t.options.value = t._value, delete t._value), t.draw(), t.emit("animationEnd") }) } else this.emit("value", e, this.value), this.options.value = e, this.draw() }, get: function () { return void 0 === this._value ? this.options.value : this._value } }], [{ key: "configure", value: function (e) { return e } }, { key: "initialize", value: function (e, t) { return new ve(t, "canvas", e) } }, { key: "fromElement", value: function (e) { var t = ve.toCamelCase(e.getAttribute("data-type")), i = e.attributes, r = 0, o = i.length, n = {}; if (t) { for (/Gauge$/.test(t) || (t += "Gauge"); r < o; r++)n[ve.toCamelCase(i[r].name.replace(/^data-/, ""), !1)] = ve.parse(i[r].value); new ve(n, e.tagName, t).process(e) } } }, { key: "ensureValue", value: function (e) { var t = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : 0; return e = parseFloat(e), !isNaN(e) && isFinite(e) || (e = parseFloat(t) || 0), e } }, { key: "mod", value: function (e, t) { return (e % t + t) % t } }, { key: "version", get: function () { return pe } }]), n }(he); void 0 !== e && (e.BaseGauge = xe, e.gauges = (window.document || {}).gauges = ke); var Te = { roundRect: c, padValue: h, formatMajorTickNumber: u, radians: f, radialPoint: m, linearGradient: v, drawNeedleShadow: g, drawValueBox: k, verifyError: s, prepareTicks: d, drawShadow: b, font: p, normalizedValue: x }, Se = Math.PI, We = Se / 2, Oe = Object.assign({}, ge, { ticksAngle: 270, startAngle: 45, colorNeedleCircleOuter: "#f0f0f0", colorNeedleCircleOuterEnd: "#ccc", colorNeedleCircleInner: "#e8e8e8", colorNeedleCircleInnerEnd: "#f5f5f5", needleCircleSize: 10, needleCircleInner: !0, needleCircleOuter: !0, needleStart: 20, animationTarget: "needle", useMinPath: !1, barWidth: 0 }), Ve = function (e) { function t(e) { return o(this, t), e = Object.assign({}, Oe, e || {}), i(this, (t.__proto__ || Object.getPrototypeOf(t)).call(this, t.configure(e))) } return r(t, e), ce(t, [{ key: "draw", value: function () { try { var e = this.canvas, i = [-e.drawX, -e.drawY, e.drawWidth, e.drawHeight], r = i[0], o = i[1], n = i[2], a = i[3], l = this.options; if ("needle" === l.animationTarget) { if (!e.elementClone.initialized) { var s = e.contextClone; s.clearRect(r, o, n, a), s.save(), this.emit("beforePlate"), W(s, l), this.emit("beforeHighlights"), O(s, l), this.emit("beforeMinorTicks"), V(s, l), this.emit("beforeMajorTicks"), M(s, l), this.emit("beforeNumbers"), j(s, l), this.emit("beforeTitle"), C(s, l), this.emit("beforeUnits"), N(s, l), e.elementClone.initialized = !0 } this.canvas.commit(), e.context.clearRect(r, o, n, a), e.context.save(), e.context.drawImage(e.elementClone, r, o, n, a), e.context.save(), this.emit("beforeProgressBar"), R(e.context, l), this.emit("beforeValueBox"), _(e.context, l, I(this)), this.emit("beforeNeedle"), E(e.context, l) } else { var d = -Te.radians((l.value - l.minValue) / (l.maxValue - l.minValue) * l.ticksAngle); if (e.context.clearRect(r, o, n, a), e.context.save(), this.emit("beforePlate"), W(e.context, l), e.context.rotate(d), this.emit("beforeHighlights"), O(e.context, l), this.emit("beforeMinorTicks"), V(e.context, l), this.emit("beforeMajorTicks"), M(e.context, l), this.emit("beforeNumbers"), j(e.context, l), this.emit("beforeProgressBar"), R(e.context, l), e.context.rotate(-d), e.context.save(), !e.elementClone.initialized) { var c = e.contextClone; c.clearRect(r, o, n, a), c.save(), this.emit("beforeTitle"), C(c, l), this.emit("beforeUnits"), N(c, l), this.emit("beforeNeedle"), E(c, l), e.elementClone.initialized = !0 } e.context.drawImage(e.elementClone, r, o, n, a) } this.emit("beforeValueBox"), _(e.context, l, I(this)), se(t.prototype.__proto__ || Object.getPrototypeOf(t.prototype), "draw", this).call(this) } catch (e) { Te.verifyError(e) } return this } }, { key: "value", set: function (e) { e = xe.ensureValue(e, this.options.minValue), this.options.animation && 360 === this.options.ticksAngle && this.options.useMinPath && (this._value = e, e = this.options.value + ((e - this.options.value) % 360 + 540) % 360 - 180), de(t.prototype.__proto__ || Object.getPrototypeOf(t.prototype), "value", e, this) }, get: function () { return se(t.prototype.__proto__ || Object.getPrototypeOf(t.prototype), "value", this) } }], [{ key: "configure", value: function (e) { return e.barWidth > 50 && (e.barWidth = 50), isNaN(e.startAngle) && (e.startAngle = 45), isNaN(e.ticksAngle) && (e.ticksAngle = 270), e.ticksAngle > 360 && (e.ticksAngle = 360), e.ticksAngle < 0 && (e.ticksAngle = 0), e.startAngle < 0 && (e.startAngle = 0), e.startAngle > 360 && (e.startAngle = 360), e } }]), t }(xe); void 0 !== e && (e.RadialGauge = Ve), xe.initialize("RadialGauge", Oe); var Pe = Object.assign({}, ge, { borderRadius: 0, barBeginCircle: 30, colorBarEnd: "", colorBarProgressEnd: "", needleWidth: 6, tickSide: "both", needleSide: "both", numberSide: "both", ticksWidth: 10, ticksWidthMinor: 5, ticksPadding: 5, barLength: 85, fontTitleSize: 26, highlightsWidth: 10 }), Me = function (e) { function n(e) { return o(this, n), e = Object.assign({}, Pe, e || {}), i(this, (n.__proto__ || Object.getPrototypeOf(n)).call(this, n.configure(e))) } return r(n, e), ce(n, [{ key: "draw", value: function () { try { var e = this.canvas, i = [-e.drawX, -e.drawY, e.drawWidth, e.drawHeight], r = i[0], o = i[1], a = i[2], l = i[3], s = this.options; if (!e.elementClone.initialized) { var d = e.contextClone; d.clearRect(r, o, a, l), d.save(), this.emit("beforePlate"), this.drawBox = L(d, s, r, o, a, l), this.emit("beforeBar"), X.apply(void 0, [d, s].concat(t(this.drawBox))), e.context.barDimensions = d.barDimensions, this.emit("beforeHighlights"), q(d, s), this.emit("beforeMinorTicks"), K(d, s), this.emit("beforeMajorTicks"), $(d, s), this.emit("beforeNumbers"), Q(d, s), this.emit("beforeTitle"), ee(d, s), this.emit("beforeUnits"), te(d, s), e.elementClone.initialized = !0 } this.canvas.commit(), e.context.clearRect(r, o, a, l), e.context.save(), e.context.drawImage(e.elementClone, r, o, a, l), e.context.save(), this.emit("beforeProgressBar"), U.apply(void 0, [e.context, s].concat(t(this.drawBox))), this.emit("beforeNeedle"), ie(e.context, s), this.emit("beforeValueBox"), ae.apply(void 0, [e.context, s, s.animatedValue ? this.options.value : this.value].concat(t(this.drawBox))), se(n.prototype.__proto__ || Object.getPrototypeOf(n.prototype), "draw", this).call(this) } catch (e) { Te.verifyError(e) } return this } }], [{ key: "configure", value: function (e) { return e.barStrokeWidth >= e.barWidth && (e.barStrokeWidth = we(e.barWidth / 2)), e.hasLeft = Y("right", e), e.hasRight = Y("left", e), e.value > e.maxValue && (e.value = e.maxValue), e.value < e.minValue && (e.value = e.minValue), xe.configure(e) } }]), n }(xe); void 0 !== e && (e.LinearGauge = Me), xe.initialize("LinearGauge", Pe), "undefined" != typeof module && Object.assign(e, { Collection: l, GenericOptions: ge, Animation: me, BaseGauge: xe, drawings: Te, SmartCanvas: be, DomObserver: ve, vendorize: n })
    }("undefined" != typeof module ? module.exports : window);</script>

  <!-- required javscript for the timer timepickers-->
  <script>
    /***********************************************
       Included from timepicker.js
    ***********************************************/
    /*
    * Directly Draggable Analog Clock Timepicker
    *
    * Design by ZulNs @Yogyakarta, February 2016
    *
    * Revised on 25 February 2019:
    *    - Drops timepicker.css
    *    - Adds/changes clock theme
    *    - Changes some public methods
    */
    //'use strict';
    function Timepicker(isClk, is24H, isLight, hour, minute, size) {
      if (size == undefined)
        scale = 1;
      else
        scale = size;
      isClk = !!isClk;
      is24H = !!is24H;
      isLight = !!isLight;
      hour = hour == undefined ? Timepicker.getHours() : ~~hour % 24;
      minute = minute == undefined ? Timepicker.getMinutes() : ~~minute % 60;
      let self = this,
        tpick = document.createElement('div'),
        clkFace = document.createElement('canvas'),
        hourHand = document.createElement('canvas'),
        minuteHand = document.createElement('canvas'),
        secondHand = document.createElement('canvas'),
        timeStr = document.createElement('div'),
        //		pickBtn=document.createElement('button'),
        isHidden = true,
        isPM = hour >= 12,
        isHourHand,
        isReverseRotate,
        isDragging = false,
        isFiredByMouse = false,
        touchId,
        lastHourDeg,
        lastMinuteDeg,
        centerX,
        centerY,
        cssTransform = Timepicker.getSupportedTransformProp(),
        timerId,
        second = Timepicker.getSeconds(),
        BGcolor = '#000',
        hrcolor = 'ffffff',
        callbackFn = null,
        onMouseDown = function (e) {
          if (!isDragging) {
            e = e || window.event;
            e.preventDefault();
            e.stopPropagation();
            isFiredByMouse = true;
            isHourHand = e.target == hourHand;
            onPtrStart(e.pageX, e.pageY)
          }
        },
        onMouseMove = function (e) {
          if (isDragging && isFiredByMouse) {
            e = e || window.event;
            e.preventDefault();
            onPtrMove(e.pageX, e.pageY)
          }
        },
        onMouseUp = function (e) {
          if (isDragging && isFiredByMouse) {
            e = e || window.event;
            e.preventDefault();
            isDragging = false
          }
        },
        onTouchStart = function (e) {
          e = e || window.event;
          if (isDragging && !isFiredByMouse && e.touches.length == 1) isDragging = false;
          if (!isDragging) {
            let touch = e.changedTouches[0];
            e.preventDefault();
            //e.stopPropagation();
            isFiredByMouse = false;
            touchId = touch.identifier;
            isHourHand = touch.target == hourHand;
            onPtrStart(touch.pageX, touch.pageY)
          }
        },
        onTouchMove = function (e) {
          if (isDragging && !isFiredByMouse) {
            e = e || window.event;
            let touches = e.changedTouches, touch;
            for (let i = 0; i < touches.length; i++) {
              touch = touches[i];
              if (touch.identifier == touchId) {
                e.preventDefault();
                onPtrMove(touch.pageX, touch.pageY);
                break
              }
            }
          }
        },
        onTouchEnd = function (e) {
          if (isDragging && !isFiredByMouse) {
            e = e || window.event;
            let touches = e.changedTouches, touch;
            for (let i = 0; i < touches.length; i++) {
              touch = touches[i];
              if (touch.identifier == touchId) {
                e.preventDefault();
                isDragging = false;
                return
              }
            }
          }
        },
        onPtrStart = function (x, y) {
          isDragging = true;
          centerX = tpick.offsetLeft + hourHand.offsetLeft + 10 * scale;
          centerY = tpick.offsetTop + hourHand.offsetTop + 70 * scale;
          let last = isHourHand ? lastHourDeg : lastMinuteDeg,
            deg = -Math.atan2(centerX - x, centerY - y) * 180 / Math.PI,
            dif = Math.abs(deg - last);
          isReverseRotate = (160 < dif && dif < 200)
        },
        onPtrMove = function (x, y) {
          let deg, last, target;
          if (x != centerX || y != centerY) {
            deg = -Math.atan2(centerX - x, centerY - y) * 180 / Math.PI;
            if (isReverseRotate) deg = deg - 180;
            if (deg < 0) deg += 360;
            target = isHourHand ? hourHand : minuteHand;
            rotateElm(target, deg);
            if (isHourHand) {
              if ((0 <= deg && deg < 90 && 270 < lastHourDeg && lastHourDeg < 360) || (0 <= lastHourDeg && lastHourDeg < 90 && 270 < deg && deg < 360)) isPM = !isPM;
              lastHourDeg = deg;
              lastMinuteDeg = deg % 30 * 12;
              rotateElm(minuteHand, lastMinuteDeg)
            } else {
              if ((270 < lastMinuteDeg && lastMinuteDeg < 360 && 0 <= deg && deg < 90) || (270 < deg && deg < 360 && 0 <= lastMinuteDeg && lastMinuteDeg < 90)) {
                lastHourDeg = lastHourDeg + (deg - lastMinuteDeg - Timepicker.sign(deg - lastMinuteDeg) * 360) / 12;
                if (lastHourDeg < 0) lastHourDeg += 360;
                lastHourDeg %= 360;
                if (345 < lastHourDeg || lastHourDeg < 15) isPM = !isPM
              } else {
                lastHourDeg = lastHourDeg + (deg - lastMinuteDeg) / 12;
                if (lastHourDeg < 0) lastHourDeg += 360;
                lastHourDeg %= 360
              }
              lastMinuteDeg = deg;
              rotateElm(hourHand, lastHourDeg)
            }
            minute = 6 * lastHourDeg / 180;
            hour = ~~minute;
            minute = Math.floor((minute - hour) * 60);
            if (isPM) hour += 12;
            updPickedTm()
          }
          if (callbackFn != null) {
            callbackFn();
          }
        },
        onPick = function () {
          self.hide();
          if (typeof self.onPicked == 'function') self.onPicked()
        },
        updPickedTm = function () {
          timeStr.innerText = getTmStr()
        },
        updClkTm = function () {
          second = Timepicker.getSeconds();
          if (isClk) timerId = setTimeout(updClkTm, 1e3 - Timepicker.getMillis());
          if (second == 0) {
            minute = Timepicker.getMinutes();
            hour = Timepicker.getHours();
            updPickedTm()
          }
          updClkPtrs()
        },
        updClkPtrs = function () {
          let sec = second * 6;
          lastMinuteDeg = (minute + sec / 360) * 6;
          lastHourDeg = (hour % 12 + lastMinuteDeg / 360) * 30;
          rotateElm(hourHand, lastHourDeg);
          rotateElm(minuteHand, lastMinuteDeg);
          rotateElm(secondHand, sec)
        },
        getTmStr = function () {
          let s = ('0' + (is24H ? hour : hour % 12 == 0 ? 12 : hour % 12)).slice(-2) + ':' + ('0' + minute).slice(-2);
          if (!is24H) s += ' ' + (isPM ? 'PM' : 'AM');
          return s
        },
        rotateElm = function (elm, deg) { elm.style[cssTransform] = 'rotate(' + deg + 'deg)' },
        scrollToFix = function () {
          let dw = document.body.offsetWidth,
            vw = window.innerWidth,
            vh = window.innerHeight,
            rect = tpick.getBoundingClientRect(),
            hsSpc = dw > vw ? 20 * scale : 0,
            scrollX = rect.left < 0 ? rect.left : 0,
            scrollY = rect.bottom - rect.top > vh ? rect.top : rect.bottom > vh - hsSpc ? rect.bottom - vh + hsSpc : 0;
          window.scrollBy(scrollX, scrollY)
        },
        addEvts = function () {
          Timepicker.addEvent(hourHand, 'mousedown', onMouseDown);
          Timepicker.addEvent(minuteHand, 'mousedown', onMouseDown);
          Timepicker.addEvent(document, 'mousemove', onMouseMove);
          Timepicker.addEvent(document, 'mouseup', onMouseUp);
          if ('touchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0) {
            Timepicker.addEvent(hourHand, 'touchstart', onTouchStart);
            Timepicker.addEvent(hourHand, 'touchmove', onTouchMove);
            Timepicker.addEvent(hourHand, 'touchcancel', onTouchEnd);
            Timepicker.addEvent(hourHand, 'touchend', onTouchEnd);
            Timepicker.addEvent(minuteHand, 'touchstart', onTouchStart);
            Timepicker.addEvent(minuteHand, 'touchmove', onTouchMove);
            Timepicker.addEvent(minuteHand, 'touchcancel', onTouchEnd);
            Timepicker.addEvent(minuteHand, 'touchend', onTouchEnd)
          }
        },
        remEvts = function () {
          Timepicker.removeEvent(hourHand, 'mousedown', onMouseDown);
          Timepicker.removeEvent(minuteHand, 'mousedown', onMouseDown);
          Timepicker.removeEvent(document, 'mousemove', onMouseMove);
          Timepicker.removeEvent(document, 'mouseup', onMouseUp);
          if ('touchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0) {
            Timepicker.removeEvent(hourHand, 'touchstart', onTouchStart);
            Timepicker.removeEvent(hourHand, 'touchmove', onTouchMove);
            Timepicker.removeEvent(hourHand, 'touchcancel', onTouchEnd);
            Timepicker.removeEvent(hourHand, 'touchend', onTouchEnd);
            Timepicker.removeEvent(minuteHand, 'touchstart', onTouchStart);
            Timepicker.removeEvent(minuteHand, 'touchmove', onTouchMove);
            Timepicker.removeEvent(minuteHand, 'touchcancel', onTouchEnd);
            Timepicker.removeEvent(minuteHand, 'touchend', onTouchEnd)
          }
        },
        create = function () {
          // Initialize
          clkFace.setAttribute('width', 240 * scale);
          clkFace.setAttribute('height', 240 * scale);
          hourHand.setAttribute('width', 20 * scale);
          hourHand.setAttribute('height', 90 * scale);
          minuteHand.setAttribute('width', 12 * scale);
          minuteHand.setAttribute('height', 110 * scale);
          secondHand.setAttribute('width', 8 * scale);
          secondHand.setAttribute('height', 120 * scale);
          console.log("Timepicker create, scale=" + scale + " clkFace=" + clkFace.width + "," + clkFace.height);
          clkFace.style.cssText = 'position:absolute;left:0px;top:0px';
          if (scale == 1) {
            tpick.style.cssText = 'position:relative;width:240px';
            hourHand.style.cssText = 'position:absolute;left:110px;top:50px;transform-origin:50% 70px';
            minuteHand.style.cssText = 'position:absolute;left:114px;top:30px;transform-origin:50% 90px';
            secondHand.style.cssText = 'position:absolute;left:116px;top:30px;transform-origin:50% 90px';
            timeStr.style.cssText = 'position:absolute;left:60px;top:248px;width:120px;text-align:center;font:24px Verdana;cursor:default';
          } else {
            tpick.style.cssText = 'position:relative;width:120px';
            hourHand.style.cssText = 'position:absolute;left:55px;top:25px;transform-origin:50% 35px';
            minuteHand.style.cssText = 'position:absolute;left:57px;top:15px;transform-origin:50% 45px';
            secondHand.style.cssText = 'position:absolute;left:58px;top:15px;transform-origin:50% 45px';
            timeStr.style.cssText = 'position:absolute;left:30px;top:124px;width:60px;text-align:center;font:16px Verdana;cursor:default';
          }
          //		pickBtn.style.cssText='position:absolute;left:90px;top:288px;width:60px;height:32px;font:18px Verdana;cursor:pointer';
          //		pickBtn.innerHTML='Pick';
          tpick.style.display = 'none';
          tpick.appendChild(clkFace);
          tpick.appendChild(hourHand);
          tpick.appendChild(minuteHand);
          tpick.appendChild(secondHand);
          tpick.appendChild(timeStr);
          //		tpick.appendChild(pickBtn);
          if (scale == 1)
            tpick.style.height = isClk ? '240px' : '320px';
          else
            tpick.style.height = isClk ? '120px' : '160px';
          if (isClk) {
            //			timeStr.style.display=pickBtn.style.display='none';
            updClkTm();
          }
          else {
            addEvts();
            Timepicker.setCursor(hourHand, true);
            Timepicker.setCursor(minuteHand, true);
            secondHand.style.display = 'none'
          }
          //		Timepicker.addEvent(pickBtn,'click',onPick);
          updClkPtrs();
          updPickedTm();
          setClkTheme();
        },
        setClkTheme = function () {
          // Create clock surface
          let ctx = clkFace.getContext('2d');
          ctx.strokeStyle = isLight ? '#000' : '#fff';
          ctx.beginPath();
          ctx.arc(120 * scale, 120 * scale, 119 * scale, 0, 2 * Math.PI);
          ctx.stroke();
          let radGrd = ctx.createRadialGradient(120 * scale, 120 * scale, 1, 120 * scale, 120 * scale, 120 * scale);
          radGrd.addColorStop(0, isLight ? '#e7e7e7' : BGcolor);
          radGrd.addColorStop(1, isLight ? '#fff' : '#171717');
          ctx.fillStyle = radGrd;
          ctx.beginPath();
          ctx.arc(120 * scale, 120 * scale, 118 * scale, 0, 2 * Math.PI);
          ctx.fill();
          ctx.translate(120 * scale, 120 * scale);
          ctx.fillStyle = isLight ? '#000' : '#fff';
          for (let i = 0; i < 12; i++) {
            ctx.beginPath();
            ctx.arc(0, -110 * scale, 2, 0, 2 * Math.PI);
            ctx.fill();
            ctx.rotate(Math.PI / 30);
            for (let j = 0; j < 4; j++) {
              ctx.beginPath();
              ctx.arc(0, -110 * scale, 1, 0, 2 * Math.PI);
              ctx.fill();
              ctx.rotate(Math.PI / 30);
            }
          }
          if (scale == 1)
            ctx.font = '18px Verdana';
          else
            ctx.font = '9px Verdana';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          for (let i = 1; i <= 12; i++) {
            ctx.fillText(i, 94 * scale * Math.sin(i * Math.PI / 6), -94 * scale * Math.cos(i * Math.PI / 6));
          }
          ctx.translate(-120 * scale, -120 * scale);
          // Create hour hand
          ctx = hourHand.getContext('2d');
          //		ctx.fillStyle=isLight?'#000':'#2196F3';
          ctx.fillStyle = isLight ? '#000' : hrcolor;
          ctx.beginPath();
          ctx.moveTo(10 * scale, 0);
          ctx.lineTo(0, 90 * scale);
          ctx.lineTo(20 * scale, 90 * scale);
          ctx.lineTo(10 * scale, 0);
          ctx.fill();
          // Create minute hand
          ctx = minuteHand.getContext('2d');
          ctx.fillStyle = isLight ? '#7f7f7f' : '#ffeb3b';
          ctx.beginPath();
          ctx.moveTo(6 * scale, 0);
          ctx.lineTo(0, 110 * scale);
          ctx.lineTo(12 * scale, 110 * scale);
          ctx.lineTo(6 * scale, 0);
          ctx.fill();
          ctx.fillStyle = '#000';
          ctx.beginPath();
          ctx.arc(6 * scale, 90 * scale, 2 * scale, 0, 2 * Math.PI);
          ctx.fill();
          // Create second hand
          ctx = secondHand.getContext('2d');
          ctx.fillStyle = '#f44336';
          ctx.beginPath();
          ctx.moveTo(4 * scale, 0);
          ctx.lineTo(0, 120 * scale);
          ctx.lineTo(8 * scale, 120 * scale);
          ctx.lineTo(4 * scale, 0);
          ctx.fill();
          ctx.fillStyle = '#000';
          ctx.beginPath();
          ctx.arc(4 * scale, 90 * scale, 2 * scale, 0, 2 * Math.PI);
          ctx.fill()
        };
      this.setCallback = function (fn) {
        callbackFn = fn;
      };
      this.setTextColor = function (color) {
        timeStr.style.color = color;
      }
      this.attachTo = function (el) { if (el.appendChild && !tpick.parentNode) { el.appendChild(tpick); return true } return false };
      this.destroy = function () {
        tpick.remove();
        self = null
      };
      this.updClkPtrs = function () {  // RLJ added this.
        let sec = second * 6;
        lastMinuteDeg = (minute + sec / 360) * 6;
        lastHourDeg = (hour % 12 + lastMinuteDeg / 360) * 30;
        rotateElm(hourHand, lastHourDeg);
        rotateElm(minuteHand, lastMinuteDeg);
        rotateElm(secondHand, sec)
      };
      this.getElement = function () { return tpick };
      this.getHours = function () { return hour };
      this.getMinutes = function () { return minute };
      this.getTime = function () { return hour * 36e5 + minute * 6e4 };
      this.getTimeString = function () { return getTmStr() };
      this.hide = function () {
        if (!isHidden) {
          isHidden = !isHidden;
          tpick.style.display = 'none';
        }
      };
      this.is24Hour = function () { return is24H };
      this.isClockMode = function () { return isClk };
      this.isHidden = function () { return isHidden };
      this.isLightTheme = function () { return isLight };
      this.onPicked;
      this.set24Hour = function (h) {
        if (typeof h == 'boolean' && h != is24H) {
          is24H = h;
          updPickedTm()
        }
      };
      this.setClockMode = function (m) {
        if (typeof m == 'boolean' && m != isClk) {
          isClk = m;
          Timepicker.setCursor(hourHand, !isClk);
          Timepicker.setCursor(minuteHand, !isClk);
          secondHand.style.display = isClk ? '' : 'none';
          //			timeStr.style.display=pickBtn.style.display=isClk?'none':'';
          tpick.style.height = isClk ? '240px' : '320px';
          if (isClk) {
            remEvts();
            hour = Timepicker.getHours();
            minute = Timepicker.getMinutes();
            updClkTm();
            updPickedTm()
          } else {
            second = 0;
            window.clearInterval(timerId);
            addEvts()
          }
        }
      };
      this.setHours = function (h) {
        if (!isClk && !isNaN(h)) {
          hour = parseInt(h) % 24;
          second = 0;
          isPM = hour >= 12;
          updClkPtrs();
          updPickedTm()
          console.log("setHours()" + BGcolor);
        }
      };
      this.setLightTheme = function (t) {
        if (typeof t == 'boolean' && t != isLight) {
          isLight = t;
          setClkTheme();
        }
      };
      this.setMinutes = function (m) {
        if (!isClk && !isNaN(m)) {
          minute = parseInt(m) % 60;
          second = 0;
          updClkPtrs();
          updPickedTm()
        }
      };
      this.show = function () {
        if (typeof tpick.parentNode == 'undefined') { alert("Timepicker element hasn't attached yet!"); return; }
        if (isHidden) {
          isHidden = !isHidden;
          tpick.style.display = '';
          scrollToFix()
        }
      };
      this.setBGcolor = function (rgb) {
        BGcolor = rgb;
        setClkTheme();
      };
      this.setHrcolor = function (rgb) {
        hrcolor = rgb;
        setClkTheme();
      };
      if (!cssTransform) {
        self.destroy();
        alert("Sorry, your browser doesn't support CSS transform!");
        return
      }
      if (!clkFace.getContext) {
        self.destroy();
        alert("Sorry, your browser doesn't support HTML canvas!");
        return
      }
      create()
    }
    Timepicker.addEvent = function (el, ev, cb) {
      if (window.addEventListener) el.addEventListener(ev, cb);
      else el.attachEvent('on' + ev, cb)
    };
    Timepicker.removeEvent = function (el, ev, cb) {
      if (window.addEventListener) el.removeEventListener(ev, cb);
      else el.detachEvent('on' + ev, cb)
    };
    Timepicker.setCursor = function (e, p) { e.style.cursor = p ? 'pointer' : 'default' };
    Timepicker.getSupportedTransformProp = function () {
      let props = ['transform', 'MozTransform', 'WebkitTransform', 'msTransform', 'OTransform'],
        root = document.documentElement;
      for (let i = 0; i < props.length; i++)
        if (props[i] in root.style) return props[i];
      return null
    };
    Timepicker.tzOffset = Date.parse('01 Jan 1970');
    Timepicker.getTime = function () { return (Date.now() - Timepicker.tzOffset) % 864e5 };
    Timepicker.getHours = function () { return parseInt(Timepicker.getTime() / 36e5) };
    Timepicker.getMinutes = function () { return parseInt(Timepicker.getTime() / 6e4) % 60 };
    Timepicker.getSeconds = function () { return parseInt(Timepicker.getTime() / 1e3) % 60 };
    Timepicker.getMillis = function () { return Timepicker.getTime() % 1e3 };
    Timepicker.sign = function (n) {
      if (isNaN(n)) return NaN;
      if (n == 0) return 0;
      if (n < 0) return -1;
      return 1
    };
  </script>

  <!--MQTT javascript library - LOADED FROM INTERNET, only as a MQTT client -->
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"></script>
  <!-- vars for our javascript -->
  <script>
    /***********************************************
       Included from vars.js
    ***********************************************/
    var TESTING = false;
    var TESTING = true;
    //if true, divs are not hidden with no connection
    var webVer = "V3.3.1";
    var webDate = "03 April 21";
    //All available JSON variables are initialised here, they will be updated upon connection to the controller
    //var blueWireStat = "";

    var json = {
      Thermostat: 0,
      GPin1: undefined,
      GPin2: undefined,
      GPout1: undefined,
      GPout2: undefined,
      GPanlg: undefined,
      GPmodeIn1: undefined,
      GPmodeIn2: undefined,
      GPmodeOut1: undefined,
      GPmodeOut2: undefined,
      GPOutThr1: 0,
      GPOutThr2: 0,
      GPmodeAnlg: undefined,
      inputVoltage: 12.0,
      LowVoltCutout: 0,
      GlowVoltage: 0,
      GlowCurrent: 0,
      FanRPM: 0,
      FanMin: 1600,
      FanMax: 4500,
      ErrorString: "E-00: OK",
      DateTime: "",
      CyclicTemp: 0,
      CyclicOn: 0,
      CyclicOff: 0,
      IQuery: 1,
      MEn: 0,
      MHost: "",
      MPasswd: "",
      MPort: 0,
      MUser: "",
      MQuery: 1,
      MTopic: "",
      NVsave: 4682,
      PumpActual: 7,
      PumpCal: 0,
      PumpCount: 0,
      PumpFixed: 0,
      PumpMax: 4,
      PumpMin: 2,
      PumpPrime: 0,
      Reboot: 0,
      Refresh: 1,
      RunState: 0,
      RunString: "Stopped/Standby",
      SQuery: 1,
      SystemVoltage: "12",
      TempBody: 0,
      TempCurrent: 24,
      TempDesired: 20,
      TempMax: 35,
      TempMin: 8,
      TempMode: 0,  // 0: Celsius, 1: Fahrenheit
      ThermostatMethod: 0, //0 conventional
      ThermostatWindow: 0,
      TQuery: 1,
      TimerConflict: 0,
      TimerDays: "None",
      TimerRefresh: 1,
      TimerRepeat: "",
      TimerStart: "",
      TimerStop: "",
    };

    // memory for held off fuel, cyclic & frost mode adjustments
    var working = {
      PumpMin: 0,
      PumpMax: 0,
      FanMin: 0,
      FanMax: 0,
      CyclicOn: 0,
      CyclicOff: 0,
      CyclicTemp: 0,
      FrostOn: 0,
      FrostRise: 0,
    };

    const NVsave = 4682;

    const Limits = {
      Window: {
        //Thermostat Window Range 0.2 - 10
        Min: 0.2,
        Max: 10,
      },
      CyclicOn: {
        Min: -20, //cyclic mode under range -20->0
        Max: 0,
      },
      CyclicOff: {
        Min: 2, //cyclic mode over range 2->10
        Max: 10,
      },
    };
    //Constants
    const degreeC = "℃"; /*"ºc";   //"℃"; */
    const degreeF = "℉"; /*//"ꜰ" not compatible mobile "ғ" is compatible; */
    var degreeSymbol = degreeC;
    // Colors
    var markerColorSent = "rgb(0,0,255)"; //Temperature marker on gauge when we send data - Blue
    var markerColorReceived = "rgb(255,128,0)"; //Temperature marker on gauge when we receive data - Orange
    var markerColorWindow = "rgba(0,255,0,.7)"; //Window Color - Green
    var markerCyclicUnder = "rgba(255,0,0,.7)"; //Cyclic Under - Red
    var markerCyclicOver = "rgba(255,0,0,.7)"; //Cyclic Over - Red
    var buttonColorDefault = "#3b73ba"; //Default colour of the buttons background - grey
    var markerFrost = "rgba(0,0,255,.7)"; //Frost - Blue
    var markerFrostSpan = "rgba(0,255,255,.4)"; //Frost - Blue
    var buttonColorSent = "lightblue"; //Button color when we set
    var buttonColorReceived = "lightgreen"; //Button color when set by afterburner
    var buttonColorSelected = "yellow"; //Button color when we choose a button to set it up or down   This var only -> "rgb(255, 196, 196)";   ////IMPORTANT! spacing required rgb(255,_196,_196) else when we check if selected it won't match!
    var buttonColorPending = "salmon"; //Button color when we have changed a setting, but not yet updated
    var buttonColorLimit = "red"; //Button color when limit is reached

    // Socket & Timers
    var Socket = null; //var for Websocket connection, needs to be global other functions use it to see if the socket is open or not
    var sendTempDesiredTimeout;
    var sendThermWindowTimeout;
    var sendVoltCutTimeout;
    var clockTimeout;
    var cmd = {};
    var displayMode = 0; //used to determine what is displayed depending on runstate (Ready,Glowplug or Running)
    var cyclicModeText = "";
    var cyclicUpdate = false;
    var fuelRate = 0;
    var difference_ms;
    var buttonDelay = 2000;
    var startTimepicker;
    var stopTimepicker;
    var selectTimer = 1;


    // Vars for keyboard
    var keyboard = {
      String: "",
      Valid: false,
      Min: 0,
      Max: 0,
      ZeroOff: false,
      Decimal: 0,
      SendingButton: 0,
      Variable: 0,
      DecimalDoneFlag: 0,
      DecimalDoneCount: 0,
      NVSave: 1,
      Minus: false,
      Callback: null,
    };

    //Other vars
    var protected = 0;
    var rebootReq = 0;

    var WebServerIP = "192.168.4.1";

    // GPIO
    var GPOutMethod = [true, true];


    // MQTT vars
    var MQTTClient = {
      Instance: null,
      ReconnectTimeout: 2000,
      Host: "broker.hivemq.com",
      Port: 8000,  // websocket
      Username: "",
      Password: "",
      Enabled: 0,
      Connected: false,
    };</script>

  <!-- our javascript -->
  <script>
    /***********************************************
       Included from function.js
    ***********************************************/
    function WindowOnFocus() {
      // ensure the content is refreshed when the page comes back into focus
      // fixes bug if not vieweing browser and heater was stopped in the meantime
      // HTML elements showed 0 fan & pump, but gauges were stuck on old value
      console.log("ON FOCUS!!!");
      refreshJSON();
    }

    function refreshJSON() {
      sendJSON("Refresh", false); //get the current Afterburner status
      sendJSON("SQuery", false); //get the current Afterburner Date/Time
      sendJSON("IQuery", false); //get the Afterburner Network details.
      sendJSON("MQuery", false); //get the Afterburner MQTT details.
      var i;
      for (i = 1; i <= 14; i++) {
        json.TQuery = i;
        sendJSON("TQuery", false);
      }
    }

    function showLVCKeyboard() {
      if (json.SystemVoltage == 12) {
        openKeyboard("Low Voltage Cutout", "10.0", "12.5", true, 1, "LowVoltCutout", "LowVoltCutout", 1, 1);
      } else {
        openKeyboard("Low Voltage Cutout", "20.0", "25.0", true, 1, "LowVoltCutout", "LowVoltCutout", 1, 1);
      }
    }

    function openKeyboard(Title, Min, Max, zeroOff, decimal, sendingButton, sendVariable, sendNVsave, showRange, showminus, callback) {
      keyboard.Min = Min;
      keyboard.Max = Max;
      keyboard.ZeroOff = zeroOff;
      keyboard.Decimal = decimal;
      keyboard.DecimalDoneFlag = 0;
      keyboard.DecimalDoneCount = 0;
      keyboard.SendingButton = sendingButton;
      keyboard.Variable = sendVariable;
      keyboard.NVSave = sendNVsave;
      keyboard.VariableValue = json[keyboard.Variable];
      keyboard.Minus = showminus;

      if (callback) keyboard.Callback = callback;
      else keyboard.callback = null;

      _("keyboard").style.display = "inline-block";
      _("keyboardTitle").innerHTML = Title;
      if (showRange) {
        _("keyboardConstraints").style.display = "block";
        _("keyboardConstraints").innerHTML = (zeroOff) ? Min + "-" + Max + " & 0=OFF" : Min + " - " + Max;
      }
      else {
        _("keyboardConstraints").style.display = "none";
      }
      keyboard.String = "0"; //"";
      keyboard.Valid = true;
      // if(keyboard.ZeroOff) {
      //   keyboard.Valid = true;
      // } else {
      //   keyboard.Valid = false;
      // }
      _("keyboardClear").innerHTML = showminus ? "+/-" : "C";
      _("keyboardDisplay").innerHTML = keyboard.String;
      _("keyboardDecimalButton").disabled = decimal > 0 ? false : true; //decimal point allowed or not
      if (keyboard.Valid) {
        _("keyboardDisplay").style.backgroundColor = "grey";
        _("keyboardDisplay").style.color = "cyan";
        // _("keyboardDisplay").style.backgroundColor = buttonColorReceived;
        _("keyboardApply").style.backgroundColor = buttonColorReceived;
        _("keyboardApply").disabled = false;
      } else {
        // _("keyboardDisplay").style.backgroundColor = "yellow";
        _("keyboardDisplay").style.color = "red";
        _("keyboardApply").style.backgroundColor = "yellow";
        _("keyboardApply").disabled = true;
      }
    }

    function keyboardButton(key) {
      switch (key) {
        case "C":
          if (keyboard.Minus) {
            if (keyboard.String.charAt(0) == "-") {
              keyboard.String = keyboard.String.substring(1);
            }
            else {
              keyboard.String = "-" + keyboard.String;
            }
          }
          else {
            if (keyboard.String.length > 0) {
              var temp = keyboard.String.substring(keyboard.String.length - 1, keyboard.String.length);
              if (temp == ".") {
                keyboard.DecimalDoneFlag = false;
                keyboard.DecimalDoneCount = 0;
              }
              keyboard.String = keyboard.String.substring(0, keyboard.String.length - 1);
              if (keyboard.DecimalDoneFlag) {
                keyboard.DecimalDoneCount -= 1;
              }
            } else {
              return;
            }
          }
          break;
        case ".":
          if (keyboard.String.length >= keyboard.Max.length) {
            return;
          } //string is already the length of Max Value to don't add another character
          if (keyboard.DecimalDoneFlag) {
            return; // no more decimals
          } else {
            keyboard.DecimalDoneFlag = true;
            keyboard.String = keyboard.String + "."; //add the decimal point
          }
          break;
        default:
          if (keyboard.String.length >= keyboard.Max.length) {
            return;
          } //string is already the length of Max Value to don't add another character
          if (!keyboard.DecimalDoneFlag) {
            if (keyboard.String == "0") {
              keyboard.String = key;
            } else {
              keyboard.String = keyboard.String + key;
            }
          } else if (keyboard.DecimalDoneCount < keyboard.Decimal) {
            keyboard.String = keyboard.String + key;
            keyboard.DecimalDoneCount += 1;
          }
          break;
      }
      if (keyboard.String == "") {
        keyboard.String = "0";
      }
      _("keyboardDisplay").innerHTML = keyboard.String;
      //Now check if valid
      if (keyboard.String != "" && Number(keyboard.String) == 0 && keyboard.ZeroOff) {
        keyboard.Valid = true;
      } else if (Number(keyboard.String) >= keyboard.Min && Number(keyboard.String) <= keyboard.Max) {
        keyboard.Valid = true;
      } else {
        keyboard.Valid = false;
      }
      if (keyboard.Valid) {
        _("keyboardDisplay").style.backgroundColor = "grey";
        _("keyboardApply").style.backgroundColor = "yellow";
        _("keyboardApply").disabled = false;
      } else {
        _("keyboardDisplay").style.color = "red";
        _("keyboardApply").style.backgroundColor = "salmon";
        _("keyboardApply").disabled = true;
      }
    }

    function applyKeyboard() {
      if (keyboard.VariableValue != Number(keyboard.String)) {

        if (keyboard.ZeroOff && Number(keyboard.String) == 0) { //if this key has 0=OFF, then change button text to "off"
          _(keyboard.SendingButton).innerHTML = "OFF";
        } else {
          _(keyboard.SendingButton).innerHTML = keyboard.String;
        }

        if (keyboard.Callback != null) {
          keyboard.Callback(Number(keyboard.String));
        }
        else {
          _(keyboard.SendingButton).style.backgroundColor = buttonColorSent;
          json[keyboard.Variable] = Number(keyboard.String); //set the JS variable related to the key to the value of the entered string
          sendJSON(keyboard.Variable, keyboard.NVSave); //goto the function to send the data to the afterburner
        }
      }
      closeKeyboard();
    }

    function closeKeyboard() {
      _("keyboard").style.display = "none";
    }

    function checkButtonPendingColor(key) {
      _(key).style.color = (working[key] == json[key]) ? "black" : buttonColorPending;
    }


    //Common CMD Send Function - constructs values to send to the afterburner
    //key = Javascript variable for equivalent JSON Key (JS lowercase first letter, JSON uppercase first letter)
    function sendCMD(key, NVSAVE) {
      console.log("sendCMD - key:" + key + " NVSAVE: " + NVSAVE);
      cmd = {};
      cmd[firstUppercase(key)] = window[key]; //window replaces "key" with the value in the variable named "key"
      if (NVSAVE) {
        cmd.NVsave = NVsave;
      }
      sendJSONobject(cmd);
    }

    const firstUppercase = (s) => {
      if (typeof s !== 'string')
        return '';
      return s.charAt(0).toUpperCase() + s.slice(1);
    };

    function sendJSON(key, NVSAVE) {
      console.log("sendJSON - key:" + key + " NVSAVE: " + NVSAVE);
      cmd = {};
      cmd[key] = json[key];
      if (NVSAVE) {
        cmd.NVsave = json.NVsave;
      }
      sendJSONobject(cmd);
    }

    function sendJSONobject(obj) {
      var str = JSON.stringify(obj);
      console.log("JSON Tx:", str);
      if (MQTTClient.Enabled != 0) {
        MQTTsend(str);
      }
      else {
        if (Socket && Socket != null) {
          console.log("Socket variable exists");
          if (Socket.readyState === Socket.OPEN) {
            Socket.send(str);
            console.log("Socket open JSON Tx sent!");
          } else {
            console.error("Socket not open JSON Tx not sent!");
          }
        }
      }
    }


    var cellwidth = 580 / 25;
    var cellheight = 30;
    var buttonCount = 0;

    function draw() {
      drawAxis();
      drawTimers();
    }

    function drawAxis() {
      for (var i = 0; i < 24; i++) {
        //drawabutton(i+1,i*20,15,5); //label,x,y,width,height
        drawabutton(i + 1, (i + 1) * cellwidth, 0, cellwidth, cellheight, "lightgrey", true, false); //label,x,y,width,height,color,axis,grid
      }
      var weekdays = ["Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"];
      for (var i = 0; i < 7; i++) {
        drawabutton(weekdays[i], 0, (i + 1) * cellheight, cellwidth, cellheight, "lightgrey", true, false); //label,x,y,width,height,color,axis,grid
      }
    }

    function drawTimers() {
      var startTime = "1:00";
      var endTime = "23:59";
      start = timeStringToFloat(startTime);
      end = timeStringToFloat(endTime);
      calculateabutton(1, 0, start, end, "yellow");
      var startTime = "10:00";
      var endTime = "24:00";
      start = timeStringToFloat(startTime);
      end = timeStringToFloat(endTime);
      calculateabutton(1, 1, start, end, "yellow"); // one off timer yellow
      var startTime = "23:40";
      var endTime = "23:59";
      start = timeStringToFloat(startTime);
      end = timeStringToFloat(endTime);
      calculateabutton(2, 2, start, end, "orange"); //repeating timer orange
    }

    function timeStringToFloat(time) {
      var hoursMinutes = time.split(/[.:]/);
      var hours = parseInt(hoursMinutes[0], 10);
      var minutes = hoursMinutes[1] ? parseInt(hoursMinutes[1], 10) : 0;
      return hours + minutes / 60;
    }

    function calculateabutton(timer, day, start, end, color) {
      label = timer;
      x = start * cellwidth + cellwidth / 2;
      y = day * cellheight + cellheight;
      width = Math.ceil((end - start) * cellwidth);
      if (width < cellwidth) {
        width = cellwidth;
        if (x + width > 25 * cellwidth) {
          x = 24 * cellwidth - cellwidth / 2;
        }
      }
      height = cellheight;
      drawabutton(label, x, y, width, height, color, false, false);
    }

    function drawabutton(label, x, y, width, height, color, axis, grid) {
      //x=100;
      //y=10;
      var newBtn;
      if (axis) {
        newBtn = document.createElement("DIV");
        newBtn.style.textAlign = "center";
        newBtn.style.lineHeight = Math.min(cellwidth, cellheight) * 1.3 + "px";
        newBtn.innerHTML = label;
      } else {
        newBtn = document.createElement("BUTTON");
        buttonCount++;
        newBtn.id = "timerButton" + buttonCount;
        newBtn.innerHTML = label;
        newBtn.setAttribute("onclick", "doalert(" + buttonCount + ")");
        newBtn.style.border = "1px solid black";
        newBtn.style.borderRadius = "12px";
      }
      newBtn.style.backgroundColor = color;
      newBtn.style.position = "absolute";
      newBtn.style.top = y + "px";
      newBtn.style.left = x + "px";
      newBtn.style.width = width + "px";
      newBtn.style.height = height + "px";
      newBtn.style.padding = "0px";
      newBtn.style.fontSize = Math.min(cellwidth, cellheight) / 1.7 + "px";
      var outsideDiv = _("divTimers");
      //var insideDiv = _("b");
      //outsideDiv.insertBefore(newBtn, insideDiv);
      //insertAfter(newBtn, outsideDiv);
      outsideDiv.append(newBtn);
    }

    function removeTimerButtons() {
      var elem;
      for (i = 1; i <= buttonCount; i++) {
        elem = _("timerButton" + i);
        elem.remove();
      }
      buttonCount = 0;
    }

    //*********************************************************************************************
    function _(el) {
      return document.getElementById(el);
    }

    function clickTempGauge() {
      //alert("You clicked the canvas!");
      _("divOnOff").style.display = "inline-block";
    }

    function closePopupOnOff() {
      //alert("Cancelled");
      _("divOnOff").style.display = "none";
    }

    function clickFuelText() {
      //alert("You clicked the fuel!");
      _("divResetFuel").style.display = "inline-block";
    }

    function resetFuelConsumption() {
      json.PumpCount = 0;
      sendJSON("PumpCount", true);
      _("divResetFuel").style.display = "none";
    }

    function closePopupFuel() {
      //alert("Cancelled");
      _("divResetFuel").style.display = "none";
    }

    function closeStartPopup() {
      _("divStartWarning").style.display = "none";
    }

    function updateTempBodyGaugeDesign() {
      var minvalue, maxvalue;
      _('textTempBodyGauge').innerHTML = "Body " + cOrF(json.TempBody, 0, 0) + degreeSymbol; //update the label
      if (!json.TempMode) { //if celsius or fahrenheit, these ar just labels, we still send to the gauge the Celsius value.
        minvalue = 0;
        maxvalue = 250;
        majorticks = ["0", "50", "100", "150", "200", "250"];
      } else {
        minvalue = 0; // = -17C
        maxvalue = 500; // = 204C
        majorticks = ["0", "100", "200", "300", "400", "500"];
      }
      bodytempgauge.update({
        value: cOrF(json.TempBody, 1, 0),
        minValue: minvalue,
        maxValue: maxvalue,
        majorTicks: majorticks,
        highlights: [ //add background blue yellow red using celsius values soit is consistant if C or F
          {
            "from": minvalue,
            "to": cOrF(20, 1, 0),
            "color": "rgba(0,0,255,.2)"
          }, //Blue a0.2
          {
            "from": cOrF(20, 1, 0),
            "to": cOrF(40, 1, 0),
            "color": "rgba(0,255,0,.3)"
          }, //Green a0.3
          {
            "from": cOrF(40, 1, 0),
            "to": cOrF(60, 1, 0),
            "color": "rgba(0,255,0,.5)"
          }, //Green a0.5
          {
            "from": cOrF(60, 1, 0),
            "to": cOrF(80, 1, 0),
            "color": "rgba(255,165,0,.3)"
          }, //Orange a0.2
          {
            "from": cOrF(80, 1, 0),
            "to": cOrF(100, 1, 0),
            "color": "rgba(255,165,0,.5)"
          }, //Orange a0.4
          {
            "from": cOrF(100, 1, 0),
            "to": cOrF(120, 1, 0),
            "color": "rgba(255,0,0,.3)"
          }, //Red a0.2
          {
            "from": cOrF(120, 1, 0),
            "to": cOrF(225, 1, 0),
            "color": "rgba(255,0,0,.5)"
          }, //Red a0.4
          {
            "from": cOrF(225, 1, 0),
            "to": maxvalue,
            "color": "rgba(192,0,0,1)"
          } //Deep Red a0.4
        ]
      });
    }

    function doChangeOfTempMode() {
      _("buttonC").style.backgroundColor = json.TempMode ? buttonColorDefault : buttonColorReceived;
      _("buttonC").disabled = json.TempMode ? false : true;
      _("buttonF").style.backgroundColor = json.TempMode ? buttonColorReceived : buttonColorDefault;
      _("buttonF").disabled = json.TempMode ? true : false;
      degreeSymbol = json.TempMode ? degreeF : degreeC;
      updateDataText();
      updateTempGaugeHighlights(1);
      updateTempBodyGaugeDesign();
      _("ThermostatWindow").innerHTML = cOrF(json.ThermostatWindow, 1, 1) + degreeSymbol;
      _('CyclicTemp').innerHTML = cOrF(json.CyclicTemp, 0, 0) + degreeSymbol;
      _("CyclicOn").innerHTML = cOrF(json.CyclicOn + json.CyclicTemp, 1, 1) + degreeSymbol + " (" + cOrF(json.CyclicOn, 1, 1) + ")";
      _("CyclicOff").innerHTML = cOrF(json.CyclicOff + json.CyclicTemp, 1, 1) + degreeSymbol + " (" + cOrF(json.CyclicOff, 1, 1) + ")";
      setTimerUI();
    }

    function changeDegreeSymbol(button) {
      _("buttonC").style.backgroundColor = button ? buttonColorDefault : buttonColorSent;
      _("buttonC").disabled = button ? false : true;
      _("buttonF").style.backgroundColor = button ? buttonColorSent : buttonColorDefault;
      json.TempMode = button ? 1 : 0; //C
      sendJSON("TempMode", false);
    }

    function changeSystemVoltage(button, mode) {
      if (button == 12) { //12v
        _("button12").disabled = true;
        _("button24").style.backgroundColor = buttonColorDefault;
        _("button24").disabled = false;
        if (mode) { //if received
          _("button12").style.backgroundColor = buttonColorReceived;
          return;
        } else { //if sent by button
          _("button12").style.backgroundColor = buttonColorSent;
          json.SystemVoltage = 12;
        }
      } else { // 24v selected
        _("button12").disabled = false;
        _("button12").style.backgroundColor = buttonColorDefault;
        _("button24").disabled = true;
        if (mode) { //if received
          _("button24").style.backgroundColor = buttonColorReceived;
          return;
        } else { //if sentby button
          _("button24").style.backgroundColor = buttonColorSent;
          json.SystemVoltage = 24;
        }
      }
      sendJSON("SystemVoltage", true);
    }

    function cOrF(degree, digits, offset) {
      if (!json.TempMode) {  // Ceclius
        return parseFloat(degree).toFixed(digits);
      } else {
        if (!offset) {
          return parseFloat(degree * 9 / 5 + 32).toFixed(digits);
        } else {
          return parseFloat(degree * 9 / 5).toFixed(digits);
        }
      }
    }
    function invCorF(degree, digits, offset) {
      if (!json.TempMode) {  // Ceclius
        return parseFloat(degree).toFixed(digits);
      } else {
        if (!offset) {
          return parseFloat((degree - 32) * 5 / 9).toFixed(digits);
        } else {
          return parseFloat(degree * 5 / 9).toFixed(digits);
        }
      }
    }

    function openFirmwareUpdatePage() {
      if (confirm("Leave this index.htm\nOpen the firmware update webpage?")) {
        if (window.location.hostname === "") {  // testing via file
          var spoofedURL = "http://" + WebServerIP + "/update";
          location.assign(spoofedURL);
        }
        else {
          location.assign("/update");
        }
      }
    }

    function openRebootPage() {

      if (json.Reboot) {  // check if AB has sent a JSON reboot payload - indicates the feature is supported
        rebootReq = 1;
        json["Reboot"] = 0;
        sendJSON("Reboot", false);
        setTimeout(
          function () {
            rebootReq = 0;
          },
          2000);
      }
      else {
        if (Socket != null && Socket.readyState === Socket.OPEN) {
          if (window.location.hostname === "") {  // testing via file
            var spoofedURL = "http://" + WebServerIP + "/reboot";
            location.assign(spoofedURL);
          }
          else {
            location.assign("/reboot");
          }
        }
        else {
          if (MQTTClient.Enabled == true) {
            alert("The connected Challenger firmware does not support reboot over MQTT\r\n\nPlease update the Challenger firmware to at least V3.2");
          }
          else {
            alert("Cannot reboot Challenger when running from a file without a valid IP address");
          }
        }
      }
    }

    function divsHide() { // hide divs if no connection       // if TESTING true, don't hide divs with no connection
      if (!TESTING) {
        _("menu").style.display = "none";
        _("HomePage").style.display = "none";
        protected = false;
        enableProtected2(); //on entry it toggles the value, so it becomes true & sets the up/down fan/pump buttons to hidden
      }
    }

    function divsShow() { // show divs with socketconnection
      _("menu").style.display = "block";
      _("HomePage").style.display = "grid";
    }

    function adjustLowVolt(dir) {
      var lowVoltMin = json.SystemVoltage == 12 ? 10 : 20;
      var lowVoltMax = json.SystemVoltage == 12 ? 12.5 : 25;
      json.LowVoltCutout = (parseFloat(json.LowVoltCutout) + dir).toFixed(1);
      if (dir < 0 && json.LowVoltCutout < lowVoltMin && json.LowVoltCutout > 0) {
        json.LowVoltCutout = 0;  // jump to off if decremented below minimum
      }
      if (dir > 0 && json.LowVoltCutout > 0 && json.LowVoltCutout < lowVoltMin) {
        json.LowVoltCutout = lowVoltMin; // jump to on in incremented up from off
      }
      var atLimit = false;
      if (json.LowVoltCutout > lowVoltMax) {
        json.LowVoltCutout = lowVoltMax;
        atLimit = true;
      }
      if (json.LowVoltCutout < 0) {
        json.LowVoltCutout = 0;
        atLimit = true;
      }
      if (atLimit) {
        _("LowVoltCutout").style.backgroundColor = buttonColorLimit;
        setTimeout(
          function () {
            _("LowVoltCutout").style.backgroundColor = buttonColorReceived;
          },
          buttonDelay);
      } else {
        updateButtonLowVolt(0); //update the button value & color
        sendVoltCut(); //send the data to the afterburner
      }
    }

    function updateButtonLowVolt(mode) {
      var lowVoltText = json.LowVoltCutout == 0 ? "OFF" : parseFloat(json.LowVoltCutout).toFixed(1) + "V";
      _("LowVoltCutout").innerHTML = lowVoltText;
      _("LowVoltCutout").style.backgroundColor = mode ? buttonColorReceived : buttonColorSent;
    }

    function sendVoltCut() {
      clearTimeout(sendVoltCutTimeout); //if clicked again within 700ms, we reset our send data timer
      sendVoltCutTimeout = setTimeout(
        function () {
          sendJSON("LowVoltCutout", true);
        },
        700); //if quickly changing we wait 700ms then send the data to the afterburner
    }

    function onCyclicUpdate() {
      _("divCyclicAdj").style.display = "none";
      //alert("sendCyclicUpdate " + working.CyclicOff + " " + json.CyclicOff);
      cyclicUpdate = false;
      if ((working.CyclicTemp != json.CyclicTemp) ||
        (working.CyclicOn != json.CyclicOn) ||
        (working.CyclicOff != json.CyclicOff)) {
        resetCyclicButtons(0);
        conditionalSend("CyclicOn");
        conditionalSend("CyclicOff");
        conditionalSend("CyclicTemp");
        sendCMD("NVsave", false);
      }
      else {
        resetCyclicButtons(0);
      }
    }

    function resetCyclicButtons(mode) {
      var button;
      var hasConnection = (Socket && Socket != null) || (MQTTClient.Instance && MQTTClient.Instance != null);
      button = (hasConnection && mode) ? buttonColorReceived : buttonColorSent;
      _("CyclicOn").style.backgroundColor = button;
      _("CyclicOff").style.backgroundColor = button;
      _("CyclicTemp").style.backgroundColor = button;
      _("divCyclicAdj").style.display = "none";
      if (!mode) {
        if (working.CyclicTemp == json.CyclicTemp) {
          _("CyclicTemp").style.backgroundColor = buttonColorReceived;
          _("CyclicTemp").style.color = "black";
        }
        if (working.CyclicOn == json.CyclicOn) {
          _("CyclicOn").style.backgroundColor = buttonColorReceived;
          _("CyclicOn").style.color = "black";
        }
        if (working.CyclicOff == json.CyclicOff) {
          _("CyclicOff").style.backgroundColor = buttonColorReceived;
          _("CyclicOff").style.color = "black";
        }
      }
    }

    function adjCyclic(key, dir, limits) {
      working[key] += dir;
      var atLimit = false;
      if (working[key] > limits.Max) {
        working[key] = limits.Max;
        atLimit = true;
      }
      if (working[key] < limits.Min) {
        working[key] = limits.Min;
        atLimit = true;
      }
      // var button = key;
      if (atLimit) {
        _(key).style.color = buttonColorLimit;
        setTimeout(
          function () {
            checkButtonPendingColor(key);
          },
          buttonDelay);
      }
      else {
        checkButtonPendingColor(key);
      }
      _(key).innerHTML = cOrF(working[key] + working.CyclicTemp, 1, 1) + degreeSymbol + " (" + cOrF(working[key], 1, 1) + ")";
    }

    function onCyclicAdj(dir) {
      if (_("CyclicOn").style.backgroundColor == buttonColorSelected) {
        adjCyclic("CyclicOn", dir, Limits.CyclicOn);
      } else {
        adjCyclic("CyclicOff", dir, Limits.CyclicOff);
      }

      selectiveShowCyclicUpdate();
    }

    function selectiveShowCyclicUpdate() {

      var unsaved = (working.CyclicTemp != json.CyclicTemp) ||
        (working.CyclicOff != json.CyclicOff) ||
        (working.CyclicOn != json.CyclicOn);
      // Frost is not available with earlier than AB V3.1.9, a bit different handling
      // 
      if (json.FrostOn != undefined)
        unsaved |= (working.FrostOn != json.FrostOn);
      if (json.FrostRise != undefined)
        unsaved |= (working.FrostRise != json.FrostRise);

      _("divThermoUpdate").style.visibility = unsaved ? "visible" : "hidden";
      _("btnThermoUpdate").style.color = "black";
      _("btnThermoUpdate").style.backgroundColor = "salmon";
    }

    function onCyclicBlur(id) {
      blurredCyclic = id;
      console.log("onCylicBlur");
    }

    function onFocusCyclicAdj() {
      setCyclicElements(blurredCyclic);
      console.log("onFocusCyclicAdj");
    }

    function onButtonCyclicOn() {
      setFrostElements(0);  // cancel possible frost mode selection
      _("CyclicOn").style.backgroundColor = buttonColorSelected;
      _("CyclicOff").style.backgroundColor = buttonColorReceived;
      _("divCyclicAdj").style.display = "block";
    }

    function onButtonCyclicOff() {
      setFrostElements(0);  // cancel possible frost mode selection
      _("CyclicOn").style.backgroundColor = buttonColorReceived;
      _("CyclicOff").style.backgroundColor = buttonColorSelected;
      _("divCyclicAdj").style.display = "block";
    }

    function setCyclicElements(sel) {
      blurredCyclic = sel;
      _("divCyclicAdj").style.display = "block";
      _("CyclicOn").style.backgroundColor = buttonColorReceived;
      _("CyclicOff").style.backgroundColor = buttonColorReceived;
      if (sel == 1)
        _("CyclicOn").style.backgroundColor = buttonColorSelected;
      if (sel == 2)
        _("CyclicOff").style.backgroundColor = buttonColorSelected;

      checkButtonPendingColor("CyclicOn");
      checkButtonPendingColor("CyclicOff");

      if (sel == 0) {
        _("divCyclicAdj").style.display = "none";
      }
    }

    function buttonCyclicEnbDis(onoff, mode) {
      //Update buttonCyclicOff value
      _("CyclicOff").innerHTML = cOrF(json.CyclicOff + json.CyclicTemp, 1, 1) + degreeSymbol + " (" + cOrF(json.CyclicOff, 1, 1) + ")";
      //Update Button is hidden for all modes except off - we turn on
      if (onoff) { // on button pushed or overtemp>1 so afterburner has sent on
        if (mode) { // data received from afterburner to turn om so set colors to buttonColorReceived
          _("disableCyclic").style.backgroundColor = buttonColorDefault;
          _("enableCyclic").style.backgroundColor = buttonColorReceived;
          _("enableCyclic").disabled = true; //disable the on button since we are now on
          _("disableCyclic").disabled = false; //enable the off button since we are now on
          _("CyclicOn").style.backgroundColor = buttonColorReceived;
          _("CyclicOn").style.color = "black";
          _("CyclicOff").style.backgroundColor = buttonColorReceived;
          _("CyclicOff").style.color = "black";
          _("CyclicTemp").style.backgroundColor = buttonColorReceived;
          updateTempGaugeHighlights(1);
          //alert("buttonCyclicEnbDis");
          working.CyclicTemp = json.CyclicTemp;
          //alert("on " + working.CyclicTemp + " " + json.CyclicTemp);
        } else { // we initiated on - so change json.CyclicOff from 0 to 2
          //alert("we initiated ON!");`
          _("disableCyclic").style.backgroundColor = buttonColorReceived;
          _("CyclicOff").style.color = buttonColorPending;
          _("CyclicOff").style.backgroundColor = buttonColorReceived;
          _("enableCyclic").style.backgroundColor = buttonColorReceived;
          _("CyclicOn").style.backgroundColor = buttonColorReceived;
          _("CyclicTemp").style.backgroundColor = buttonColorReceived;
          cyclicUpdate = true;
          working.CyclicOff = 2;
          working.CyclicOn = json.CyclicOn;
          working.CyclicTemp = json.CyclicTemp;
          //alert("on " + working.CyclicTemp + " " + json.CyclicTemp);
          _("CyclicOff").innerHTML = cOrF(working.CyclicOff + working.CyclicTemp, 1, 1) + degreeSymbol + " (" + cOrF(working.CyclicOff, 1, 1) + ")";
        }
        //On Off
        _("disableCyclic").disabled = false;
        _("enableCyclic").disabled = true;
        //Cyclic Ref
        _("divCyclicUpDownText").style.visibility = "visible";
        _("divCyclicUpDownValues").style.visibility = "visible";
        //Cyclic Window On/Off values
        _("divCyclicWindowText").style.visibility = "visible";
        _("divCyclicWindowValues").style.visibility = "visible";
        _("divCyclicAdj").style.display = "none";

      } else { // off button pushed or json.CyclicOff = 0 sent
        if (mode) { // data received so set colors to buttonColorReceived
          _("disableCyclic").style.backgroundColor = buttonColorReceived;
          _("enableCyclic").style.backgroundColor = buttonColorDefault;
          _("disableCyclic").disabled = true; //disable the off button since we are now off
          _("enableCyclic").disabled = false; //enable the on button since we are now off
          updateTempGaugeHighlights(1);
          cyclicUpdate = false;
        } else { // we have initiated off so set OverTemp to 0 & send it immediately to tell afterburner cyclic is off
          _("CyclicOn").style.backgroundColor = buttonColorDefault;
          if (!cyclicUpdate) {
            _("disableCyclic").style.backgroundColor = buttonColorSent;
          } else {
            _("disableCyclic").style.backgroundColor = buttonColorReceived;
            _("enableCyclic").style.backgroundColor = buttonColorDefault;
          }
          json.CyclicOff = 0;
          sendJSON("CyclicOff", true);
          cyclicUpdate = false;
        }
        //On Off
        _("disableCyclic").disabled = true;
        _("enableCyclic").disabled = false;
        //Cyclic Ref
        _("divCyclicUpDownText").style.visibility = "hidden";
        _("divCyclicUpDownValues").style.visibility = "hidden";
        //Cyclic Window On/Off values
        _("divCyclicWindowText").style.visibility = "hidden";
        _("divCyclicWindowValues").style.visibility = "hidden";
      }
      selectiveShowCyclicUpdate();
    }

    function onBlurFrost(id) {
      blurredFrost = id;
      console.log("onBlurFrost");
    }

    function onFocusFrostAdj() {
      setFrostElements(blurredFrost);
      console.log("onFrostFocus");
    }

    function onButtonFrostOn() {
      setCyclicElements(0);
      setFrostElements(1);
      _("FrostOn").style.backgroundColor = buttonColorSelected;
      _("divFrostAdj").style.display = "block";
    }

    function onButtonFrostRise() {
      setCyclicElements(0);
      setFrostElements(2);
      _("FrostRise").style.backgroundColor = buttonColorSelected;
      _("divFrostAdj").style.display = "block";
    }


    function onFrostUpDown(dir) {

      function adjFrostKey(key) {
        var atLimit = false;
        working[key] += dir;
        if (working[key] > 30) {
          working[key] = 30;
          atLimit = true;
        }
        if (working[key] < 0) {
          working[key] = 0;
          atLimit = true;
        }
        if (atLimit) {
          _(key).style.color = buttonColorLimit;
          setTimeout(
            function () {
              checkButtonPendingColor(key);
            },
            buttonDelay);
        }
        else {
          checkButtonPendingColor(key);
        }
      }
      if (_("FrostOn").style.backgroundColor == buttonColorSelected) {
        adjFrostKey("FrostOn");
        setFrostElements(1);
      } else {
        adjFrostKey("FrostRise");
        setFrostElements(2);
      }
      updateTempGaugeHighlights(1);
      selectiveShowCyclicUpdate();
    }

    function setFrostElements(sel) {
      blurredFrost = sel;
      if (json.FrostOn != undefined) {
        if (sel == 1)
          _("FrostOn").style.backgroundColor = buttonColorSelected;
        else
          _("FrostOn").style.backgroundColor = buttonColorReceived;
        _("FrostOn").innerHTML = (working.FrostOn == 0) ? "Disabled" : cOrF(working.FrostOn, 1, 1) + degreeSymbol;
        _("FrostRise").style.visibility = (working.FrostOn == 0) ? "hidden" : "visible";
        if (json.FrostRise != undefined) {
          if (sel == 2)
            _("FrostRise").style.backgroundColor = buttonColorSelected;
          else
            _("FrostRise").style.backgroundColor = buttonColorReceived;
          _("FrostRise").innerHTML = (working.FrostRise == 0) ? "User stop" : cOrF(working.FrostOn + working.FrostRise, 1, 1) + degreeSymbol;
        }
      }
      if (sel == 0) {
        _("divFrostAdj").style.display = "none";
      }
      selectiveShowCyclicUpdate();
    }

    function onThermoUpdate() {
      _("btnThermoUpdate").style.backgroundColor = buttonColorSent;
      onFrostUpdate();
      onCyclicUpdate();
      _("btnThermoUpdate").style.backgroundColor = buttonColorDefault;
      _("divThermoUpdate").style.visibility = "hidden";
    }

    function onFrostUpdate() {
      // check for unchanged values (won't be echoed by AB)
      _("FrostOn").style.backgroundColor = (working.FrostOn == json.FrostOn) ? buttonColorReceived : buttonColorSent;
      _("FrostRise").style.backgroundColor = (working.FrostRise == json.FrostRise) ? buttonColorReceived : buttonColorSent;
      _("divFrostAdj").style.display = "none";

      conditionalSend("FrostOn");
      conditionalSend("FrostRise");
    }

    function conditionalSend(key) {
      if (working[key] != json[key]) {
        // transfer new value into json store, but maintain difference by swapping the values.
        // when the Afterburner echoes back the new values the working values are
        // touched up and we reach equilibrium again
        var tmp = json[key];
        json[key] = working[key];
        working[key] = tmp;
        _(key).style.backgroundColor = buttonColorSent;
        sendJSON(key, false);
      }
      else {
        _(key).style.backgroundColor = buttonColorReceived;
      }
    }

    function lsTest() {
      var test = 'test';
      try {
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
      } catch (e) {
        return false;
      }
    }

    function lsLoad(ID, set) {
      if (localStorage[ID]) {
        if (ID.substring(0, 10) == "MQTTClient") {
          var key = ID.substring(10);
          MQTTClient[key] = localStorage[ID];
        }
        else {
          window[ID] = localStorage[ID];
        }
        if (set == 1)
          _(ID).style.backgroundColor = buttonColorReceived;
      }
    }

    function buttonCommMode(mode, init) {
      console.log("buttonCommMode");
      if (init) {
        MQTTClient.Enabled = 0;
        MQTTClient.Host = "broker.hivemq.com";
        MQTTClient.Port = 8000;  // websocket port on broker    
        MQTTClient.Password = "";
        MQTTClient.Username = "";
        MQTTClient.TopicPrefix = "Copy & Paste MQTT Key here";
        WebServerIP = "192.168.4.1";
        WebServerPort = 81;
        if (lsTest() == true) {
          // localStorage available
          console.log("localStorage is available");
          // use stored value, otherwise implant default
          lsLoad("MQTTClientEnabled", 0);
          lsLoad("MQTTClientHost", 1);
          lsLoad("MQTTClientPort", 1);
          lsLoad("MQTTClientUsername", 1);
          lsLoad("MQTTClientPassword", 1);
          lsLoad("MQTTClientTopicPrefix", 1);
          lsLoad("WebServerIP", 1);
          lsLoad("WebServerPort", 1);
          _("WarningNoLS").style.visibility = "hidden";
          _("WarningNoLS2").style.display = "none";
        } else {
          // unavailable
          console.log("localStorage is NOT available for MQTT client settings");
          _("WarningNoLS").style.visibility = "visible";
          _("WarningNoLS2").style.display = "block";
          _("WarningNoLS2").style.visibility = "visible";
        }
        console.log("MQTT enabled " + MQTTClient.Enabled);
        console.log("Broker " + MQTTClient.Host + ":" + MQTTClient.Port);
        console.log(MQTTClient.Username + "/" + MQTTClient.Password);
        _("MQTTClientHost").value = MQTTClient.Host;
        _("MQTTClientPort").value = MQTTClient.Port;
        _("MQTTClientPassword").value = MQTTClient.Password;
        _("MQTTClientUsername").value = MQTTClient.Username;
        _("MQTTClientTopicPrefix").value = MQTTClient.TopicPrefix;
        _("WebServerIP").value = WebServerIP;
        _("WebServerPort").value = WebServerPort;
      }
      else {
        // mode change via HTML interface
        MQTTClient.Enabled = mode;
        if (lsTest() == true) {
          localStorage["MQTTClientEnabled"] = MQTTClient.Enabled;
        }
        console.log("buttonCommMode MQTT client mode = " + MQTTClient.Enabled);
      }

      initComms();
    }

    function resizeScreen() {

      var gwidth = 100;
      var gheight = 100;
      var bwidth = 0;

      Wwidth = window.innerWidth;
      Wheight = window.innerHeight;
      console.log("screen=" + Wwidth + "," + Wheight);

      var aspect = Wwidth / Wheight;
      //const gridContainer = document.querySelector('.wrapper');
      if (aspect > 1) {
        gwidth = Wwidth * 0.25;
        bwidth = Wwidth * 0.3;
        gheight = 40 + Wwidth / 2 * 0.12;

        _("divDownUp").style.marginTop = "-5em";
        _("divLinearGauges").style.marginTop = "0em";//"-50px";

        _("a").style.marginTop = "-20px";
        _("b").style.marginTop = "-20px";
        _("c").style.marginTop = "-20px";

        _("solidbackkeyboard").style.fontSize = "2em";

      } else { // portrait
        gwidth = Wwidth * 0.7;
        bwidth = Wwidth * 0.6;
        gheight = 40 + Wwidth / 2 * 0.3;
        _("divDownUp").style.marginTop = "0em";
        _("divLinearGauges").style.marginTop = "-50px";
        _("a").style.marginTop = "10px";
        // _("b").style.marginTop = "0px"; // not required as spacing is good
        //_("c").style.marginTop = "0px";

        _("solidbackkeyboard").style.fontSize = "3em";

      }

      if (Wwidth < 600) {
        // set size of canvas for timer chart
        _("tmrCanvas").width = "290";
        _("tmrCanvas").height = "160";

        console.log("screen < 600, tmrCanvas= " + _("tmrCanvas").width + "," + _("tmrCanvas").height);
      }
      else {
        _("tmrCanvas").width = "580";
        _("tmrCanvas").height = "320";
        console.log("screen > 600, tmrCanvas= " + _("tmrCanvas").width + "," + _("tmrCanvas").height);
      }


      scale = 1;
      if (Wwidth < 600) {
        scale = 0.5;
      }
      else {  // > 600
        if (aspect > 1) {  // landscape
          if (Wwidth < 1000) {
            scale = 0.5;
          }
        }
      }
      createTimepickers(scale);

      setTimerUI();

      // gheight = 40 + Wwidth / 2 * 0.15;

      var fSize = gwidth / 5; /*aspect * 40 + 40; */
      var lSize = gwidth / 80 + 40;
      document.body.style.fontSize = fSize + "%";
      _("text").innerHTML = "gwidth: " + parseFloat(gwidth).toFixed(0) + " Width: " + Wwidth + " Height: " + Wheight + " Aspect: " + parseFloat(Wwidth / Wheight).toFixed(2);

      temperaturegauge.update(
        {
          width: gwidth,
          height: gwidth,
        }
      );

      rpmgauge.update(
        {
          width: bwidth,
          height: gheight,
          fontNumbersSize: lSize,
        }
      );

      pumpgauge.update(
        {
          width: bwidth,
          height: gheight,
          fontNumbersSize: lSize,
        }
      );

      bodytempgauge.update(
        {
          width: bwidth,
          height: gheight,
          fontNumbersSize: lSize,
        }
      );

    }

    function nudgeFuelSetting(key, value) {

      var tmp = parseFloat(working[key]);
      tmp += value;
      if (value == 0) {
        if (protected) {
          enableProtected();
        }
        else {
          // callback function. post entry of new fuel setting
          function onKeyboardDone(val) {
            working[key] = val;
            _(key).innerHTML = working[key];
            checkButtonPendingColor(key);
            updateFuelApplyButton();
          }

          if (key.substring(0, 4) == "Pump") {
            var title = "Pump " + key.substring(4);  // ie Pump Min or Pump Max
            //  openKeyboard(Title, Min, Max, zeroOff, decimal, sendingButton, sendVariable, sendNVsave, showRange, showminus, callback) {
            openKeyboard(title, '0.5', '8.0', false, 1, key, key, true, true, false, onKeyboardDone);
          }
          else {
            var title = "Fan " + key.substring(3);  // ie Pump Min or Pump Max
            openKeyboard(title, '500', '6000', false, 0, key, key, true, true, false, onKeyboardDone);
          }
        }
      }
      else if (value < 1 && value > -1) {
        working[key] = tmp.toFixed(1);
      }
      else {
        working[key] = tmp;
      }
      _(key).innerHTML = working[key];
      checkButtonPendingColor(key);

      updateFuelApplyButton();
    }

    function nudgeSetting(key, value) {
      var tmp = parseFloat(json[key]);
      tmp += value;
      if (value < 1)
        json[key] = Number(tmp.toFixed(1));
      else
        json[key] = Number(tmp);
    }

    function updateFuelApplyButton() {
      var pending = false;
      pending |= working.FanMin != json.FanMin;
      pending |= working.FanMax != json.FanMax;
      pending |= working.PumpMin != json.PumpMin;
      pending |= working.PumpMax != json.PumpMax;
      _("buttonUpdateFanPump").style.backgroundColor = pending ? buttonColorPending : buttonColorDefault;
      _("buttonUpdateFanPump").style.display = pending ? "block" : "none";
    }

    function updateFuelButton(key) {
      working[key] = json[key];
      _(key).innerHTML = json[key];
      _(key).style.backgroundColor = buttonColorReceived;
      _(key).style.color = "black";
      updateFuelApplyButton();
    }


    function sendFanPumpToHeater() {
      if (protected) {
        enableProtected();
      }
      else {
        _("buttonUpdateFanPump").style.backgroundColor = buttonColorSent;
        conditionalSend("FanMin");
        conditionalSend("FanMax");
        conditionalSend("PumpMin");
        conditionalSend("PumpMax");
        sendJSON("NVsave", false);
      }
    }

    function buttonThermSelect(select, mode) { //select = thermo button pushed mode=0 we have set it via web page, mode=1 afterburner has sent change to web page.
      var buttonColor;
      //button should go blue then green to slow after burner has received the change.
      _("buttonThermDirectHz").style.backgroundColor = buttonColorDefault; // lightgrey
      _("buttonThermoDefault").style.backgroundColor = buttonColorDefault;
      _("buttonThermoDeadband").style.backgroundColor = buttonColorDefault;
      _("buttonThermoLinearHz").style.backgroundColor = buttonColorDefault;
      _("buttonThermoStopStart").style.backgroundColor = buttonColorDefault;
      _("buttonThermoExternal").style.backgroundColor = buttonColorDefault;
      buttonColor = mode ? buttonColorReceived : buttonColorSent;
      //console.log("buttonColor" + buttonColor);
      switch (select) {
        case 1:
          if (json.Thermostat == 0) buttonColor = buttonColorReceived;
          json.Thermostat = 0;
          json.ThermostatMethod = 0; // not required for DIRECTHZ, but makes sure this variable has a valid number
          _("buttonThermDirectHz").style.backgroundColor = buttonColor;
          _("labelThermostatWindow").style.visibility = "hidden";
          _("buttonsThermostatWindow").style.visibility = "hidden";
          break;
        case 2:
          json.Thermostat = 1;
          if (json.ThermostatMethod == 0) buttonColor = buttonColorReceived;
          json.ThermostatMethod = 0;
          _("buttonThermoDefault").style.backgroundColor = buttonColor;
          _("labelThermostatWindow").style.visibility = "hidden";
          _("buttonsThermostatWindow").style.visibility = "hidden";
          break;
        case 3:
          json.Thermostat = 1;
          if (json.ThermostatMethod == 1) buttonColor = buttonColorReceived;
          json.ThermostatMethod = 1;
          _("buttonThermoDeadband").style.backgroundColor = buttonColor;
          _("labelThermostatWindow").style.visibility = "visible";
          _("buttonsThermostatWindow").style.visibility = "visible";
          break;
        case 4:
          json.Thermostat = 1;
          if (json.ThermostatMethod == 2) buttonColor = buttonColorReceived;
          json.ThermostatMethod = 2;
          _("buttonThermoLinearHz").style.backgroundColor = buttonColor;
          _("labelThermostatWindow").style.visibility = "visible";
          _("buttonsThermostatWindow").style.visibility = "visible";
          break;
        case 5:
          json.Thermostat = 1;
          if (json.ThermostatMethod == 4) buttonColor = buttonColorReceived;
          json.ThermostatMethod = 4;
          _("buttonThermoStopStart").style.backgroundColor = buttonColor;
          _("labelThermostatWindow").style.visibility = "visible";
          _("buttonsThermostatWindow").style.visibility = "visible";
          break;
        case 6:
          json.Thermostat = 1;
          if (json.ThermostatMethod == 3) buttonColor = buttonColorReceived;
          json.ThermostatMethod = 3;
          _("buttonThermoExternal").style.backgroundColor = buttonColor;
          _("labelThermostatWindow").style.visibility = "visible";
          _("buttonsThermostatWindow").style.visibility = "hidden";
          break;
      }
      if (!mode) { // web initiated request, send request to afterburner to set the themostat mode
        sendJSON("Thermostat", false);
        sendJSON("ThermostatMethod", true);
      }
    }


    function adjustThermWindow(dir) {
      json.ThermostatWindow += dir;
      var atLimit = false;
      if (json.ThermostatWindow < Limits.Window.Min) {
        json.ThermostatWindow = Limits.Window.Min;
        atLimit = true;
        //console.log("buttonThermWindowDown pressed, min " + Limits.Window.Min + " reached.");
      }
      if (json.ThermostatWindow > Limits.Window.Max) {
        json.ThermostatWindow = Limits.Window.Max;
        atLimit = true;
        //console.log("buttonThermWindowUp pressed, max " + Limits.Window.Max + " reached.");
      }
      if (atLimit) {
        _("ThermostatWindow").style.backgroundColor = buttonColorLimit;
        setTimeout(
          function () {
            _("ThermostatWindow").style.backgroundColor = buttonColorDefault;
          },
          buttonDelay);
      } else {
        //console.log("buttonThermWindowDown pressed new value ", json.ThermostatWindow.toFixed(1));
        updateButtonThermWindow(0); //update the button value & color
        sendThermWindowValue(); //send the data to the afterburner
      }
    }

    function updateButtonThermWindow(mode) {
      //console.log("buttonThermWindowUp pressed new value ", json.ThermostatWindow.toFixed(1));
      _("ThermostatWindow").innerHTML = cOrF(json.ThermostatWindow, 1, 1) + degreeSymbol;
      _("ThermostatWindow").style.backgroundColor = mode ? buttonColorReceived : buttonColorSent;
    }

    function updateButtonCyclicOn() { // used to update the cyclic under value from the afterburner
      updateTempGaugeHighlights(1);
      _("CyclicOn").innerHTML = cOrF(json.CyclicOn + json.CyclicTemp, 1, 1) + degreeSymbol + " (" + cOrF(json.CyclicOn, 1, 1) + ")";
      _("CyclicOn").style.backgroundColor = buttonColorReceived;
      _("CyclicOn").style.color = "black";
      selectiveShowCyclicUpdate();
    }

    function sendThermWindowValue() {
      clearTimeout(sendThermWindowTimeout); //if clicked again within 700ms, we reset our send data timer
      sendThermWindowTimeout = setTimeout(
        function () {
          sendJSON("ThermostatWindow", true);
        },
        700); //if quickly changing temp, we wait 700ms then send the data to the afterburner
    }


    //#displayhome
    function dispMenu(menu) {
      var SocketOK = Socket != null;
      if (SocketOK) {
        SocketOK = Socket.readyState === Socket.OPEN;
      }
      console.log("dispMenu " + menu);
      if (SocketOK || MQTTClient.Connected || TESTING == true) {
        // hide all pages
        _("HomePage").style.display = "none";
        _("ThermostatPage").style.display = "none";
        _("EnvironmentalPage").style.display = "none";
        _("FuelMixtureSettingsPage").style.display = "none";
        _("DateTimeSettingsPage").style.display = "none";
        _("SystemSettingsPage").style.display = "none";
        _("SystemFunctionsPage").style.display = "none";
        _("SystemDetailsPage").style.display = "none";
        _("CommsSettingsPage").style.display = "none";
        _("HelpPage").style.display = "none";
        _("myLinks").style.display = "none";

        // show the selected page
        _(menu).style.display = "grid";
        resizeScreen();

        if (menu == "DateTimeSettingsPage")
          onTimerSel();

        // ensure GPIO switches get resized according to current view
        redrawSwitches();
      }
    }

    function funcNavLinks() {
      var x = _("myLinks");
      x.style.display = x.style.display === "block" ? "none" : "block";
    }

    //#drawgauge
    var temperaturegauge = new RadialGauge(
      {
        renderTo: 'temperaturegauge',
        value: 0,
        minValue: 0,
        maxValue: 40,
        exactTicks: false,
        strokeTicks: false,
        minorTicks: 5,
        majorTicks: ["0", "5", "10", "15", "20", "25", "30", "35", "40"],
        colorMajorTicks: "#fff",
        colorMinorTicks: "#fff",
        colorNumbers: "#fff",
        fontNumbersSize: 13,
        numberSide: "left",
        // numbersMargin: "-15",
        fontNumbersWeight: "bold",
        highlights: [
      {
        "from": 0,
        "to": 5000,
        "color": "rgba(255,255,255,0)"
      }
    ], //transparent
        width: 400,
        height: 400,
        barWidth: 5,
        colorBar: "tomato",
        barShadow: 2,
        colorBarProgress: "#f5ed1c",
        colorPlate: "#232120",
        colorPlateEnd: "#5f5d5c",
        // title: "Desired ",
        colorTitle: "white",
        fontTitleSize: 18,
        fontUnitsSize: 15,
        fontUnitsWeight: "bold",
        units: "Current",
        colorUnits: "white",
        valueBox: true,
        colorValueBoxBackground: "",
        valueBoxStroke: 0,
        valueBoxBorderRadius: 0,
        // value: "deg",
        colorValueText: "#fff",
        fontValueWeight: "bold",
        fontValueSize: 47,
        valueInt: 0,
        valueDec: 0,
        borders: true,
        borderOuterWidth: 30,
        colorBorderOuter: "#080704",
        colorBorderOuterEnd: "#62605f",
        borderInnerWidth: "8",
        colorBorderInner: "#8c8989",
        colorBorderInnerEnd: "#000",
        colorBorderMiddle: "#52504f",
        colorBorderMiddleEnd: "#52504f",
        animatedValue: true,
        animationDuration: 1000,
        animationRule: "linear",
        ticksAngle: 300,
        startAngle: 29,
        colorNeedle: "#d00",
        colorNeedleShadowUp: "#eb2528",
        colorNeedleEnd: "#eb2528",
        needleCircleSize: "11",
        colorNeedleCircleInner: "#080604",
        colorNeedleCircleInnerEnd: "#747372",
        colorNeedleCircleOuter: "#080604",
        colorNeedleCircleInnerEnd: "#747372",
        needleShadow: false,
        needleWidth: "6",
        needleStart: "0",
        needleEnd: 60,
      }).draw();

   
var rpmgauge = new RadialGauge(
  {
    renderTo: 'rpmgauge',
    minValue: 0,
    maxValue: 5000,
    value: 0,
    valueBox: false,
    width: 375, //590
    height: 100,
    //title: "Heater Demand --%",
    //fontTitleSize: 80,
    // fontNumbersSize: 40,
    colorTitle: "#fff",
    colorNumbers: "#fff",
    majorTicks: ["0", "1k", "2k", "3k", "4k", "5k"],
    minorTicks: 5,
    fontNumbers: "40",
    numbersMargin: -25,
    colorMajorTicks: "#fff",
    colorMinorTicks: "#fff",
    strokeTicks: false,
    //fontUnitsSize: 200,
    colorPlate: "#232120",
    colorPlateEnd: "#5f5d5c",
    //borderShadowWidth: 0,
    borders: true,
    borderOuterWidth: "3",
    colorBorderOuter: "#62605f",
    colorBorderOuterEnd: "#62605f",
    borderMiddleWidth: "5",
    colorBorderInner: "#000",
    colorBorderInnerEnd: "#000",
    colorBorderMiddle: "#62605f",
    colorBorderMiddleEnd: "#62605f",
    barBeginCircle: false,
    colorBar: "#76c15a",
    tickSide: "left",
    ticksAngle: 300,
    startAngle: 29,
    numberSide: "left",
    needle: true,
    // needleType: "line",
    colorNeedle: "#65bc4b",
    colorNeedleEnd: "#65bc4b",
    colorNeedleShadowUp: "#65bc4b",
    colorNeedleShadowDown: "#65bc4b",
    needleCircleSize: "18",
    colorNeedleCircleInner: "#080604",
    colorNeedleCircleInnerEnd: "#747372",
    colorNeedleCircleOuter: "#080604",
    colorNeedleCircleInnerEnd: "#747372",
    needleShadow: false,
    needleStart: 0,
    needleEnd: 60,
    needleWidth: 9,
    animation: false,
    //colorNeedleEnd: "#F80",
    //animationDuration: 1000,
    //animationRule: "linear",
    //animationTarget: "plate",
    ticksWidth: 10,
    ticksWidthMinor: 5,
    colorBarProgress: "rgba(255,165,0,1)", //Orange 1
    colorBarProgressEnd: "rgba(255,0,0,1)", //Red 1
    barWidth: 10,
    highlights: [
      {
        "from": 0,
        "to": 5000,
        "color": "rgba(255,255,255,0)"
      }
    ], //transparent
  } ).draw();


    var pumpgauge = new RadialGauge(
      {
        renderTo: 'pumpgauge',
        minValue: 0,
        maxValue: 6,
        value: 0,
        width: 375, //590
        height: 100,
        // title: "Heater Demand --%",
        fontNumbers: 25,
        numbersMargin: -25,
        colorTitle: "#fff",
        colorNumbers: "#fff",
        majorTicks: [0, 1, 2, 3, 4, 5, 6],
        minorTicks: 5,
        strokeTicks: false,
        //fontUnitsSize: 200,
        colorPlate: "#555353", 
        colorPlateEnd: "#393837",
        //borderShadowWidth: 0,
        borders: true,
        borderOuterWidth: "3",
        colorBorderOuter: "#62605f",
        colorBorderOuterEnd: "#62605f",
        borderMiddleWidth: "5",
        colorBorderInner: "#000",
        colorBorderInnerEnd: "#000",
        colorBorderMiddle: "#62605f",
        colorBorderMiddleEnd: "#62605f",
        barBeginCircle: true,
        tickSide: "right",
        ticksAngle: 300,
        startAngle: 29,
        colorMajorTicks: "#fff",
        colorMinorTicks: "#fff",
        needle: true,
        // needleType: "line",
        needleStart: 0,
        needleEnd: 60,
        colorNeedle: "#a57db4",
        colorNeedleEnd: "#a57db4",
        colorNeedleShadowUp: "#a57db4",
        needleCircleSize: "18",
        colorNeedleCircleInner: "#080604",
        colorNeedleCircleInnerEnd: "#747372",
        colorNeedleCircleOuter: "#080604",
        colorNeedleCircleInnerEnd: "#747372",
        needleShadow: false,
        needleWidth: "9",
        animation: false,
        valueBox: false,
        //animationDuration: 1000,
        //animationRule: "linear",
        //animationTarget: "plate",
        // ticksWidth: 10,
        ticksWidthMinor: 5,
        colorBarProgress: "#a783b5", //Orange 1
        colorBarProgressEnd: "#a783b5", //Red 1
        colorBar: "#a57db4",
        barWidth: 10,
        highlights: [
          {
            "from": 1000,
            "to": 5000,
            "color": "rgba(255,255,255,0)"
          }
        ], //transparent
      }).draw();

    var bodytempgauge = new RadialGauge(
      {
        renderTo: 'bodytempgauge',
        minValue: 0,
        maxValue: 200,
        value: 0,
        width: 375, //590
        height: 100,
        //title: "Heater Demand --%",
        //fontTitleSize: 80,
        fontNumbersSize: 10,
        fontNumbers: 10,
        numbersMargin: -25,
        colorTitle: "black",
        colorNumbers: "#fff",
        majorTicks: [0, 50, 100, 150, 200],
        minorTicks: 5,
        colorMajorTicks: "#fff",
        colorMinorTicks: "#fff",
        strokeTicks: false,
        //fontUnitsSize: 200,
        colorPlate: "#555353", 
        colorPlateEnd: "#393837",
        //borderShadowWidth: 0,
        borders: true,
        borderOuterWidth: "3",
        colorBorderOuter: "#62605f",
        colorBorderOuterEnd: "#62605f",
        borderMiddleWidth: "5",
        colorBorderInner: "#000",
        colorBorderInnerEnd: "#000",
        colorBorderMiddle: "#62605f",
        colorBorderMiddleEnd: "#62605f",
        barBeginCircle: false,
        //tickSide: "left",
        numberSide: "left",
        valueBox: false,
        needle: true,
        //needleSide: "left",
        // needleType: "line",
        needleStart: 0,
        needleEnd: 60,
        needleWidth: 10,
        colorNeedle: "#83add9",
        colorNeedleEnd: "#83add9",
        colorNeedleShadowUp: "#83add9",
        needleCircleSize: "18",
        colorNeedleCircleInner: "#080604",
        colorNeedleCircleInnerEnd: "#747372",
        colorNeedleCircleOuter: "#080604",
        colorNeedleCircleInnerEnd: "#747372",
        needleShadow: false,
        animation: true,
        //animationDuration: 1000,
        //animationRule: "linear",
        //animationTarget: "plate",
        ticksAngle: 300,
        startAngle: 29,
        ticksWidth: 10,
        ticksWidthMinor: 5,
        colorBarProgress: "rgba(255,165,0,1)", //Orange 1
        colorBarProgressEnd: "rgba(255,0,0,1)", //Red 1
        barWidth: 10,
        colorBar: "#7aa2ca",
        colorBarEnd: "#7aa2ca",
        highlights: [
          {
            "from": 1000,
            "to": 5000,
            "color": "rgba(255,255,255,0)"
          }
        ],
      }).draw();


    function createTimepickers(scale) {
      if (startTimepicker) {
        startTimepicker.destroy();
        delete startTimepicker;
      }
      if (stopTimepicker) {
        stopTimepicker.destroy();
        delete stopTimepicker;
      }
      startTimepicker = new Timepicker(false, true, false, 0, 0, scale);
      stopTimepicker = new Timepicker(false, true, false, 0, 0, scale);
      _('starttimepicker').appendChild(startTimepicker.getElement());
      _('stoptimepicker').appendChild(stopTimepicker.getElement());
      _('starttimepicker').style.display = "inline-block";
      _('stoptimepicker').style.display = "inline-block";
      startTimepicker.setBGcolor('#00ff00');
      stopTimepicker.setBGcolor('#ff0000');
      startTimepicker.setHrcolor('#e0cb30');
      stopTimepicker.setHrcolor('#e0cb30');
      startTimepicker.setCallback(tmrStartCallback);
      stopTimepicker.setCallback(tmrStopCallback);
      startTimepicker.show();
      stopTimepicker.show();
      startTimepicker.onPicked = function () {
        this.show();
      };
      stopTimepicker.onPicked = function () {
        this.show();
      };
    }

    function init() {
      _('WebVer').innerHTML = webVer;
      _('WebDate').innerHTML = webDate;
      // initJSON();

      createTimepickers(1);

      divsHide(); //hide screen & pages until connection - note if TESTING = true they will not be hidden
      resizeScreen(); //Determine screen width, adjust page to suit
      //var canvas=document.getElementById("temperaturegauge");
      //var ctx=canvas.getContext("2d");
      //ctx.globalCompositeOperation='destination-over';
      if (typeof RadialGauge === 'undefined') { //If gauge JS not loaded show info screen regarding the gauge.js
        doNoGaugeJS();
      } else {
        buttonCommMode(0, 1);   // establish comms mode, by reading from localStorage, will call initComms() 
      }
      protected = false;    // will get toggled in enableProtected2()!
      enableProtected2();  // disable protected features that should require a password

      //TESTING ONLY BELOW
    }

    function initComms() {
      if (Socket && Socket != null) {
        console.log("initComms closing Socket");
        Socket.close();
        delete Socket;
        Socket = null;
      }
      if (MQTTClient.Instance && MQTTClient.Instance != null) {
        console.log("initComms closing MQTT");
        MQTTClient.Instance.disconnect();
        delete MQTTClient.Instance;
        MQTTClient.Instance = null;
      }
      console.log("Window location: " + window.location);
      if (window.location.hostname.indexOf("aclsretail.com\controller\mqtt") != -1) {
        console.log("index read from afterburner web site, forcing MQTT role");
        MQTTClient.Enabled = 1; // force MQTT mode
        _("WebServerIP").style.display = "none";
        _("WebServerPort").style.display = "none";
        _("LWebServerIP").style.display = "none";
        _("btnWebClient").style.display = "none";
      }
      else {
        if (window.location.hostname === "") {
          console.log("empty location, allowing user entry of webserver IP address");
        }
        _("WebServerIP").style.display = window.location.hostname === "" ? "block" : "none";
        _("WebServerPort").style.display = window.location.hostname === "" ? "block" : "none";
        _("LWebServerIP").style.display = window.location.hostname === "" ? "block" : "none";
      }
      updateTopBar();
      if (MQTTClient.Enabled == true) {
        _('FirmwareUpdateL').style.display = "none";
        _('FirmwareUpdate').style.display = "none";
        MQTTConnect();
      }
      else {
        _('FirmwareUpdateL').style.display = "block";
        _('FirmwareUpdate').style.display = "block";
        socketInit(); //Initiate a connection to the afterburner
      }

      var MQTTon = (MQTTClient.Enabled != 0);
      _("btnWebClient").style.backgroundColor = MQTTon ? buttonColorDefault : buttonColorReceived;
      _("btnMQTTClient").style.backgroundColor = MQTTon ? buttonColorReceived : buttonColorDefault;
      _("btnWebClient").disabled = MQTTon ? false : true;
      _("btnMQTTClient").disabled = MQTTon ? true : false;
      // if not local storage force off MQTT selection ability as Paho cleint needs this
      if (!lsTest()) {
        _("btnMQTTClient").style.display = "none";
      }
      var disable = MQTTon ? true : false;
      _("MEn").disabled = disable;
      _("MHost").disabled = disable;
      _("MPort").disabled = disable;
      _("MUser").disabled = disable;
      _("MPasswd").disabled = disable;
      if (decodeSysVer() >= 3.2) {
        disable = true;   // topic is fixed 
      }
      _("MTopic").disabled = disable;
      _("WarningMQTT").style.display = MQTTon ? "block" : "none";

    }

    function doNoGaugeJS() {
      _("divNoGaugeJS").style.display = "block";
      _("page").style.display = "none";
    }

    function decodeJSON(source, message) {
      console.log(message);
      var heater = JSON.parse(message);
      var key;
      for (key in heater) {
        if (heater.hasOwnProperty(key)) {
          console.log(source + " JSON:", key, heater[key]);
          json[key] = heater[key];
          switch (key) {
            case "Altitude":
              updateEnvironmental();
              break;
            case "BluewireStat":
              break;
            case "CyclicOff":
              working[key] = json[key];
              updateDataText(); //Update data text for cyclic data
              json[key] > 1 ? buttonCyclicEnbDis(1, 1) : buttonCyclicEnbDis(0, 1);
              break;
            case "CyclicOn":
              working[key] = json[key];
              updateDataText();
              updateButtonCyclicOn();
              break;
            case "CyclicTemp":
              working[key] = json[key];
              updateDataText();
              updateCyclicTemp();
              updateTempGaugeHighlights(1);
              break;
            case "ErrorState":
              break;
            case "ErrorString":
              updateTopBar();
              break;
            case "FanMin":
            case "FanMax":
              updateFuelButton(key);
              updateRPMGaugeHighlights();
              break;
            case "FanSensor":
              break;
            case "FanRPM":
              rpmgauge.value = parseFloat(json[key]);
              // rpmgauge.value = json[key]; //integer typical 1000...5000
              _('textRpmGauge').innerHTML = "Fan " + json[key] + "RPM";
              break;
            case "FrostOn":
            case "FrostRise":
              working[key] = json[key];
              _("FrostMode").style.visibility = "visible";
              setFrostElements(0);
              updateTempGaugeHighlights(1);
              _(key).style.color = "black";
              _(key).style.backgroundColor = buttonColorReceived;
              break;
            case "GlowCurrent":
              json.GlowCurrent = parseFloat(json[key]).toFixed(1); //Convert to Amps
              updateDataText();
              break;
            case "GlowVoltage":
              json.GlowVoltage = parseFloat(json[key]).toFixed(1);
              updateDataText();
              break;
            case "GPanlg":
              _(key).innerHTML = json[key] + "%";
              hasGPIO();
              break;
            case "GPmodeAnlg":
              updateGPModeAnlg();
              hasGPIO();
              break;
            case "GPin1":
            case "GPin2":
              drawSwitch(key, json[key]);
              hasGPIO();
              break;
            case "GPmodeIn1":
              updateGPModeIn(1);
              hasGPIO();
              break;
            case "GPmodeIn2":
              updateGPModeIn(2);
              hasGPIO();
              break;
            case "GPmodeOut1":
            case "GPOutThr1":
              updateGPModeOut(1);
              hasGPIO();
              break;
            case "GPmodeOut2":
            case "GPOutThr2":
              updateGPModeOut(2);
              hasGPIO();
              break;
            case "GPout2":
            case "GPout1":
              var label;
              var xClass;
              switch (json[key]) {
                case 0: label = "Inactive"; break;
                case 1: label = "Active"; xClass = "bulbon"; break;
                case 2: label = "PWM up"; xClass = "bulbbrighter"; break;
                case 3: label = "PWM down"; xClass = "bulbduller"; break;
                case 4: label = "Flash"; xClass = "bulbflash"; break;
              }
              _(key).classList.remove("bulbbrighter", "bulbduller", "bulbflash", "bulbon");
              _(key).classList.add(xClass);
              hasGPIO();
              break;
            case "Humidity":
              updateEnvironmental();
              break;
            case "InputVoltage":
              json[key] = parseFloat(json[key]).toFixed(1); //OneDecimalPlace
              updateTopBar2();
              checkIfLowVoltage();
              break;
            case "LoadWebContent":
              _(key).style.display = 'inline-block';
              _(key + "L").style.display = 'block';
              _(key).innerHTML = json[key];
              break;
            case "LowVoltCutout":
              json.LowVoltCutout = parseFloat(json[key]).toFixed(1);
              updateButtonLowVolt(1);
              updateTopBar2();
              break;
            case "PumpActual":
              json[key] = parseFloat(json[key]).toFixed(1);
              pumpgauge.value = json[key];
              updateFuelRate();
              checkIfFuelPrime();
              break;
            case "PumpCal":
              json[key] = Number(json[key]);
              updateFuelConsumed();
              updateFuelRate();
              break;
            case "PumpCount":
              json[key] = Number(json[key]);
              updateFuelConsumed();
              break;
            case "PumpFixed":
              json[key] = parseFloat(json[key]).toFixed(1);
              updateTempGaugeHighlights(true);
              break;
            case "PumpMax":
            case "PumpMin":
              json[key] = parseFloat(json[key]).toFixed(1);
              updateFuelButton(key);
              updatePumpGaugeHighlights();
              break;
            case "PumpPrime":  //Afterburner doesn't send this JSON at the moment.
              primeHeater(json[key], 1);
              break;
            case "Reboot":
              if (rebootReq) {
                // alert("Please enter PIN " + json[key] + " to confirm reboot");
                // openKeyboard(Title, Min, Max, zeroOff, decimal, sendingButton, sendVariable, showRange) {          
                var match = json[key];
                json[key] = 0;  // ensure value gets sent!
                openKeyboard('Please enter "' + match + '" to confirm reboot:',
                  0, 9999, 0, 0, "rebootDummy", "Reboot", 0, 0);
              }
              if (json[key] == -1) {
                _('topBarText').style.color = 'red';
                _('topBarClientText').innerHTML = "";
                _('topBarText').innerHTML = "Challenger is rebooting...";
                _('topBarText2').innerHTML = "";
                console.log("TopBarText: ", _('topBarText').class, _('topBarText').style);
                //            alert("Afterburner is rebooting");
                dispMenu("None");
                if (Socket && Socket != null) {
                  setTimeout(function () { location.reload(true); }, 5000);
                }
              }
              break;
            case "RunState":
              doRunStateChange();
              checkIfFuelPrime();
              break;
            case "RunString":
              updateTopBar(); //shows RunString ErrorSting & Voltage
              break;
            case "StartString":
              _(key).innerHTML = json[key];
              if (json[key] != '') {
                _("divStartWarning").style.display = "inline-block";
                setTimeout(closeStartPopup, 5000);
              }
              break;
            case "SystemVoltage":
              _('SysVoltage').innerHTML = json[key];
              //changeSystemVoltage(json.SystemVoltage, 1);   //currently disabled for web to change setting
              break;
            case "TempBody":
              bodytempgauge.value = cOrF(json[key], 0, 0);
              _('textTempBodyGauge').innerHTML = "Body " + cOrF(json[key], 0, 0) + degreeSymbol;
              break;
            case "TempCurrent":
              json.TempCurrent = parseFloat(json[key]).toFixed(1); //float 0.1deg C
              updateTempGaugeHighlights(1);
              updateEnvironmental();
              break;
            case "TempOffset":
            case "Temp2Offset":
            case "Temp3Offset":
            case "Temp4Offset":
              _(key).style.background = protected ? buttonColorDefault : buttonColorReceived;
            // delibrate fall through here
            case "Temp2Current":   // extra temperature sensors
            case "Temp3Current":
            case "Temp4Current":
              json[key] = parseFloat(json[key]).toFixed(1); //float 0.1deg C
              updateEnvironmental();
              break;
            case "TempType":
            case "Temp2Type":
            case "Temp3Type":
            case "Temp4Type":
              updateEnvironmental();
              break;
            case "TempDesired":
              updateTempGaugeHighlights(true);
              break;
            case "TempMax":
              if (json.TempDesired > json[key]) {
                json.TempDesired = json[key];
              }
              updateTempGaugeHighlights(1);
              break;
            case "TempMin":
              if (json.TempDesired < json[key]) {
                json.TempDesired = json[key];
              }
              updateTempGaugeHighlights(1);
              break;
            case "TempMode":
              doChangeOfTempMode();
              break;
            case "Thermostat":
              updateThermostatButtons();
              break;
            case "ThermostatMethod":
              updateThermostatButtons();
              break;
            case "ThermostatWindow":
              json[key] = parseFloat(json[key]); //set the var to the new value - float 0.2...6.3
              updateThermostatButtons();
              break;
            case "TimerConflict":
              decodeConflict(json[key]);
              break;
            case "TimerDays":
              decodeDays(json[key]);
              break;
            case "TimerRefresh":
              onTimerSel();
              //          dumpTimers();
              break;
            case "TimerRepeat":
              decodeRepeat(json[key]);
              break;
            case "TimerStart":
              decodeStart(json[key]);
              break;
            case "TimerStop":
              decodeStop(json[key]);
              break;
            case "TimerTemp":
              decodeTemp(json[key]);
              break;
            case "SysVer":
              // timer temperature feature only available with firmware V3.2+
              var version = decodeSysVer();
              _("TimerTemp").style.display = (version < 3.2) ? "none" : "block";
              if (version >= 3.2) {
                _("MTopic").disabled = true;
                _("buttonThermoStopStart").style.visibility = "visible";
              }
              _(key).innerHTML = json[key];
              break;
            case "BT_MAC":
            case "IP_AP":
            case "IP_APMAC":
            case "IP_STA":
            case "IP_STAMAC":
            case "IP_STASSID":
            case "SysDate":
              _(key).innerHTML = json[key];
              break;
            case "IP_OTA":
              _(key).innerHTML = (json[key]) ? "Enabled" : "Disabled";
              break;
            case "DateTime":
              updateClocks();
              break;
            case "SysGlowTime":
            case "SysRunTime":
            case "SysUpTime":
              _(key).innerHTML = convertSecToHour(json[key]);
              break;
            case "MEn":
              _(key).innerHTML = json[key] ? "Enabled" : "Disabled";
              _(key).style.backgroundColor = buttonColorReceived;
              break;
            case "MOnline":
              _(key).innerHTML = json[key] ? "Online" : "Offline";
              _(key).style.backgroundColor = json[key] ? buttonColorReceived : buttonColorPending;
              break;
            case "MHost":
            case "MPort":
            case "MUser":
            case "MPasswd":
            case "MTopic":
              _(key).value = json[key];
              _(key).style.backgroundColor = buttonColorReceived;
              break;
          }
        }
      }
    };

    var portflipflop = 0;

    function socketInit() {
      console.log("socketInit: " + '"' + window.location.hostname + '":' + window.location.port);
      if (window.location.protocol === 'https:') {
        var port = (window.location.port === "") ? 443 : parseFloat(window.location.port);
        afterburnerIp = "wss://" + window.location.hostname + ":" + port;
      }
      else {
        var force81 = portflipflop != 0;
        force81 |= window.location.port === "";
        var afterburnerWebSocketPort = force81 ? 81 : parseFloat(window.location.port) + 1;
        if (afterburnerWebSocketPort < 81) {
          afterburnerWebSocketPort = 81;
        };
        afterburnerIp = window.location.hostname === "" ?
          "ws://" + WebServerIP + ":" + WebServerPort :
          "ws://" + window.location.hostname + ":" + afterburnerWebSocketPort;
      }
      _('topBarClientText').innerHTML = "Challenger WiFi";
      _('topBarText').innerHTML = "";
      _('topBarText2').innerHTML = "";
      _('divThermostatText').style.backgroundColor = "rgb(255,128,128)"; //Light Red
      _('dataText').innerHTML = "Connecting to " + afterburnerIp + "...";
      if (window.socketTimer) { //  clear the retry timer if it is set
        window.clearInterval(window.socketTimer);
        window.socketTimer = 0;
      }
      if (Socket && Socket != null) {
        delete Socket;
      }
      console.log('Attempt socket connection on ' + afterburnerIp + '...');
      Socket = new WebSocket(afterburnerIp);

      Socket.onopen = function () {
        if (Socket != null) {
          console.log('Socket Opened!');
          if (window.socketTimer) { //socket opened so clear the retry timer if it is set
            window.clearInterval(window.socketTimer);
            window.socketTimer = 0;
          }
          _('divThermostatText').style.backgroundColor = "rgb(128,128,255)"; //Light Blue
          // divsShow(); //Show all the front page divs
          sendJSON("SQuery", false); //get the current Afterburner Date/Time
          sendJSON("IQuery", false); //get the Afterburner Network details.
          sendJSON("MQuery", false); //get the Afterburner MQTT details.
          var i;
          for (i = 1; i <= 14; i++) {
            json.TQuery = i;
            sendJSON("TQuery", false);
          }

        }
      };

      Socket.onclose = function (e) { //Socket will try & reconnect if it is closed - set timer
        if (Socket != null) {
          console.log('Socket is closed. Reconnect will be attempted in 5 seconds ...', e.reason);
          if (!TESTING) {
            dispMenu('HomePage'); //return to home screen
            divsHide(); //hide home page divs if !TESTING
          }
          _('topBarClientText').innerHTML = "Challenger WiFi";
          _('topBarText').innerHTML = "Please wait....";
          _('topBarText2').innerHTML = "";
          _('dataText').innerHTML = "Retrying " + afterburnerIp + "...";
          portflipflop ^= 0x01;
          if (!window.socketTimer) {
            /* Avoid firing a new setInterval, after one has been done */
            window.socketTimer = setInterval(function () {
              socketInit();
            },
              5000);
          }
        }
      };

      Socket.onmessage = function (event) {
        if (Socket != null) {
          //               console.log('Socket Message Received!');
          decodeJSON('Socket', event.data);
        }
      };
    } // End socketInit();

    //        function inputentered(event, ID) {
    //          // capture final ENTER and lose focus of associated element
    //          console.log("inputentered event: " + event.key);
    // //         if (event.keyCode == 13 || event.which == 13){
    //          if (event.key == "Enter") {
    //            _(ID).blur();
    //          }
    //        }

    function onMQTTEnable() {
      if (protected) {
        enableProtected();
      }
      else {
        _('MEn').style.backgroundColor = buttonColorSent;
        json.MEn = json.MEn ? 0 : 1;
        sendJSON("MEn", true);
      }
    }

    function updateGPModeIn(ID) {
      var modekey = "GPmodeIn" + ID;
      // var GPinkey = "GPin" + ID;
      var label = "divGPin" + ID;
      var drawColor = "GPin" + ID + "DrawColor";

      _(label).innerHTML = "Digital i/p #" + ID + ": <br><i>(" + json[modekey] + ")</i>";

      _("buttonThermoExternal").style.visibility = json.GPmodeIn2 == "Ext Thermo" ? "visible" : "hidden";

      switch (json[modekey]) {
        case "Disabled":
          window[drawColor] = "silver";
          break;
        case "Mom On":
        case "Hold On":
        case "Mom On/Off":
          window[drawColor] = "black";
          break;
      }
    }

    function setGPin(ID) {
      var key = "GPin" + ID;

      _(key).style.backgroundColor = buttonColorSent;
      json[key] = 1;
      sendJSON(key, false);
      setTimeout(
        function () {
          json[key] = 0;
          _(button).style.backgroundColor = buttonColorDefault;
        },
        buttonDelay);
    }

    function onGPinStim(ID) {
      var key = "GPin" + ID;
      var mode = "GPmodeIn" + ID;
      var prev = {
        GPin: json[key],
      }

      if (json[mode] != "Disabled") {
        drawSwitch(key, 1);
        json[key] = 1;
        sendJSON(key, false);
        setTimeout(
          function () {
            json[key] = prev.GPin;
            drawSwitch(key, json[key]);
          },
          buttonDelay);
      }
    }

    function onGPoutMethod(ID) {
      var method = "GPoutMethod" + ID;
      var key = "GPout" + ID;
      var idx = ID - 1;
      GPOutMethod[idx] = !GPOutMethod[idx];
      _(method).innerHTML = GPOutMethod[idx] ? "Toggle" : "Mom."; //False = MOM True = Toggle
      if (!GPOutMethod[idx] && json[key] == 1) {            //if switching to momentary, reset output to 0 if it is currently 1
        json[key] = 0;
        sendJSON(key, false);
      }
    }

    function onGPout(ID) {
      var GPmodeOutkey = "GPmodeOut" + ID;
      var GPoutkey = "GPout" + ID;

      console.log("onGPout", GPoutkey, GPmodeOutkey);

      if (json[GPmodeOutkey] == "User") {

        if (GPOutMethod[ID - 1]) {    // if mode toggle
          json[GPoutkey] = json[GPoutkey] ? 0 : 1;
        } else {                    //momentary
          json[GPoutkey] = 1;
          setTimeout(
            function () {
              json[GPoutkey] = 0;     //if momentary 500ms later we reset back to 0
              sendJSON(GPoutkey, false);
            },
            1000);
        }
        sendJSON(GPoutkey, false);    //sends the output (toggled if toggle, 1 if momentary)
      }
    }

    function updateGPModeOut(ID) {
      var GPmodeOutkey = "GPmodeOut" + ID;
      var GPthreshkey = "GPOutThr" + ID;
      var GPoutMethod = "GPoutMethod" + ID;
      var GPoutLabel = "GPoutLabel" + ID;

      console.log(GPmodeOutkey, GPthreshkey, GPoutMethod);
      var innerHTML = "Digital o/p #" + ID + ": <br><i>(";
      console.log(innerHTML);

      _(GPoutMethod).style.display = 'none';
      switch (json[GPmodeOutkey]) {
        case "User":
          _(GPoutMethod).style.display = 'block';
          innerHTML += "User";
          break;
        case "Thresh":
          if (json[GPthreshkey] != undefined) {
            var val = json[GPthreshkey];
            innerHTML += "Temperature";
            if (val > 0) {
              innerHTML += " > " + cOrF(val, 1, 0) + degreeSymbol;
            } else {
              innerHTML += " < " + cOrF(-val, 1, 0) + degreeSymbol;
            }
          }
          break;
        case "Disabled":
          innerHTML += "Disabled";
          break;
        case "Status":
          innerHTML += "Run Status (PWM LED)";
          break;
        case "HeaterOn":
          innerHTML += "Heater On Status";
          break;
        default:
          innerHTML += json[GPmodeOutkey];
          break;
      }
      innerHTML += ")</i>";
      _(GPoutLabel).innerHTML = innerHTML;
    }

    function updateGPModeAnlg() {
      _("GPmodeAnlg").innerHTML = "Analogue i/p :<br><i>" + json.GPmodeAnlg + "</i>";
      switch (json[GPmodeAnlg]) {
        case "Disabled":
          _("GPanlg").style.color = "grey";
          break;
        default:
          _("GPanlg").style.color = "black";
          break;
      }
    }

    function checkPassword() {
      var result = _("passwordInput").value;
      if (result == 4682 || result == 4682) {
        closePasswordPopUp();
        enableProtected2();
      } else {
        _("buttonPasswordSubmit").style.backgroundColor = "red";
        setTimeout(
          function () {
            _("buttonPasswordSubmit").style.backgroundColor = buttonColorDefault;
          },
          buttonDelay);
      }

    }

    function enableProtected() {
      if (protected) {
        _("divPasswordPopUp").style.display = "inline-block";
      } else {
        enableProtected2();
      }
    }

    function enableProtected2() {
      protected = !protected;

      _("buttonProtected").style.backgroundColor = protected ? buttonColorDefault : buttonColorReceived;
      _("PumpMinDown").style.visibility = protected ? "hidden" : "visible";
      _("PumpMinUp").style.visibility = protected ? "hidden" : "visible";
      _("FanMinDown").style.visibility = protected ? "hidden" : "visible";
      _("FanMinUp").style.visibility = protected ? "hidden" : "visible";
      _("PumpMaxDown").style.visibility = protected ? "hidden" : "visible";
      _("PumpMaxUp").style.visibility = protected ? "hidden" : "visible";
      _("FanMaxDown").style.visibility = protected ? "hidden" : "visible";
      _("FanMaxUp").style.visibility = protected ? "hidden" : "visible";
      _("LowVoltCutout").disabled = protected ? true : false;
      _("buttonLowVoltDown").style.display = protected ? "none" : "inline-block";
      _("buttonLowVoltUp").style.display = protected ? "none" : "inline-block";
      _("buttonUpdateFanPump").innerHTML = protected ? "Enable" : "Update Heater";
      // _("buttonUpdateFanPump").style.visibility = "visible";
      _("TempOffset").style.background = protected ? buttonColorDefault : buttonColorReceived;
      _("Temp2Offset").style.background = protected ? buttonColorDefault : buttonColorReceived;
      _("Temp3Offset").style.background = protected ? buttonColorDefault : buttonColorReceived;
      _("Temp4Offset").style.background = protected ? buttonColorDefault : buttonColorReceived;
    }

    function closePasswordPopUp() {
      _("divPasswordPopUp").style.display = "none";
    }

    function checkIfLowVoltage() { //Turn on low voltage icon - compare volt = (LVC + 0.5) OR 12v whichever is higher
      //_('showLowBattery').style.display = "inline-block";

      if (json.LowVoltCutout) {  // only enable if Afterburer has LVC enabled!
        var compareVoltage = json.LowVoltCutout + 0.5;
        if (compareVoltage < 12) {
          compareVoltage = 12;
        }
        //glow/10 is volt compensation for loss during glow in input cable
        if (json.InputVoltage < (compareVoltage - json.GlowCurrent / 10)) {
          _('showLowBattery').style.display = "inline-block";
        } else {
          _('showLowBattery').style.display = "none";
        }
        console.log("checkIfLowVoltage: " + json.InputVoltage, compareVoltage, json.GlowCurrent);
      }
      else {
        _('showLowBattery').style.display = "none";
      }
    }

    // Scripts for date handling
    Date.prototype.today = function () {
      return ((this.getDate() < 10) ? "0" : "") + this.getDate() + "/" + (((this.getMonth() + 1) < 10) ? "0" : "") + (this.getMonth() + 1) + "/" + this.getFullYear();
    };

    function convertSecToHour(seconds) {
      var dyDisplay = "";
      var hDisplay = "";
      var mDisplay = "";
      var ns = Number(seconds);
      var dy = Math.floor(ns / (24 * 3600));
      var h = Math.floor(ns % (3600 * 24) / 3600);
      var m = Math.floor(ns % 3600 / 60);
      //var s = Math.floor(ns % 3600 % 60);
      if (dy >= 1) {
        dyDisplay = dy + (dy == 1 ? " day&nbsp;," : " days, ");
      }
      if (h >= 1) {
        hDisplay = padZero(h) + (h == 1 ? " hr&nbsp;, " : " hrs, ");
      }
      if (m < 1) { //time is basically 0 minutes so show 0 rather than 00 which padZero will do
        mDisplay = 0;
      } else {
        mDisplay = padZero(m);
      }
      mDisplay = mDisplay + (m == 1 ? " min&nbsp;" : " mins");
      //var sDisplay = padZero(s) + (s == 1 ? " sec&nbsp;" : " secs");
      return dyDisplay + hDisplay + mDisplay; // + sDisplay;
    }

    function updateFuelConsumed() {
      // _("textPumpGauge3").innerHTML = "Fuel&nbsp;Used&nbsp;" + Math.floor(json.PumpCal * json.PumpCount) + "ml";
    }

    function updateFuelRate() {
      var fuelRate = parseFloat(json.PumpActual * json.PumpCal * 60 * 60).toFixed(0);
      _('textPumpGauge').innerHTML = "Pump&nbsp;" + json.PumpActual + "Hz";
      _('textPumpGauge2').innerHTML = "Fuel Rate&nbsp;" + fuelRate + "ml/hr";
    }

    function setClock() {
      var now = new Date();
      now = new Date(now.getTime() + 2000);
      var y = now.getFullYear();
      var mth = padZero(now.getMonth() + 1);
      var date = padZero(now.getDate());
      var h = padZero(now.getHours());
      var m = padZero(now.getMinutes());
      var s = padZero(now.getSeconds());
      var timenow = date + "/" + mth + "/" + y + " " + h + ":" + m + ":" + s;
      json.DateTime = timenow;
      sendJSON("DateTime", false);
      _('setClock').style.backgroundColor = buttonColorSent;
    }

    function updateClocks() { //first we convert d/mm/yyyy hh:MM:ss to yyyy mm dd hh MM ss
      _('setClock').style.backgroundColor = buttonColorReceived;
      setTimeout(
        function () {
          _('setClock').style.backgroundColor = buttonColorDefault;
        },
        buttonDelay);
      var dateParts = json.DateTime.split("/");
      var timeParts = dateParts[2].split(" ")[1].split(":");
      dateParts[2] = dateParts[2].split(" ")[0];
      // month is 0-based, that's why we need dataParts[1] - 1
      afterburnerClock = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0], timeParts[0], timeParts[1], timeParts[2]);
      var localClock = new Date();
      var date1_ms = localClock.getTime();
      var date2_ms = afterburnerClock.getTime();
      // Calculate the difference in milliseconds
      difference_ms = date2_ms - date1_ms;
      showClocks(difference_ms);
    }

    function showClocks(difference_ms) {
      clearTimeout(clockTimeout);
      var localClock = new Date();
      var afterburnerClock = new Date(localClock.getTime() + difference_ms);
      // Set lag to just after next full second
      var lag = 1015 - localClock.getMilliseconds();
      var y = localClock.getFullYear();
      var mth = addZ(localClock.getMonth() + 1);
      var date = addZ(localClock.getDate());
      var h = addZ(localClock.getHours());
      var m = addZ(localClock.getMinutes());
      var s = addZ(localClock.getSeconds());
      var ay = afterburnerClock.getFullYear();
      var amth = addZ(afterburnerClock.getMonth() + 1);
      var adate = addZ(afterburnerClock.getDate());
      var ah = addZ(afterburnerClock.getHours());
      var am = addZ(afterburnerClock.getMinutes());
      var as = addZ(afterburnerClock.getSeconds());
      _('localclock').innerHTML = date + "/" + mth + "/" + y + " " + h + ":" + m + ":" + s;
      _('afterburnerclock').innerHTML = adate + "/" + amth + "/" + ay + " " + ah + ":" + am + ":" + as;
      clockTimeout = setTimeout(
        function () {
          showClocks(difference_ms);
        },
        lag);

      function addZ(n) {
        return (n < 10 ? '0' : '') + n;
      }
    }

    function updateCyclicTemp() {
      var key = 'CyclicTemp';
      checkButtonPendingColor(key);
      _(key).style.backgroundColor = buttonColorReceived;
      _(key).innerHTML = cOrF(working.CyclicTemp, 0, 0) + degreeSymbol;
      selectiveShowCyclicUpdate();
    }

    function onCyclicRefAdj(dir) {
      setFrostElements(0);  // cancel possible frost mode selection
      setCyclicElements(0);  // cancel possible frost mode selection

      working.CyclicTemp += dir;
      var atLimit = false;
      if (working.CyclicTemp > json.TempMax) {
        working.CyclicTemp = json.TempMax;
        atLimit = true;
      }
      if (working.CyclicTemp < json.TempMin) {
        working.CyclicTemp = json.TempMin;
        atLimit = true;
      }
      if (atLimit) {
        _("CyclicTemp").style.backgroundColor = buttonColorLimit;
        setTimeout(
          function () {
            _("CyclicTemp").style.backgroundColor = buttonColorDefault;
          },
          buttonDelay);
        return;
      }
      updateCyclicTemp();
      _("CyclicOn").innerHTML = cOrF(working.CyclicOn + working.CyclicTemp, 1, 1) + degreeSymbol + " (" + cOrF(working.CyclicOn, 1, 1) + ")";
      _("CyclicOff").innerHTML = cOrF(working.CyclicOff + working.CyclicTemp, 1, 1) + degreeSymbol + " (" + cOrF(working.CyclicOff, 1, 1) + ")";
      selectiveShowCyclicUpdate();
    }

    function updateThermostatButtons() {
      if (json.Thermostat == 0) { //direct Hz mode no thermostat
        buttonThermSelect(1, 1);
      } else {
        switch (json.ThermostatMethod) {
          case 0:
            buttonThermSelect(2, 1); //thermostat conventional
            break;
          case 1:
            buttonThermSelect(3, 1); //thermostat deadband
            break;
          case 2:
            buttonThermSelect(4, 1); //linear Hz
            break;
          case 3:
            buttonThermSelect(6, 1); //external
            break;
          case 4:
            buttonThermSelect(5, 1); //stop start
            break;
        }
      }
      updateButtonThermWindow(1); //update the button value & color
      updateDataText(); //update the data text line
      updateTempGaugeHighlights(true); //update the gauge to show the changed window
    }

    function updateTopBar() {
      var clientTxt = (MQTTClient.Enabled != false) ? "Challenger MQTT" : "Challenger WiFi";
      var statusTxt = json.ErrorString == "E-00: OK" ? json.RunString : json.ErrorString;

      _('topBarClientText').innerHTML = clientTxt;
      _('topBarText').style.color = 'white';
      _('topBarText').innerHTML = statusTxt;
      _('topBarText').style.backgroundColor = json.ErrorString == "E-00: OK" ? "black" : "rgb(255,128,128)";
    }

    function updateTopBar2() {
      var cutoutText = json.LowVoltCutout > 0 ? " [" + json.LowVoltCutout + "V]" : "";
      _('topBarText2').innerHTML = json.InputVoltage + "V" + cutoutText;
    }

    function updateDataText() {
      verboseThermostatMethod();
      if (json.CyclicOff > 1) {
        var absoluteCyclicOn = json.CyclicTemp + json.CyclicOn;
        var absoluteCyclicOff = json.CyclicTemp + json.CyclicOff;
        cyclicModeText = " - Cyclic Zone [" + cOrF(absoluteCyclicOn, 1, 0, 0) + degreeSymbol + " - " + cOrF(absoluteCyclicOff, 1, 0, 0) + degreeSymbol + "]";
      } else {
        cyclicModeText = "";
      }
      switch (displayMode) {
        case 0: //Off or Running modes
          if (json.Thermostat == 0) {
            _('dataText').innerHTML = "Mode: Direct Hz" + cyclicModeText;
          } else {
            switch (json.ThermostatMethod) {
              case 0: //Standard
                _('dataText').innerHTML = "Mode: " + thermostatMethodText + " [" + cOrF(2, 1, 1) + degreeSymbol + "]" + cyclicModeText;
                break;
              case 1: //Deadband
                _('dataText').innerHTML = "Mode: " + thermostatMethodText + " [" + cOrF(json.ThermostatWindow, 1, 1) + degreeSymbol + "]" + cyclicModeText;
                break;
              case 2: //Linear Hz
                _('dataText').innerHTML = "Mode: " + thermostatMethodText + " [" + cOrF(json.ThermostatWindow, 1, 1) + degreeSymbol + "]" + cyclicModeText;
                break;
              case 3: //External thermostat - GPIOin2 is set as an external thermostat input
                _('dataText').innerHTML = "Mode: " + thermostatMethodText + " " + cyclicModeText;
                break;
              case 4: //Stop Start thermostat 
                _('dataText').innerHTML = "Mode: " + thermostatMethodText + " " + cyclicModeText;
                break;
              default:
                _('dataText').innerHTML = "Mode: " + thermostatMethodText;
                break;
            }
          }
          break;
        case 1: //Glowplug modes
          _('dataText').innerHTML = "Glow: " + json.GlowVoltage + "V " + json.GlowCurrent + "A " + parseFloat(json.GlowVoltage * json.GlowCurrent).toFixed(1) + "W"; //GlowPlug
          //console.log("TEST2 - glowVoltage " + glowVoltage);
          break;
      }
    }

    function calcPumpHz(desired) {
      var ratio = (desired - json.TempMin) / (json.TempMax - json.TempMin);
      var offset = ratio * (json.PumpMax - json.PumpMin);
      var PumpHz = Number(json.PumpMin) + Number(offset);
      return parseFloat(PumpHz).toFixed(1);
    }

    function doRunStateChange() {
      switch (json.RunState) {
        case 0:
        case 4:
        case 5:
        case 8:
        case 10:
        case 12:
          displayMode = 0; //Normal display voltage thermomode etc
          break;
        default:
          displayMode = 1; //Glowplug Display Voltage & glow plug details
      }
      updateDataText(); //uses displayMode to determine what to show
      buttonHeaterOnOffDisable(); //enable disable on/off buttons depending on runstate change
    }

    function setTemp(dir) {
      _("buttonDesiredUp").style.backgroundColor = buttonColorDefault; //return color of other button to default
      _("buttonDesiredDown").style.backgroundColor = buttonColorDefault; //return color of other button to default
      json.TempDesired += dir;
      var atLimit = false;
      if (json.TempDesired < json.TempMin) { //test if we have tried to change desired temp outside set Min Max (typically 8-35)
        json.TempDesired = json.TempMin;
        _("buttonDesiredDown").style.backgroundColor = buttonColorLimit; //Limit Reached show by change of color
        atLimit = true;
      }
      else if (json.TempDesired > json.TempMax) { //test if we have tried to change desired temp outside set Min Max (typically 8-35)
        json.TempDesired = json.TempMax;
        _("buttonDesiredUp").style.backgroundColor = buttonColorLimit; //Limit Reached show by change of color
        atLimit = true;
      }
      else {
        if (dir < 0)
          _("buttonDesiredDown").style.backgroundColor = buttonColorSent; //set the color to blue to indicate user has changed the setting - it will be returned to grey when we get a response back
        else
          _("buttonDesiredUp").style.backgroundColor = buttonColorSent; //set the color to blue to indicate user has changed the setting - it will be returned to grey when we get a response back
        sendTempDesired(); //we pushed a button to change the desired Temp, here we send that to the Heater & we also update the gauge to show our request (blue pointer)
      }
      if (atLimit) {
        setTimeout(
          function () {
            if (dir > 0)
              _("buttonDesiredUp").style.backgroundColor = buttonColorDefault;
            else
              _("buttonDesiredDown").style.backgroundColor = buttonColorDefault;
          },
          buttonDelay);
      }
    }


    function sendTempDesired() {
      clearTimeout(sendTempDesiredTimeout); //if clicked again within 700ms, we reset our send data timer
      sendTempDesiredTimeout = setTimeout(
        function () {
          sendTempDesired2();
        },
        700); //if quickly changing temp, we wait 700ms then send the data to the afterburner
      updateTempGaugeHighlights(false); //false shows blue pointer (Orange pointer will show when heater sends the updated tempDesired via the JSON Socket process
    }

    function sendTempDesired2() {
      setTimeout(
        function () {
          _("buttonDesiredDown").style.backgroundColor = buttonColorDefault;
          _("buttonDesiredUp").style.backgroundColor = buttonColorDefault;
        },
        buttonDelay);
      sendJSON("TempDesired", false);
    }

    //#updategauge
    function updateTempGaugeHighlights(marker) { //marker is bool - true = heater has sent the set data to show & false = web page has requested a change to the setting & we show that
      var markerColor, titleColor, title, pointerwidth, windowlow, windowhigh;
      var cyclicunder, cyclicover, cyclicsizeunder, cyclicsizeover, minvalue, maxvalue;
      var frostOn, frostOff;
      if (marker) {
        markerColor = markerColorReceived; //orange	//Desired temp marker colour. When sent from the heater orange, when set by web blue.
        if (_("buttonDesiredDown").style.backgroundColor == buttonColorSent) {
          _("buttonDesiredDown").style.backgroundColor = buttonColorReceived;
          setTimeout(
            function () {
              _("buttonDesiredDown").style.backgroundColor = buttonColorDefault;
            },
            buttonDelay);
        }
        if (_("buttonDesiredUp").style.backgroundColor == buttonColorSent) {
          _("buttonDesiredUp").style.backgroundColor = buttonColorReceived;
          setTimeout(
            function () {
              _("buttonDesiredUp").style.backgroundColor = buttonColorDefault;
            },
            buttonDelay);
        }
        titleColor = "black";
      } else { //So in effect as you change the desired temp the pointer changes colour with your update, then
        markerColor = markerColorSent; //blue		//when the heater gets that value & updates it & sends it back, we change the colour of the pointer to show that.
        titleColor = "white";
      }
      if (json.Thermostat == 0) { //thermostat mode DirectHz show pumpFixed instead of Desired Temp
        windowlow = json.TempDesired;
        windowhigh = json.TempDesired;
        pointerwidth = 0.2;
        if (!marker) {
          var a = json.PumpMax - json.PumpMin;
          var b = json.TempDesired - json.TempMin;
          var c = json.TempMax - json.TempMin;
          var d = a * b;
          var e = d / c;
          var f = (Number(e) + Number(json.PumpMin)) * 10;
          json.PumpFixed = parseFloat(Math.trunc(f) / 10).toFixed(1); //This is the Hz calculated from the Desired Temp
        }
        title = "" + json.TempDesired + degreeSymbol;
        document.getElementById("roundHolder").innerHTML="Required <h2>"+title+"</h2>";
      } else {
        title = "Desired " + cOrF(json.TempDesired, 0, 0) + degreeSymbol;
        pointerwidth = 0.2;
        switch (json.ThermostatMethod) {
          case 0:
            windowlow = json.TempDesired - 1;
            windowhigh = json.TempDesired + 1;
            break;
          case 1:
          case 2:
          case 4:
            windowlow = json.TempDesired - json.ThermostatWindow / 2;
            windowhigh = json.TempDesired + json.ThermostatWindow / 2;
            break;
        }
      }

      if (json.CyclicOff > 1) { //if cyclic mode is on we show the cyclic markers
        //    if (json.Thermostat == 0) { //if cyclic on, & not directHz set cyclic on gauge using cyclictemp as reference
        cyclicunder = json.CyclicTemp + json.CyclicOn;
        cyclicover = json.CyclicTemp + json.CyclicOff;
        cyclicsizeunder = 0.4;
        cyclicsizeover = 0.4;
        // } else { // else use DesiredTemp as reference
        //   cyclicunder = json.TempDesired + json.CyclicOn;
        //   cyclicover = json.TempDesired + json.CyclicOff;
        //   cyclicsizeunder = 0.4;
        //   cyclicsizeover = 0.4;
        // }
      } else { //else cyclic mode is off so hide the marker size 0
        cyclicunder = json.TempDesired;
        cyclicover = json.TempDesired;
        cyclicsizeunder = 0;
        cyclicsizeover = 0;
      }
      if (json.FrostOn) {
        frostOn = json.FrostOn;
        if (json.FrostRise) {
          frostOff = frostOn + json.FrostRise;
        }
        else {
          frostOff = json.TempDesired;
        }
      }
      else {
        frostOn = json.TempDesired;
        frostOff = json.TempDesired + 0.1;
      }

      if (!json.TempMode) { //if celsius change gauge range & markings
        minvalue = 0;
        maxvalue = 40;
        majorticks = ["0", "5", "10", "15", "20", "25", "30", "35", "40"];
      } else { //if fahrenheit
        minvalue = 30;
        maxvalue = 110;
        majorticks = ["30", "40", "50", "60", "70", "80", "90", "100", "110"];
      }

      var gtempMin = json.TempMin;
      var gtempMax = json.TempMax;
      if (json.TempMin < minvalue) {
        gtempMin = minvalue;
      }
      if (json.TempMax > maxvalue) {
        gtempMax = maxvalue;
      }
      //alert(windowlow + ":" + windowhigh);
      temperaturegauge.update(
        {
          value: cOrF(json.TempCurrent, 1, 0),
          minValue: minvalue,
          maxValue: maxvalue,
          majorTicks: majorticks,
          colorMajorTicks: "#000",
          colorMinorTicks: "#000",
          colorBar: "#d00",
          fontValueSize: 40,
          // title: title,
          colorTitle: titleColor,
          // units: " "+ cOrF(json.TempCurrent, 1, 0) + "°",
          // fontUnitsSize: 22,
          highlights: [ //add background blue yellow red
            {
              "from": minvalue,
              "to": cOrF(gtempMin, 1, 0),
              "color": "#f4ec1b"
            }, //Blue a0.2
            {
              "from": cOrF(gtempMin, 1, 0),
              "to": cOrF(gtempMax, 1, 0),
              "color": "#F9E8C8"
            }, //Orange a0.2
            {
              "from": cOrF(gtempMax, 1, 0),
              "to": maxvalue,
              "color": "tomato"
            }, //Red a0.2
            //overlay curent desired temp & window, cyclic & frost if thermostat mode requires
            // frost mode
            {
              "from": cOrF(frostOn, 1, 0),
              "to": cOrF(frostOff, 1, 0),
              "color": markerFrostSpan
            }, //pale blue frost span
            {
              "from": cOrF(frostOn - pointerwidth, 1, 0),
              "to": cOrF(frostOn, 1, 0),
              "color": markerFrost
            }, //Blue FrostOn
            {
              "from": cOrF(frostOff, 1, 0),
              "to": cOrF(frostOff + pointerwidth, 1, 0),
              "color": markerFrost
            }, //Blue FrostOff
            // thermostat
            {
              "from": cOrF(windowlow, 1, 0),
              "to": cOrF(windowhigh, 1, 0),
              "color": markerColorWindow
            }, //Green Thermostat window
            //cyclic
            {
              "from": cOrF(cyclicunder - cyclicsizeunder, 1, 0),
              "to": cOrF(cyclicunder, 1, 0),
              "color": markerCyclicUnder
            }, //Red CyclicOn
            {
              "from": cOrF(cyclicover, 1, 0),
              "to": cOrF(cyclicover + cyclicsizeover, 1, 0),
              "color": markerCyclicOver
            }, //Red CyclicOff
            {
              "from": cOrF(json.CyclicTemp - pointerwidth, 1, 0),  // Cyclic temp is always the desired temp when using the thermostat
              "to": cOrF(json.CyclicTemp + pointerwidth, 1, 0),
              "color": markerColor
            } //Orange Pointer Set Temp
          ]
        }
      );
    }

    function updateRPMGaugeHighlights() {
      rpmgauge.update(
        {
          highlights: [
            {
              "from": json.FanMin,
              "to": json.FanMax,
              "color": "rgba(0,255,0,0.5)"
            }, //
          ]
        }
      );
    }

    function updatePumpGaugeHighlights() {
      pumpgauge.update(
        {
          highlights: [
            {
              "from": json.PumpMin,
              "to": json.PumpMax,
              "color": "rgba(0,255,0,0.5)"
            }, //
          ]
        }
      );
    }
    
    function verboseThermostatMethod() {
      switch (json.ThermostatMethod) {
        case 0:
          thermostatMethodText = "Standard";
          break;
        case 1:
          thermostatMethodText = "Deadband";
          break;
        case 2:
          thermostatMethodText = "Comfort";
          break;
        case 3:
          thermostatMethodText = "External Thermostat";
          break;
        case 4:
          thermostatMethodText = "Stop Start";
          break;
        default:
          thermostatMethodText = "UNKNOWN!";
          break;
      }
    }

    function padZero(i) {
      if (i < 10) {
        i = "0" + i;
      }
      return i;
    }

    // Determine if the heater is currently on or off & disable the current on/off button.
    function buttonHeaterOnOffDisable() {
      switch (json.RunState) {
        case 0: //Stopped Ready
          //ONLY ON allowed
          _("buttonHeaterOff").disabled = true;
          _("buttonHeaterOff").style.color = "grey";
          _("buttonHeaterOff").style.display = "none";
          _("buttonHeaterOn").disabled = false;
          _("buttonHeaterOn").style.color = "black";
          _("buttonHeaterOn").style.display = "inline";
          break;
        case 1: //Starting
        case 2: //Igniting
        case 3: //Ignition Retry
        case 4: //Ignited
        case 5: //Running
        case 9: //Heating Glow Plug
        case 11: //Suspending
        case 12: //Suspend Cooling
          //ONLY OFF allowed
          _("buttonHeaterOff").disabled = false;
          _("buttonHeaterOff").style.color = "black";
          _("buttonHeaterOff").style.display = "inline";
          _("buttonHeaterOn").disabled = true;
          _("buttonHeaterOn").style.color = "grey";
          _("buttonHeaterOn").style.display = "none";
          break;
        case 6: //Stopping
        case 7: //Shutting Down
        case 8: //Cooling
          //neither ON or OFF allowed
          _("buttonHeaterOff").disabled = true;
          _("buttonHeaterOff").style.color = "grey";
          _("buttonHeaterOff").style.display = "inline";
          _("buttonHeaterOn").disabled = true;
          _("buttonHeaterOn").style.color = "grey";
          _("buttonHeaterOn").style.display = "none";
          break;
        case 10: //Suspended
          //ON or OFF	allowed
          _("buttonHeaterOff").disabled = false;
          _("buttonHeaterOff").style.color = "black";
          _("buttonHeaterOff").style.display = "inline";
          _("buttonHeaterOn").disabled = false;
          _("buttonHeaterOn").style.color = "black";
          _("buttonHeaterOn").style.display = "inline";
      }
    }

    function checkIfFuelPrime() {
      if (json.RunState > 0) {
        primeHeater(false, false, true);
        return;
      }
      if (json.RunState == "0" && json.PumpActual > 0) {
        primeHeater(true, true, false);
      } else {
        primeHeater(false, true, false);
      }
    }

    function primeHeater(onoff, mode, disabled) {
      if (disabled) {
        _("buttonPrimeOff").disabled = true;               //Prime on, enable off button so we can turn it off
        _("buttonPrimeOff").style.color = "grey";
        _("buttonPrimeOff").style.backgroundColor = buttonColorDefault;  //Set OFF button color to default as it is not active
        _("buttonPrimeOn").disabled = true;               //Prime on, disable on button
        _("buttonPrimeOn").style.color = "grey";
        _("buttonPrimeOn").style.backgroundColor = buttonColorDefault; //Set button color to indicate that prime is ON
        return;
      }
      if (onoff) {         //if prime on
        if (mode) {      //prime on & sent by heater
          _("buttonPrimeOff").disabled = false;               //Prime on, enable off button so we can turn it off
          _("buttonPrimeOff").style.color = "black";
          _("buttonPrimeOff").style.backgroundColor = buttonColorDefault;  //Set OFF button color to default as it is not active
          _("buttonPrimeOn").disabled = true;               //Prime on, disable on button
          _("buttonPrimeOn").style.color = "grey";
          _("buttonPrimeOn").style.backgroundColor = buttonColorReceived; //Set button color to indicate that prime is ON
        } else {  //prime on but we initiated
          _("buttonPrimeOn").style.backgroundColor = buttonColorSent;
          json.PumpPrime = 1;
          sendJSON("PumpPrime", false);                      //send request to start the pumpPrime
        }
      } else { // prime off
        if (mode) { //prime off & sent by heater
          _("buttonPrimeOff").disabled = true;               //Prime OFF, disable off button
          _("buttonPrimeOff").style.color = "grey";
          _("buttonPrimeOff").style.backgroundColor = buttonColorReceived;  //Set OFF button color to received as it is active
          _("buttonPrimeOn").disabled = false;               //Prime off, enable on button - if heater is started the onoff function will disable this
          _("buttonPrimeOn").style.color = "black";
          _("buttonPrimeOn").style.backgroundColor = buttonColorDefault; //Set button color to indicate that prime is ON
        } else { //prime off but we initiated
          _("buttonPrimeOff").style.backgroundColor = buttonColorSent;
          json.PumpPrime = 0;
          sendJSON("PumpPrime", false);                      //send request to stop the pumpPrime
        }
      }
    }


    function turnHeaterOn() {
      // if (confirm("Do you want to turn the heater ON!?")) {
      console.log("Turning On Heater");
      closePopupOnOff(); //close on/off popup
      json.RunState = 1;
      sendJSON("RunState", false);
      // } else {
      //   console.log("Turn ON Cancelled!");
      // }
    }

    function turnHeaterOff() {
      // if (confirm("Do you want to turn the heater OFF!?")) {
      console.log("Turning Off Heater");
      closePopupOnOff(); //close on/off popup
      json.RunState = 0;
      sendJSON("RunState", false);
      // } else {
      //   console.log("Turn OFF Cancelled!");
      // }
    }

    function drawSwitch(ID, state) {

      var drawColor = ID + "DrawColor";
      var canvas = _(ID);
      var w = canvas.width;
      var h = canvas.height;
      var ctx = canvas.getContext("2d");
      // erase all
      ctx.fillStyle = "#ffffc0";
      // ctx.fillStyle = document.body.style.backgroundColor; - NOT WORKING?
      console.log("drawSwitch", document.body.style.backgroundColor);
      ctx.fillRect(0, 0, w, h);

      var x;
      var y;
      y = h * 0.6;
      ctx.beginPath();
      var lineW = h * .05;
      if (lineW < 2) lineW = 2;

      console.log("switch " + w + "," + h + " lineW=" + lineW);

      ctx.lineWidth = lineW;
      ctx.moveTo(0, y);
      ctx.lineTo(w * 0.3, y);
      ctx.moveTo(w, y);
      ctx.lineTo(w * 0.7, y);
      ctx.strokeStyle = window[drawColor];
      ctx.stroke();
      ctx.beginPath();
      var radius = w * 0.05;
      ctx.arc(w * 0.35, y, radius, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(w * 0.65, y, radius, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.beginPath();
      if (state) {
        y -= radius;
        ctx.moveTo(w * 0.5, y);
        ctx.lineTo(w * 0.5, y + h * 0.25);
        ctx.moveTo(w * 0.3, y);
        ctx.lineTo(w * 0.7, y);
      }
      else {
        y -= 3 * radius;
        ctx.moveTo(w * 0.5, y);
        ctx.lineTo(w * 0.5, y + h * 0.25);
        ctx.moveTo(w * 0.3, y);
        ctx.lineTo(w * 0.7, y);
      }
      ctx.stroke();
    }

    function redrawSwitches() {

      if (_("SystemFunctionsPage").style.display == "grid" && hasGPIO) {
        var sw1canvas = document.querySelector("#GPin1");
        var sw2canvas = document.querySelector("#GPin2");
        var div1 = document.getElementById("switch1");
        var div2 = document.getElementById("switch2");

        sw1canvas.width = div1.clientWidth;
        sw1canvas.height = sw1canvas.width / 2;
        sw2canvas.width = div2.clientWidth;
        sw2canvas.height = sw2canvas.width / 2;

        drawSwitch("GPin1");
        drawSwitch("GPin2");
      }
    }

    function hasGPIO() {
      var noGPIO = false;
      noGPIO |= json.GPin1 == undefined;
      noGPIO |= json.GPin2 == undefined;
      noGPIO |= json.GPmodeIn1 == undefined;
      noGPIO |= json.GPmodeIn2 == undefined;
      noGPIO |= json.GPout1 == undefined;
      noGPIO |= json.GPout2 == undefined;
      noGPIO |= json.GPmodeOut1 == undefined;
      noGPIO |= json.GPmodeOut2 == undefined;
      var noAnlg = false;
      noAnlg |= json.GPmodeAnlg == undefined;
      noAnlg |= json.GPanlg == undefined;
      if (noGPIO) {
        _("GPIOcapability").innerHTML = "Not fitted";
      }
      else {
        if (noAnlg)
          _("GPIOcapability").innerHTML = "Digital I/O only";
        else
          _("GPIOcapability").innerHTML = "Digital I/O & Analogue in";
      }
      _("GPIOGrp").style.display = hasGPIO ? "grid" : "none";
      return hasGPIO;
    }

    function showTempSensor(ID) {
      if (ID == 1) ID = "";
      var tCurrent = "Temp" + ID + "Current";
      if (typeof (json[tCurrent]) === 'string') {
        var prefix = "Temp" + ID;
        _("TempGrp" + ID).style.display = "grid";
        _(prefix).innerHTML = cOrF(json[prefix + "Current"], 1, 0) + degreeSymbol;
        var type = prefix + "Type";
        if (typeof (json[type]) === 'string') {
          _(type).innerHTML = json[type];
        }
        var offset = prefix + "Offset";
        if (typeof (json[offset]) === 'string') {
          _(offset).innerHTML = cOrF(json[offset], 1, 1) + degreeSymbol;
        }
        return 1;
      }
      return 0;
    }

    function updateEnvironmental() {

      showTempSensor(1);

      _("TempGrp2").style.display = "none";
      _("TempGrp3").style.display = "none";
      _("TempGrp4").style.display = "none";

      if (showTempSensor(2)) {
        if (showTempSensor(3)) {
          showTempSensor(4);
        }
      }

      if (json.Altitude != undefined) {
        _("BME280").style.display = "grid";
        _("BME280Heading").style.display = "grid";
        if (json.Humidity != undefined) {
          _("Humidity").innerHTML = json.Humidity + "%";
        }
        _("Altitude").innerHTML = json.Altitude + "m";
      }
      else {
        _("BME280").style.display = "none";
        _("BME280Heading").style.display = "none";
      }

    }


    function adjustOffset(ID) {
      if (protected) {
        enableProtected();
      }
      else {
        if (ID == 1) ID = "";
        var offset = "Temp" + ID + "Offset";

        function sendOffset(result) {
          var degC = invCorF(result, 1, 1);
          // console.log("adjustOffset: " + result + " -> " + degC);
          json[offset] = degC;
          sendJSON(offset, true);
        }

        openKeyboard("Adjust temperature sensor offset (" + degreeSymbol + ")",
          cOrF(-10.0, 1, 1),
          cOrF(10.0, 1, 1),
          false, 1, offset, offset, 1, 1, 1,
          sendOffset);
      }
    }

    function reqWebUpdate() {
      var idx = "LoadWebContent";
      json[idx] = "get";
      sendJSON(idx, false);
    }

    function decodeSysVer() {
      var Numeric = 0;
      if (json.SysVer == undefined)
        return Numeric;
      var sysver = json.SysVer;
      if (sysver.startsWith("V")) {
        sysver = sysver.substring(1);
        var parts = sysver.split(".");
        Numeric = Number(parts[0]);
        if (parts[1])
          Numeric += parts[1] * 0.1;
        if (parts[2])
          Numeric += parts[2] * 0.001;
        window.Numeric = Numeric;
        console.log("Version as numeric = " + Numeric);
      }
      return Numeric;
    }

  </script>

  <script>
    /***********************************************
       Included from timers.js
    ***********************************************/
    var Timers = [
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 },
      { Start: { Hr: 0, Mn: 0 }, Stop: { Hr: 0, Mn: 0 }, Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 }, Repeat: 0, Temp: 0 }
    ];

    var ABTimer = {
      Start: { Hr: 0, Mn: 0 },
      Stop: { Hr: 0, Mn: 0 },
      Days: { Mon: 0, Tue: 0, Wed: 0, Thu: 0, Fri: 0, Sat: 0, Sun: 0, Next: 0 },
      Repeat: 0,
      Temp: 0
    };

    var changedStart = false;
    var changedStop = false;
    var changedDays = false;
    var changedRepeat = false;
    var changedTemp = false;

    function splitTimer(timerstring) {
      var tmp = timerstring;
      var arr = tmp.split(" ");
      var hrmn = arr[1].split(":");
      var ret = {};
      ret.idx = parseInt(arr[0]) - 1;
      ret.hr = parseInt(hrmn[0]);
      ret.mn = parseInt(hrmn[1]);
      return ret;
    }

    function decodeStart(timerstring) {
      var tmr = splitTimer(timerstring);
      //  console.log("decode timer start " + timerstring + " -> Timers[" + tmr.idx + "].Start = " + tmr.hr + ":" + tmr.mn);
      var idx = tmr.idx;
      Timers[idx].Start.Hr = tmr.hr;
      Timers[idx].Start.Mn = tmr.mn;
    }

    function decodeStop(timerstring) {
      var tmr = splitTimer(timerstring);
      //  console.log("decode timer stop " + timerstring + " -> Timers[" + tmr.idx + "].Start = " + tmr.hr + ":" + tmr.mn);
      var idx = tmr.idx;
      Timers[idx].Stop.Hr = tmr.hr;
      Timers[idx].Stop.Mn = tmr.mn;
    }

    function decodeConflict(timerstring) {
      console.log("Timer Conflict" + timerstring);
      window.alert('Timer configuration attempt denied as it conflicts with timer #' + timerstring);
    }

    function toObject(arr) {
      var rv = {};
      for (var i = 0; i < arr.length; ++i)
        rv[arr[i]] = 1;
      return rv;
    }

    function decodeDays(timerstring) {
      var tmp = timerstring;
      var arr = tmp.split(" ");
      var idx = arr[0] - 1;
      var days = toObject(arr[1].split(","));
      //  console.log("decode timer days " + timerstring + " [" + idx +"] "+ days);

      copyDay(idx, "Sun", days);
      copyDay(idx, "Mon", days);
      copyDay(idx, "Tue", days);
      copyDay(idx, "Wed", days);
      copyDay(idx, "Thu", days);
      copyDay(idx, "Fri", days);
      copyDay(idx, "Sat", days);
      copyDay(idx, "Next", days);
    }

    function copyDay(idx, name, days) {
      Timers[idx].Days[name] = days[name] ? 1 : 0;
    }

    function decodeRepeat(timerstring) {
      var tmp = timerstring;
      var arr = tmp.split(" ");
      var idx = parseInt(arr[0]) - 1;
      var flag = parseInt(arr[1]);
      //  console.log("decode timer repeat " + timerstring + " -> Timers[" + idx + "].Repeat = " + flag);
      Timers[idx].Repeat = flag;
    }

    function decodeTemp(timerstring) {
      var tmp = timerstring;
      var arr = tmp.split(" ");
      var idx = parseInt(arr[0]) - 1;
      var temp = parseInt(arr[1]);
      //  console.log("decode timer temp " + timerstring + " -> Timers[" + idx + "].Temp = " + temp);
      Timers[idx].Temp = temp;
    }

    function dumpTimers() {
      console.log("Timers Dump");
      var i;
      for (i = 0; i < 14; i++) {
        console.log(Timers[i]);
      }
    }

    function setTimerUI() {
      console.log("SetTimerUI\r\nstart: " + startTimepicker + "\r\nstop: " + stopTimepicker);
      var selectTimer = parseInt(_("TimerSel").value);
      var i = selectTimer - 1;
      startTimepicker.setHours(Timers[i].Start.Hr);
      startTimepicker.setMinutes(Timers[i].Start.Mn);
      stopTimepicker.setHours(Timers[i].Stop.Hr);
      stopTimepicker.setMinutes(Timers[i].Stop.Mn);
      //  console.log("updated timepickers");
      _("Sun").value = Timers[i].Days.Sun;
      _("Mon").value = Timers[i].Days.Mon;
      _("Tue").value = Timers[i].Days.Tue;
      _("Wed").value = Timers[i].Days.Wed;
      _("Thu").value = Timers[i].Days.Thu;
      _("Fri").value = Timers[i].Days.Fri;
      _("Sat").value = Timers[i].Days.Sat;
      _("Next").value = Timers[i].Days.Next;
      _("Repeat").value = Timers[i].Repeat;
      _("TimerTemp").value = Timers[i].Temp;
      buttonDayState();
      repeatTimerUI();
      tempTimerUI();
      tmrStartCallback();
      tmrStopCallback();
      drawTmrChart();
    }

    function setUpdateButton() {
      var change = changedDays | changedRepeat | changedTemp | changedStart | changedStop;
      _("TimerSet").style.background = change ? buttonColorPending : buttonColorDefault;
    }

    function tempTimerUI() {
      var newTemp = Number(_("TimerTemp").value);
      setTimerTempInnerHTML(newTemp);
      changedTemp = ABTimer.Temp != newTemp;
      _("TimerTemp").style.color = changedTemp ? buttonColorPending : "black";
      _("TimerTemp").style.backgroundColor = buttonColorReceived;
      setUpdateButton();
    }

    function setTimerTempInnerHTML(newTemp) {
      var msg = cOrF(newTemp, 1, 0) + degreeSymbol;
      msg += " (" + calcPumpHz(newTemp) + "Hz)";
      _("TimerTemp").innerHTML = (newTemp == 0) ? "Cur. set " : msg;
    }

    function repeatTimerUI() {
      _("Repeat").style.backgroundColor = (_("Repeat").value == 1) ? "greenyellow" : "gold";
      _("Repeat").innerHTML = (_("Repeat").value == 1) ? "Repeat" : "Once";
      changedRepeat = _("Repeat").value != ABTimer.Repeat;
      _("Repeat").style.color = changedRepeat ? buttonColorPending : "black";
      setUpdateButton();
    }

    function onButtonRepeat() {
      _("Repeat").value = (_("Repeat").value == 0) ? 1 : 0;
      repeatTimerUI();
    }

    function onSetTimer() {
      var idx = parseInt(_("TimerSel").value) - 1;
      //  console.log("TIdx="+idx);
      Timers[idx].Start.Hr = startTimepicker.getHours();
      Timers[idx].Start.Mn = startTimepicker.getMinutes();
      Timers[idx].Stop.Hr = stopTimepicker.getHours();
      Timers[idx].Stop.Mn = stopTimepicker.getMinutes();
      Timers[idx].Repeat = _("Repeat").value;
      Timers[idx].Days.Mon = _("Mon").value;
      Timers[idx].Days.Tue = _("Tue").value;
      Timers[idx].Days.Wed = _("Wed").value;
      Timers[idx].Days.Thu = _("Thu").value;
      Timers[idx].Days.Fri = _("Fri").value;
      Timers[idx].Days.Sat = _("Sat").value;
      Timers[idx].Days.Sun = _("Sun").value;
      Timers[idx].Days.Next = _("Next").value;
      Timers[idx].Temp = _("TimerTemp").value;
      var idx1 = idx + 1;
      json.TimerStart = idx1 + " " + Timers[idx].Start.Hr + ":" + Timers[idx].Start.Mn;
      json.TimerStop = idx1 + " " + Timers[idx].Stop.Hr + ":" + Timers[idx].Stop.Mn;
      json.TimerRepeat = idx1 + " " + Timers[idx].Repeat;
      json.TimerTemp = idx1 + " " + Timers[idx].Temp;
      json.TimerDays = idx1 + " ";
      if (Timers[idx].Days.Next == 1) {
        json.TimerDays += "Next";
      }
      else {
        var comma = false;
        if (Timers[idx].Days.Sun == 1) {
          json.TimerDays += "Sun";
          comma = true;
        }
        if (Timers[idx].Days.Mon == 1) {
          if (comma == true) {
            json.TimerDays += ",";
          }
          json.TimerDays += "Mon";
          comma = true;
        }
        if (Timers[idx].Days.Tue == 1) {
          if (comma == true) {
            json.TimerDays += ",";
          }
          json.TimerDays += "Tue";
          comma = true;
        }
        if (Timers[idx].Days.Wed == 1) {
          if (comma == true) {
            json.TimerDays += ",";
          }
          json.TimerDays += "Wed";
          comma = true;
        }
        if (Timers[idx].Days.Thu == 1) {
          if (comma == true) {
            json.TimerDays += ",";
          }
          json.TimerDays += "Thu";
          comma = true;
        }
        if (Timers[idx].Days.Fri == 1) {
          if (comma == true) {
            json.TimerDays += ",";
          }
          json.TimerDays += "Fri";
          comma = true;
        }
        if (Timers[idx].Days.Sat == 1) {
          if (comma == true) {
            json.TimerDays += ",";
          }
          json.TimerDays += "Sat";
          comma = true;
        }
        if (comma == false) {     // catch if none selected!
          json.TimerDays += "None";
        }
      }
      sendJSON("TimerStart", false);
      sendJSON("TimerStop", false);
      sendJSON("TimerRepeat", false);
      sendJSON("TimerDays", false);
      sendJSON("TimerTemp", false);
      json.TimerConflict = idx1;
      sendJSON("TimerConflict", true);
    }

    function buttonDay(day) {
      if (day == "Next") {
        _("Sun").value = 0;
        _("Mon").value = 0;
        _("Tue").value = 0;
        _("Wed").value = 0;
        _("Thu").value = 0;
        _("Fri").value = 0;
        _("Sat").value = 0;
        _("Next").value = (_("Next").value == 1) ? 0 : 1;
      }
      else if (day == "None") {
        _("Sun").value = 0;
        _("Mon").value = 0;
        _("Tue").value = 0;
        _("Wed").value = 0;
        _("Thu").value = 0;
        _("Fri").value = 0;
        _("Sat").value = 0;
        _("Next").value = 0;
      }
      else {
        _("Next").value = 0;
        _(day).value = (_(day).value == 1) ? 0 : 1;
      }
      buttonDayState();
    }

    function buttonDayState() {
      changedDays = false;
      dayHighlights("Sun");
      dayHighlights("Mon");
      dayHighlights("Tue");
      dayHighlights("Wed");
      dayHighlights("Thu");
      dayHighlights("Fri");
      dayHighlights("Sat");
      dayHighlights("Next");

      setUpdateButton();
    }

    function dayHighlights(day) {
      // set button background according to selection state
      _(day).style.backgroundColor = (_(day).value == 1) ? buttonColorReceived : buttonColorDefault;
      // set button color if changed from original
      var changed = ABTimer.Days[day] != _(day).value;
      _(day).style.color = changed ? "salmon" : "black";
      changedDays |= changed;
    }

    function onTimerSel() {
      var idx = parseInt(_("TimerSel").value) - 1;
      console.log("onTimerSel - idx=" + idx);
      ABTimer.Start.Hr = Timers[idx].Start.Hr;
      ABTimer.Start.Mn = Timers[idx].Start.Mn;
      ABTimer.Stop.Hr = Timers[idx].Stop.Hr;
      ABTimer.Stop.Mn = Timers[idx].Stop.Mn;
      ABTimer.Days.Mon = Timers[idx].Days.Mon;
      ABTimer.Days.Tue = Timers[idx].Days.Tue;
      ABTimer.Days.Wed = Timers[idx].Days.Wed;
      ABTimer.Days.Thu = Timers[idx].Days.Thu;
      ABTimer.Days.Fri = Timers[idx].Days.Fri;
      ABTimer.Days.Sat = Timers[idx].Days.Sat;
      ABTimer.Days.Sun = Timers[idx].Days.Sun;
      ABTimer.Days.Next = Timers[idx].Days.Next;
      ABTimer.Repeat = Timers[idx].Repeat;
      ABTimer.Temp = Timers[idx].Temp;

      setTimerUI();
    }

    function isTimerEnabled(Days) {
      return Days.Sun != 0 || Days.Mon != 0 || Days.Tue != 0 || Days.Wed != 0 ||
        Days.Thu != 0 || Days.Fri != 0 || Days.Sat != 0 || Days.Next != 0;
    }

    function createArray(length) {
      var arr = new Array(length || 0),
        i = length;

      if (arguments.length > 1) {
        var args = Array.prototype.slice.call(arguments, 1);
        while (i--) arr[length - 1 - i] = createArray.apply(this, args);
      }

      return arr;
    }

    function Create2DArray(rows) {
      var arr = [];

      for (var i = 0; i < rows; i++) {
        arr[i] = [];
      }

      return arr;
    }

    var dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Next"];

    function drawTmrChart() {

      var canvas = _("tmrCanvas");
      var ctx = canvas.getContext("2d");
      // erase all
      ctx.fillStyle = "#000000";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      console.log("canvas:" + canvas.width + "," + canvas.height);

      var scale = {
        x: canvas.width / 580,
        y: canvas.height / 320,
      };


      var grd = ctx.createLinearGradient(50 * scale.x, 0, 530 * scale.x, 0);
      grd.addColorStop(0.15, "black");
      grd.addColorStop(0.35, "skyblue");
      grd.addColorStop(0.65, "skyblue");
      grd.addColorStop(0.85, "black");
      ctx.fillStyle = grd;
      ctx.fillRect(50 * scale.x, 0, 530 * scale.x, 280 * scale.y);

      // draw dividers
      var i;
      for (i = 1; i < 8; i++) {
        ctx.moveTo(0, 40 * i * scale.y);
        ctx.lineTo(canvas.width, 40 * i * scale.y);
      }
      ctx.strokeStyle = "#808080";
      ctx.stroke();

      // annotate days
      ctx.font = scale.y >= 1 ? "15px Arial" : "10px Arial";
      ctx.fillStyle = "#c0c0c0";
      ctx.textBaseline = "middle";
      ctx.textAlign = "center";
      ctx.fillText("Sun", 20 * scale.x, 20 * scale.y);
      ctx.fillText("Mon", 20 * scale.x, 60 * scale.y);
      ctx.fillText("Tue", 20 * scale.x, 100 * scale.y);
      ctx.fillText("Wed", 20 * scale.x, 140 * scale.y);
      ctx.fillText("Thu", 20 * scale.x, 180 * scale.y);
      ctx.fillText("Fri", 20 * scale.x, 220 * scale.y);
      ctx.fillText("Sat", 20 * scale.x, 260 * scale.y);

      // anotate hours

      ctx.strokeStyle = "#808080";
      for (i = 0; i < 25; i++) {
        var j;
        for (j = 2; j < 290 * scale.y; j += 10 * scale.y) {
          var xpos = (20 * i + 50) * scale.x;
          ctx.moveTo(xpos, j);
          ctx.lineTo(xpos, j + 5 * scale.y);
        }
      }
      ctx.stroke();

      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      for (i = 0; i < 25; i += 3) {
        var xpos = (20 * i + 50) * scale.x;
        ctx.fillText(i, xpos, 295 * scale.y);
      }

      var timermap = Create2DArray(7);

      for (i = 0; i < 7; i++) {
        for (j = 0; j < 1440; j++) {
          timermap[i][j] = 0;
        }
      }

      for (i = 0; i < 14; i++) {
        if (isTimerEnabled(Timers[i].Days)) {
          //            console.log("timer enabled: " + (i+1));
          var tmrBit = 1 << i;
          var start = Timers[i].Start.Hr * 60 + Timers[i].Start.Mn;
          var stop = Timers[i].Stop.Hr * 60 + Timers[i].Stop.Mn;
          var dayMinute;
          var dow;
          //                console.log(dayNames[dow]);
          for (dayMinute = 0; dayMinute < 1440; dayMinute++) {  // 24x60
            for (dow = 0; dow < 7; dow++) {
              if (Timers[i].Days[dayNames[dow]] != 0 || (Timers[i].Days.Next != 0)) {
                var activeday = 1 << dow;
                var recordtimer = (i + 1) | ((Timers[i].Repeat != 0) ? 0x80 : 0);
                if (Timers[i].Repeat == 0) {
                  activeday |= (activeday << 8);
                }

                if (stop >= start) {
                  if ((dayMinute >= start) && (dayMinute < stop)) {
                    //SETMAPS();
                    timermap[dow][dayMinute] = recordtimer;
                  }
                }
                else {
                  if (dayMinute >= start) {
                    //SETMAPS();
                    timermap[dow][dayMinute] = recordtimer;
                  }
                  if (dayMinute < stop) {
                    if (dow == 6) {
                      dow = 0;
                      activeday >>= 6;
                    }
                    else {
                      dow++;
                      activeday <<= 1;
                    }
                    //SETMAPS();
                    timermap[dow][dayMinute] = recordtimer;
                  }
                }

              }
            }

          }
        }
      }

      condenseMap(timermap);

      ctx = canvas.getContext("2d");

      tmrHotSpots = [];
      var hotpsotIdx = 0;

      for (dow = 0; dow < 7; dow++) {
        var ypos = dow * 40;
        var blockstart = -1;
        var interval;
        for (interval = 0; interval < 480; interval++) {
          var idCenter = 0;
          var ID = 0;
          if ((timermap[dow][interval] & 0xf) != 0) {
            ctx.beginPath();
            if (blockstart == -1) {
              blockstart = interval;
            }
            if ((timermap[dow][interval] & 0x80) == 0) {
              ctx.strokeStyle = "gold";
            }
            else {
              ctx.strokeStyle = "greenyellow";
            }
            ctx.moveTo((interval + 50) * scale.x, (ypos + 5) * scale.y);
            ctx.lineTo((interval + 50) * scale.x, (ypos + 35) * scale.y);
            ctx.stroke();
          }
          else {
            if (blockstart >= 0) {
              idCenter = (50 + (interval + blockstart) / 2) * scale.x;
              ID = timermap[dow][interval - 1];
              blockstart = -1;
            }
          }
          if ((interval == 479) && blockstart >= 0) {
            idCenter = (50 + (blockstart + 480) / 2) * scale.x;
            ID = timermap[dow][interval];
          }
          if (idCenter != 0) {

            var hotspot = {
              x: idCenter,
              y: (ypos + 20) * scale.y,
              radius: 10 * scale.y,
              timer: ID & 0x0f,
            }
            tmrHotSpots[hotpsotIdx++] = hotspot;

            ctx.beginPath();
            ctx.arc(idCenter, (ypos + 20) * scale.y, 12 * scale.y, 0, 2 * Math.PI);
            ctx.strokeStyle = "#000000";
            ctx.stroke();
            ctx.fillStyle = "#ffffff";
            ctx.fill();
            ctx.arc(idCenter, (ypos + 20) * scale.y, 12 * scale.y, 0, 2 * Math.PI);

            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.fillStyle = "#000000";
            ctx.fillText(ID & 0x0f, idCenter, (ypos + 20) * scale.y);
          }
        }
      }
      // console.log(tmrHotSpots);
    }

    function condenseMap(timerMap) {
      var dow;
      for (dow = 0; dow < 7; dow++) {
        var opIndex = 0;
        var dayMinute
        for (dayMinute = 0; dayMinute < 1440;) {
          var condense = 0;
          var subInterval;
          for (subInterval = 0; subInterval < 3; subInterval++, dayMinute++) {
            if (((condense & 0x7f) == 0) && ((timerMap[dow][dayMinute] & 0x7f) != 0)) {
              condense = timerMap[dow][dayMinute];
              //                console.log("["+dow+"]["+dayMinute+"]="+condense);
            }
          }
          timerMap[dow][opIndex++] = condense;
        }
      }
    }

    // hotspots for timer chart
    var tmrHotSpots = [];

    function isIntersect(point, hotspot) {
      return Math.sqrt((point.x - hotspot.x) ** 2 + (point.y - hotspot.y) ** 2) < hotspot.radius;
    }

    function elEvtPos(event, elID) {
      el = _(elID);
      var mousepos = {
        x: document.documentElement.scrollLeft + event.clientX - el.offsetLeft,
        y: document.documentElement.scrollTop + event.clientY - el.offsetTop
      }
      return mousepos;
    }

    function timerClick(event) {
      // canvas = _("tmrCanvas");
      var canvasPos = elEvtPos(event, "tmrCanvas");
      // {
      //   x: document.documentElement.scrollLeft + event.clientX - canvas.offsetLeft,
      //   y: document.documentElement.scrollTop + event.clientY - canvas.offsetTop
      // };     
      // console.log("document:" + document.documentElement.scrollLeft + "," + document.documentElement.scrollTop, 
      //             "event:" + event.clientX + "," + event.clientY, 
      //             "canvas:" + canvas.offsetLeft + "," + canvas.offsetTop, 
      //             "mouse:" + mousePos.x + "," + mousePos.y);
      for (var i = 0; i < tmrHotSpots.length; i++) {
        var hotspot = tmrHotSpots[i];
        if (isIntersect(canvasPos, hotspot)) {
          _("TimerSel").value = hotspot.timer;
          onTimerSel();
          break;
        }
      }
    }

    function buttonTmrTemp(dir) {

      if (dir == 0) {
        function setTimerTemp(newTemp) {
          newTemp = Number(newTemp);
          if (newTemp != 0)
            newTemp = invCorF(newTemp, 0, 0);
          console.log("New timer temp = " + newTemp);
          _("TimerTemp").value = newTemp;
          setTimerTempInnerHTML(newTemp);
          // _("TimerTemp").innerHTML = ((newTemp == 0) ? "Cur. set " : cOrF(newTemp, 1, 0)) + degreeSymbol;
          changedTemp = _("TimerTemp").value != ABTimer.Temp;
          _("TimerTemp").style.color = changedTemp ? buttonColorPending : "black";
          setUpdateButton();
        }

        // openKeyboard(Title, Min, Max, zeroOff, decimal, sendingButton, sendVariable, sendNVsave, showRange, showminus, callback) {
        openKeyboard("Timer set temperature (" + degreeSymbol + ")",
          cOrF("8.0", 1, 0),
          cOrF("35", 1, 0),
          true, 1, "TimerTempDummy", "",
          0, 1, 0, setTimerTemp);
      }
      else {
        function setColor() {
          _("TimerTemp").style.color = changedTemp ? buttonColorPending : "black";
        }

        var newTemp = Number(_("TimerTemp").value);
        var atLimit = false;
        if (newTemp == 0 && dir < 0) {
          setTimeout(setColor, 2000);
          atLimit = true;
        }
        else if (newTemp == 8 && dir < 0) {
          newTemp = 0;
        }
        else {
          newTemp += dir;
          if (newTemp < 8) newTemp = 8;
          if (newTemp > 35) {
            setTimeout(setColor, 2000);
            atLimit = true;
            newTemp = 35;
          }
        }
        _("TimerTemp").value = newTemp;
        setTimerTempInnerHTML(newTemp);
        // _("TimerTemp").innerHTML = ((newTemp == 0) ? "Cur. set " : cOrF(newTemp, 1, 0)) + degreeSymbol;
        changedTemp = _("TimerTemp").value != ABTimer.Temp;
        if (atLimit)
          _("TimerTemp").style.color = "red";
        else
          _("TimerTemp").style.color = changedTemp ? buttonColorPending : "black";
        setUpdateButton();
      }
    }

    function tmrStartCallback() {

      changedStart = false;
      changedStart |= startTimepicker.getHours() != ABTimer.Start.Hr;
      changedStart |= startTimepicker.getMinutes() != ABTimer.Start.Mn;
      startTimepicker.setTextColor(changedStart ? buttonColorPending : "black");
      setUpdateButton();
    }

    function tmrStopCallback() {
      changedStop = false;
      changedStop |= stopTimepicker.getHours() != ABTimer.Stop.Hr;
      changedStop |= stopTimepicker.getMinutes() != ABTimer.Stop.Mn;
      stopTimepicker.setTextColor(changedStop ? buttonColorPending : "black");
      setUpdateButton();
    }
  </script>

  <script>
    /***********************************************
       Included from mqtt.js
    ***********************************************/
    var viewport = document.getElementById('viewport');
    var allInputs = document.getElementsByTagName('input');

    for (var i = 0; i < allInputs.length; i++) {

      var item = allInputs[i];
      console.log('set focus event handler on', item)
      item.onfocus = function () {
        console.log("onfocus handler " + item.id);

        if (protected &&
          (
            this.id == "MEn" ||
            this.id == "MHost" ||
            this.id == "MPort" ||
            this.id == "MUser" ||
            this.id == "MPasswd" ||
            this.id == "MTopic"
          )) {
          enableProtected();
        }
        else {
          this.style.background = "yellow";
        }
      }
      item.onclick = function () {
        console.log("onclick handler");
        this.focus();
      }
      item.onkeypress = function inputentered(event) {
        // capture final ENTER and lose focus of associated element
        console.log("inputentered event: " + event.key);
        //         if (event.keyCode == 13 || event.which == 13){
        if (event.key == "Enter") {
          this.blur();
        }
      }
    };

    /*    function onFocus(ID) {
      _(ID).style.backgroundColor = "yellow";
      _(ID).scrollIntoView();
    }*/

    function onBlurComms(key) {
      console.log("Blur handler:" + key);
      _(key).style.backgroundColor = buttonColorReceived;
      var value = _(key).value;
      switch (key) {
        case "MQTTClientHost":
        case "MQTTClientPort":
        case "MQTTClientUsername":
        case "MQTTClientPassword":
        case "MQTTClientTopicPrefix":
          MQTTClient[key.substring(10)] = value;
          if (lsTest() == true) {
            localStorage[key] = value;
            _(key).style.backgroundColor = buttonColorReceived;
          }
          else {
            _(key).style.backgroundColor = buttonColorDefault;
          }
          MQTTreconnect();
          break;
        case "WebServerPort":
        case "WebServerIP":
          window[key] = value;
          if (lsTest() == true) {
            localStorage[key] = value;
            _(key).style.backgroundColor = buttonColorReceived;  // stored make green
          }
          else {
            _(key).style.backgroundColor = buttonColorDefault;  // not stored, leave as grey
          }
          console.log("WebServerIP=" + WebServerIP + ":" + WebServerPort);
          initComms();
          break;
        case "MHost":
        case "MPort":
        case "MUser":
        case "MPasswd":
        case "MTopic":
          if (!protected) {
            console.log("json[key]=" + json[key] + " value=" + value);
            if (json[key] != value) {
              _(key).style.backgroundColor = buttonColorSent;
              json[key] = value;
              sendJSON(key, true);
            }
            else {  // catch no change events
              _(key).style.backgroundColor = buttonColorReceived;
            }
          }
          break;
      }
    }

    function onMQTTConnect() {
      // Once a connection has been made, make a subscription and send a message.

      MQTTClient.Connected = true;
      if (window.socketTimer) { // prevent normal websocket recycling
        window.clearInterval(window.socketTimer);
        window.socketTimer = 0;
      }

      var conInfo = "MQTT Connected to " + MQTTClient.Host;
      console.log(conInfo);
      _('divThermostatText').style.backgroundColor = "rgb(96,255,96)"; //Light Green
      _('dataText').innerHTML = conInfo + ", subscribing...";
      _('WarningAuth').style.display = 'none';

      //      divsShow(); //Show all the front page divs

      var subJSONout = MQTTClient.TopicPrefix + "/JSONout";
      MQTTClient.Instance.subscribe(subJSONout);
      var substatus = MQTTClient.TopicPrefix + "/status";
      MQTTClient.Instance.subscribe(substatus);
      refreshJSON();
      dispMenu("HomePage");
    }

    function onMQTTFailure(message) {
      var conInfo = "MQTT Connection Attempt to Host " + MQTTClient.Host + " Failed";
      // console.log(conInfo);
      console.log(message);
      switch (message.errorCode) {
        case 1:
          _('WarningAuth').innerHTML = "Connection timeout";
          _('WarningAuth').style.display = 'block';
          break;
        case 2:
          _('WarningAuth').innerHTML = "Subscribe timeout";
          _('WarningAuth').style.display = 'block';
          break;
        case 4:
          _('WarningAuth').innerHTML = "Ping timeout";
          _('WarningAuth').style.display = 'block';
          break;
        case 5:
        case 7:
        case 8:
        case 10:
          _('WarningAuth').innerHTML = message.errorMessage;
          _('WarningAuth').style.display = 'block';
          break;
        case 6:
          var result = message.errorMessage.split("code:");
          var msg = result[1].substr(2);
          _('WarningAuth').innerHTML = msg;
          _('WarningAuth').style.display = 'block';
          break;
      }
      _('divThermostatText').style.backgroundColor = "rgb(255,128,128)"; //Light Red
      _('dataText').innerHTML = conInfo;
      setTimeout(MQTTConnect, MQTTClient.ReconnectTimeout);
      MQTTClient.Connected = false;

    }

    function onMQTTConnectionLost(message) {
      var conInfo = "MQTT Connection lost to Host " + MQTTClient.Host;
      console.log(conInfo);
      console.log(message);
      _('divThermostatText').style.backgroundColor = "rgb(255,128,128)"; //Light Red
      _('dataText').innerHTML = conInfo;
      setTimeout(MQTTConnect, MQTTClient.ReconnectTimeout);
      MQTTClient.Connected = false;

    }

    function onMQTTMessageArrived(msg) {
      console.log("Rx'd Topic " + msg.destinationName + msg.payloadString);
      var subJSONout = MQTTClient.TopicPrefix + "/JSONout";
      if (msg.destinationName == subJSONout) {
        decodeJSON('MQTT', msg.payloadString);
      }
      var substatus = MQTTClient.TopicPrefix + "/status";
      if (msg.destinationName == substatus) {
        if (msg.payloadString == "online") {
          _('divThermostatText').style.backgroundColor = "rgb(128,128,255)"; //Light Blue
        }
        else {
          _('dataText').innerHTML = "Challenger offline";
          _('divThermostatText').style.backgroundColor = "rgb(255,128,128)"; //Light Red
        }
      }
    }

    function random_string(size) {
      var str = "";
      for (var i = 0; i < size; i++) {
        str += random_character();
      }
      return str;
    }

    function random_character() {
      var chars = "0123456789abcdefghijklmnopqurstuvwxyzABCDEFGHIJKLMNOPQURSTUVWXYZ";
      return chars.substr(Math.floor(Math.random() * 62), 1);
    }

    function MQTTConnect() {
      console.log("MQTTConnect");
      if (MQTTClient.Enabled != 0 && MQTTClient.Connected == 0) {
        var port = parseInt(MQTTClient.Port);
        var conInfo = "Connecting to mqttws://" + MQTTClient.Host + ":" + MQTTClient.Port + "...";
        console.log(conInfo);
        _('topBarClientText').innerHTML = "Challenger MQTT";
        _('topBarText').innerHTML = "";
        _('topBarText2').innerHTML = "";
        _('divThermostatText').style.backgroundColor = "rgb(255,128,128)"; //Light Red
        _('dataText').innerHTML = conInfo;
        if (MQTTClient.Instance) {
          delete MQTTClient.Instance;
        }
        var randomClientID = random_string(12);
        console.log("ClientID = " + randomClientID);
        MQTTClient.Instance = new Paho.MQTT.Client(MQTTClient.Host, port, randomClientID);
        var options = {
          timeout: 3,
          onSuccess: onMQTTConnect,
          onFailure: onMQTTFailure,
        };
        if (MQTTClient.Username != "") {
          options["userName"] = MQTTClient.Username;
          options["password"] = MQTTClient.Password;
        }
        MQTTClient.Instance.onMessageArrived = onMQTTMessageArrived;
        MQTTClient.Instance.onConnectionLost = onMQTTConnectionLost;
        MQTTClient.Instance.connect(options); //connect
      }
    }

    function MQTTsend(msg) {
      if (MQTTClient.Connected) {
        console.log("MQTT sending " + msg);
        var pubTopic = MQTTClient.TopicPrefix + "/JSONin";
        MQTTClient.Instance.send(pubTopic, msg, 0, false);
      }
      else {
        console.log("MQTT no connection - send skipped?");
      }
    }

    function MQTTreconnect() {
      if (MQTTClient.Instance)
        MQTTClient.Instance.disconnect();   // force reconnect via disconnect event handler
      else
        MQTTConnect();
    }

  </script>


</body>

</html>